# 本地版「有行体验」记账系统开发计划（Draft v0.1）

> 状态：M2 / M3 已完成，M4 规划调整中（预算/消费主线），M5 持续打磨中（本文件用于迭代修订）
>  
> 核心目标：做一款**本地优先、数据绝对可控**的个人资产与记账软件，兼顾舒适体验与账单核对精度。

## 1. 产品愿景

打造一个“本地版、有安全感、每天愿意打开”的记账与资产管理工具：

- 本地优先：个人财务数据默认仅保存在本机。
- 体验优先：借鉴《有行》的轻负担交互和审美，降低记账摩擦。
- 核对优先：结合信用卡账单自动导入与对账，提升准确性。
- 可扩展：从支出记账逐步扩展到资产、投资收益、预算与复盘。

## 2. 产品原则

- `Local First`：核心功能离线可用。
- `Privacy by Default`：默认隐藏敏感金额，导出前可脱敏。
- `Single Source of Truth`：导入账单 + 手工修正形成统一账本。
- `Automation with Confirmation`：自动分类可回溯，可人工确认。
- `Calm UX`：界面克制，关键操作少步骤、低认知负担。

## 3. 当前进度（已完成）

当前仓库已完成“支出盘点底座”：

- EML 账单解析、交易提取、分类规则、排除规则。
- 交互式 HTML 报告（筛选、排序、趋势、隐私开关）。
- 目录规范：`input / rules / output / work`。
- 一键执行：`./run_report.sh`。

这部分作为后续记账模块的数据输入与核对基础。

## 4. 最终形态（目标能力）

### 4.1 投资记录维护（已实现）

- 投资记录手工单条更新（按账户、按日期）。
- 有知有行导出记录批量导入（CSV / XLSX）。
- 记录口径固定为：`snapshot_date`、`total_assets`、`transfer_amount`。

### 4.2 投资收益计算（核心）

- 基于投资记录按账户计算区间收益率。
- 支持常用区间：年度（YTD）、近一年、近三年、成立以来、自定义区间。
- 收益口径采用现金加权（Modified Dietz）。

### 4.3 财富总览（核心）

- 按账户类型展示三类资产：投资账户、现金账户、不动产账户。
- 展示每类资产汇总与总财富。
- 支持时间点查看（最新值 + 指定日期）。

### 4.4 增长曲线可视化（核心）

- 投资账户总资产随时间曲线。
- 财富总览（总财富 / 各资产类型）随时间曲线。
- 支持区间切换与基础对比（起点、终点、涨跌额）。

### 4.5 暂缓项（后置）

- 交易总账深度编辑、预算、对账、AI 建议、云同步。

## 5. 里程碑规划

## M0：导入与投资记录最小可用（当前执行范围）

范围（仅此四项）：

- EML 的交互式导入。
- 投资记录的交互式单条录入。
- 从有知有行导出的投资记录表批量导入。
- 支撑以上能力的数据结构调整、基础查询与展示。

输出物：

- 导入中心（支持 `cmb_eml` 与 `youzhiyouxing_export` 两类来源）。
- 投资记录页（单条录入 + 列表查看）。
- 基础查询页（交易/投资记录筛选、列表、简单汇总）。
- 数据字典与迁移清单（仅覆盖 M0 所需字段与索引）。

验收标准：

- 可在 UI 内完成 EML 导入：选择 -> 预览 -> 确认 -> 入库。
- 可在 UI 内完成投资记录单条录入，并立即查询到结果。
- 可批量导入有知有行导出表，并可按任务追溯结果。
- 基础查询可按来源、账户、时间进行检索与展示。

不做清单（M0）：

- 预算模块。
- 对账模块。
- AI 建议。
- 云同步与多端能力。
- 复杂分析报表。

## M1：投资收益计算 MVP（当前主线，1-2 周）

范围：

- 保持投资记录手工录入与批量导入链路稳定可用。
- 实现按账户的区间收益率计算（现金加权 / Modified Dietz）。
- 提供区间选择：`ytd`、`1y`、`3y`、`since_inception`、`custom`。
- 输出结果包含：期初资产、期末资产、净入金、收益额、收益率。

验收标准：

- 可对任一投资账户计算指定区间收益率。
- 同一数据输入下，计算结果稳定可复算。
- 数据不足时给出明确提示（如区间内无有效快照）。

## M2：财富总览 MVP（已完成）

范围：

- 增加/完善账户类型：`investment`、`cash`、`real_estate`。
- 支持现金账户与不动产账户的价值录入（按日期快照）。
- 聚合展示三类资产与总财富。
- 支持财富总览按 `as_of` 查看历史值，并显示明细可追溯结果。
- 支持对账校验（明细合计与汇总一致性）与滞后账户提示。
- 支持投资记录 / 现金与不动产记录的修改、删除（用于纠错与验证）。

验收标准：

- 首页可查看三类资产及总财富汇总。
- 可按日期查看历史总览。
- 汇总值与账户明细可对账（可追溯到具体账户快照）。

## M3：增长曲线可视化（1-2 周，已完成）

范围：

- 投资账户资产曲线（按账户 / 全部投资）。
- 财富总览曲线（总财富、投资/现金/不动产分项）。
- 区间切换与关键点指标（起点、终点、涨跌额、涨跌幅）。

验收标准：

- 曲线与明细数据一致。
- 区间切换响应稳定，口径一致。

完成说明（当前实现）：

- 投资收益曲线支持账户/组合视角与区间切换（年度、近一年等），并提供关键点指标。
- 财富趋势图支持投资/现金/不动产/负债筛选、成立以来/近一年/YTD 预设切换。
- 财富关系图（Sankey）用于展示分类构成与总资产/净资产/负债关系。
- 已通过回归脚本覆盖曲线端点一致性与财富曲线预设切换稳定性。

## M4：预算与消费深化（核心扩展，规划调整中）

目标：

- 在“投资记账 + 财富总览”核心能力稳定基础上，补齐 `年度预算` 与 `消费复盘` 主线。
- 建立“预算 -> 实际消费 -> 可投资资产 -> 财务自由度”的闭环，让用户可以持续追踪财务自由进度。

范围（建议按阶段推进）：

### M4.1 平均月度支出预算设置（极简）

- 用户只需编辑少量 `平均月度支出预算项`（如：房贷、日常开销、缴费）。
- 系统自动汇总：
  - `月度预算总额 = 各预算项月度金额之和`
  - `年度预算 = 月度预算总额 × 12`
- 支持预算项增删改（保持轻量，建议首版控制在少量条目）。
- 支持预算口径说明展示（是否包含待确认消费、是否包含排除项）。

建议首版收敛：

- 不做“按消费分类精细预算”与分类预算合计校验。
- 不做月度预算逐月录入、结转（rollover）、版本历史。
- 优先保证“录入 3-5 个月度预算项即可得到年度预算”。

### M4.2 实际消费与预算对比（低心智负担）

- 提供预算总览页（以总额为主）：
  - 年度预算（由月度预算自动计算）
  - 实际消费累计（按当前统计口径）
  - 剩余预算
  - 达成率 / 使用率（实际消费 ÷ 年度预算）
- 提供 `YTD` 预算进度参考（可选简化展示）：
  - `YTD 预算 = 月度预算总额 × 当年已过月数（按月份整数）`
  - `YTD 实际消费 vs YTD 预算`（仅显示总额差值与比率）
- 不要求首版提供分类对比表与复杂排序交互。

### M4.3 预算复盘（轻量解释）

- 提供按月份的总额复盘（例如：2026-03 实际消费 vs 当月预算）。
- 提供“预算偏离提醒”（超预算/低于预算）。
- 保留到交易明细页的入口（用于查看大额异常开销），但不做复杂分类复盘 UI。
- 与现有消费分类规则页保持联动，便于修正明显分类错误。

### M4.4 财务自由度（项目核心指标）

- 基于 `年度预算` 与 `可投资资产` 计算财务自由度指标。
- 已确认首版 `可投资资产口径 = 投资 + 现金`（不扣减负债）。
- 已确认首版同时给出两种指标（便于解释）：
  - `资产覆盖年数 = 可投资资产 / 年度预算`
  - `财务自由度(%) = (可投资资产 × 提取率) / 年度预算`
- 已确认首版默认提取率为 `4%`（用户可后续调整）。
- 展示配套指标：
  - 达到财务自由所需资产（按提取率反推）
  - 当前差额（还差多少）
  - 财务自由度趋势（基于财富曲线 + 当前预算或年度预算快照）

建议首版收敛：

- 先做“当前口径下的财务自由度”和趋势，不做复杂预测（如退休时间预测、蒙特卡洛）。
- 默认提取率可配置（建议默认 `4%`），并在 UI 明示公式。

### M4.5 数据与交互支撑（为预算主线服务）

- 消费分类管理继续增强（分类修正效率、规则回填效率），但不要求首版预算页依赖复杂分类预算映射。
- 交易查询页支持预算相关筛选字段（预算年度、是否纳入预算统计）即可，分类筛选作为次优先。
- 保持隐私模式在预算/自由度页面可用（便于截图讨论）。
- 首版内置预算项模板（如：房贷、日常开销、缴费），并允许用户自定义增删。

非目标（M4 暂不做）：

- AI 建议与自动化能力（后置）。
- 账单导入任务中心重构（后置）。
- 云同步 / 多端协同（后置）。

验收标准：

- 用户可在页面完成 `平均月度支出预算项` 的录入/编辑，系统自动计算年度预算。
- 用户可查看 `实际消费总额 vs 年度预算` 的达成率（含剩余预算）。
- 财务自由度指标可复算、公式可解释、口径可见（资产口径/预算口径/提取率）。
- 修改预算项或新增消费数据后，预算对比与财务自由度展示可稳定更新。

已确认口径（本次会话）：

1. 预算采用“平均月度支出预算项”模式，系统自动折算年度预算。
2. 实际消费对比首版以“总额达成率”展示为主，不做复杂分类预算对比。
3. `可投资资产 = 投资 + 现金`（首版财务自由度口径，不扣减负债）。
4. 财务自由度主指标同时展示 `覆盖年数` + `自由度(%)`。
5. `YTD` 预算进度按已过月份整数计算（非按自然日比例）。
6. 实际消费口径默认沿用当前分析口径（排除 `needs_review`、排除 `excluded_in_analysis`）。
7. 首版内置预算项模板（如房贷/日常开销/缴费），并允许自定义增删。

## M5：体验与安全强化（持续）

范围：

- 交互细节打磨（快捷键、批量操作、空状态引导）。
- 数据备份/恢复（本地加密包）。
- 隐私与权限审计（导出脱敏、本地锁）。

验收标准：

- 新用户 10 分钟内可跑通“录入投资记录→看收益率→看财富总览→看曲线”。
- 本地备份恢复可成功还原。

## 6. 技术方案（建议）

> 已确认方向（本次会话结论）

- 运行形态：当前以 `Python 本地 Web + SQLite` 快速迭代，浏览器访问（`127.0.0.1`）。
- 演进方向：核心能力稳定后再评估 `Go 单二进制` 打包。
- UI 路线：`轻前端`（优先原生/轻框架，避免重型前端栈）。
- 数据层：`SQLite`（后续可加密，如 `SQLCipher`）。
- 打包目标：先保证本地可用与口径稳定，再做交付形态优化。

技术取舍说明：

- `Electron` 体积与运行时负担偏大，不作为当前方案。
- `Tauri` / `Go` 可作为未来封装层，但当前阶段不优先。
- 当前阶段优先“收益口径正确、页面可用、可持续迭代”。

建议优先级：

1. 先完成投资收益率引擎（现金加权）与区间查询 API。
2. 再完成财富总览聚合（投资/现金/不动产）与时间序列数据接口。
3. 再完成曲线可视化页面与交互（区间切换、账户筛选、指标卡）。
4. 最后做性能与交互优化。

## 7. 数据模型草案（核心实体）

- `accounts`：账户主数据（`investment/cash/real_estate`）。
- `investment_records`：投资账户日级记录（`snapshot_date/total_assets_cents/transfer_amount_cents`）。
- `assets`：非投资类账户价值快照（现金、不动产）。
- `import_jobs`：导入任务追溯（保留现有）。

### 7.0 投资记录口径约束（已确认）

- 投资记录只保留三项核心字段：日期、总资产、转入转出净额。
- 现金加权收益率使用 Modified Dietz：
  - `R = (V_end - V_begin - ΣCF_i) / (V_begin + Σ(w_i * CF_i))`
  - `w_i = (T_end - t_i) / (T_end - T_begin)`
  - `CF_i > 0` 表示净转入，`CF_i < 0` 表示净转出。
- 当分母小于等于 0 或区间内无有效首尾快照时，不返回收益率，改为“数据不足”。

## 8. 非功能需求

- 性能：单用户本地场景下，账户收益与总览查询应秒级返回。
- 稳定性：导入异常不影响现有账本。
- 安全性：默认不上传，敏感信息可一键隐藏。
- 可维护性：收益率计算模块、聚合模块、展示模块可独立演进。
- 可分析性：收益口径可复算、可解释、可追溯到账户与日期。

## 9. 风险与应对

- 风险：账户快照缺失导致收益率不稳定。
  - 应对：区间数据完整性检查 + 数据不足提示。
- 风险：转入转出符号或日期错误导致收益率失真。
  - 应对：导入校验 + 示例校验集 + 结果解释面板（显示期初/期末/净入金）。
- 风险：不动产估值更新频率低导致曲线跳变。
  - 应对：分账户展示更新时间，并允许按账户隐藏曲线。
- 风险：导入格式变化导致解析失败。
  - 应对：导入任务日志 + 失败样本回放机制。
- 风险：功能增长过快导致体验变重。
  - 应对：M4 聚焦“预算/消费/财务自由度”主线，不并行扩展 AI/云同步/任务中心重构。

## 10. 下次会话建议起步任务（M4）

1. 定义预算数据模型（平均月度支出预算项、自动折算年度预算、预算统计口径字段）。
2. 实现预算设置 API 与页面（月度预算项录入/编辑，内置预算项模板）。
3. 实现“实际消费 vs 预算”聚合接口（总额达成率、剩余预算、YTD 对比；沿用当前分析口径）。
4. 实现财务自由度聚合接口（默认提取率 `4%`，输出覆盖年数与自由度百分比）。
5. 在前端新增预算总览页面，并接入现有消费分类规则管理入口。
6. 增加预算/财务自由度回归校验样本，固定可复算结果。

## 11. 版本记录

- `v0.1`：根据当前“支出盘点已完成”的基础，形成产品与研发里程碑初稿。
- `v0.2`：确认技术路线为 `Go 单二进制 + 本地 Web + 轻前端`，并确定解析引擎迁移到 Go 但延期执行。
- `v0.3`：新增“Generative AI 决策建议”为最终阶段目标，并补充前置数据设计约束。
- `v0.4`：路线收敛为“投资记录维护 + 现金加权收益率 + 财富总览 + 增长曲线”，其余能力后置。
