<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>消费分析（账本）</title>
  <link rel="stylesheet" href="/assets/consumption_report.css">
</head>
<body>
  <main class="shell">
    <section class="hero card">
      <div>
        <span class="badge">消费分析引擎 · 账本实时视图</span>
        <h1>消费分析报告</h1>
        <div class="muted" id="heroSubtitle">正在加载报告数据...</div>
      </div>
      <div class="hero-right">
        <button id="privacyToggle" class="privacy-toggle" type="button" aria-pressed="false" title="点击隐藏金额">
          <svg class="eye-icon icon-on" viewBox="0 0 24 24"><path d="M2 12s3.7-6 10-6 10 6 10 6-3.7 6-10 6-10-6-10-6z"/><circle cx="12" cy="12" r="3.2"/></svg>
          <svg class="eye-icon icon-off" viewBox="0 0 24 24"><path d="M2 12s3.7-6 10-6c2.2 0 4.1.7 5.7 1.6M22 12s-3.7 6-10 6c-2.2 0-4.1-.7-5.7-1.6"/><path d="M3 3l18 18"/></svg>
          <span id="privacyToggleLabel">隐藏金额</span>
        </button>
        <div class="links">
          <a class="link" href="/" rel="noopener">主工作台</a>
          <a class="link" href="/rules" rel="noopener">交易规则管理</a>
          <a class="link" href="/consumption" rel="noopener">刷新本页</a>
        </div>
      </div>
    </section>

    <section class="controls card">
      <div class="control">
        <label for="yearSelect">统计年份</label>
        <select id="yearSelect"></select>
      </div>
      <div class="control">
        <label for="monthSelect">账单月份</label>
        <select id="monthSelect"></select>
      </div>
      <div class="control">
        <label for="keywordInput">关键词（商户/摘要）</label>
        <input id="keywordInput" type="text" placeholder="例如：肯德基 / 盒马 / 停车">
      </div>
      <label class="control toggle">
        <input id="includePending" type="checkbox">
        显示待确认交易
      </label>
    </section>

    <section class="panel card">
      <h2>已选筛选</h2>
      <div id="filterPills" class="filter-pills"></div>
    </section>

    <section class="panel card">
      <div class="section-head">
        <h2>消费分类（可点击筛选）</h2>
        <div class="filter-actions">
          <button id="categorySelectAll" class="mini-btn" type="button">全选</button>
          <button id="categoryClear" class="mini-btn" type="button">清空</button>
        </div>
      </div>
      <div id="categoryCloud" class="merchant-cloud"></div>
    </section>

    <section class="metrics">
      <article class="metric card">
        <div class="metric-head">
          <svg viewBox="0 0 24 24"><path d="M3 12h18M3 7h18M3 17h18"/></svg>
          筛选后支出
        </div>
        <div id="metricTotal" class="metric-value">¥0.00</div>
        <div class="metric-sub" id="metricTotalSub">0 笔交易</div>
      </article>
      <article class="metric card">
        <div class="metric-head">
          <svg viewBox="0 0 24 24"><path d="M4 19h16M7 15l3-3 3 2 4-5"/></svg>
          单笔均额
        </div>
        <div id="metricAvg" class="metric-value">¥0.00</div>
        <div class="metric-sub">筛选范围内平均值</div>
      </article>
      <article class="metric card">
        <div class="metric-head">
          <svg viewBox="0 0 24 24"><path d="M12 3l8 4v5c0 5-3.4 8-8 9-4.6-1-8-4-8-9V7z"/></svg>
          待确认交易
        </div>
        <div id="metricReview" class="metric-value">0</div>
        <div class="metric-sub" id="metricReviewSub">0.00%</div>
      </article>
      <article class="metric card">
        <div class="metric-head">
          <svg viewBox="0 0 24 24"><path d="M5 5h14v14H5zM9 9h6v6H9z"/></svg>
          覆盖账单
        </div>
        <div id="metricFiles" class="metric-value">0</div>
        <div class="metric-sub" id="metricFilesSub">解析失败 0</div>
      </article>
    </section>

    <section class="grid-two">
      <article class="panel card">
        <h2>月度支出趋势</h2>
        <svg id="trendChart" viewBox="0 0 820 260" preserveAspectRatio="none"></svg>
      </article>
      <article class="panel card">
        <h2>分类占比结构</h2>
        <div class="donut-wrap">
          <div id="donut" class="donut"></div>
          <div id="donutLegend" class="legend"></div>
        </div>
      </article>
    </section>

    <section class="panel card">
      <h2>分类金额排行 <span class="muted" id="resultHint"></span></h2>
      <div id="categoryBars" class="bars"></div>
    </section>

    <section class="panel card">
      <h2>高频商户（可点击筛选）</h2>
      <div id="merchantCloud" class="merchant-cloud"></div>
    </section>

    <section class="panel card">
      <h2>交易明细（点击列头可正序/倒序）</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th><button class="th-sort" data-sort="date">日期 <span class="arrow"></span></button></th>
              <th><button class="th-sort" data-sort="category">分类 <span class="arrow"></span></button></th>
              <th><button class="th-sort" data-sort="merchant">商户 <span class="arrow"></span></button></th>
              <th><button class="th-sort" data-sort="description">摘要 <span class="arrow"></span></button></th>
              <th><button class="th-sort" data-sort="source_path">来源 <span class="arrow"></span></button></th>
              <th><button class="th-sort" data-sort="confidence">置信度 <span class="arrow"></span></button></th>
              <th class="num"><button class="th-sort" data-sort="amount">金额 <span class="arrow"></span></button></th>
            </tr>
          </thead>
          <tbody id="txnBody"></tbody>
        </table>
      </div>
      <div class="foot">
        <span id="footInfo">数据加载中</span>
        <span id="footTime">生成时间：-</span>
      </div>
    </section>
  </main>

  <script>
    let REPORT_DATA = null;
    const COLORS = ["#2f8f63","#4aa87c","#77b77b","#9ec36f","#d1a758","#cf8752","#7f9a70","#87a8b4","#7c8dc7","#ab8dbb","#c27f91","#8f9a9a"];
    const PRIVACY_MASK_STORAGE_KEY = "keepwise:privacy-mask-amounts";
    const state = {
      year: "",
      month: "ALL",
      selectedCategories: new Set(),
      selectedMerchants: new Set(),
      keyword: "",
      includePending: false,
      hideAmounts: false,
      sortField: "date",
      sortDir: "desc",
    };

    const yearSelect = document.getElementById("yearSelect");
    const monthSelect = document.getElementById("monthSelect");
    const keywordInput = document.getElementById("keywordInput");
    const includePending = document.getElementById("includePending");
    const filterPills = document.getElementById("filterPills");
    const categoryCloud = document.getElementById("categoryCloud");
    const categorySelectAll = document.getElementById("categorySelectAll");
    const categoryClear = document.getElementById("categoryClear");
    const privacyToggle = document.getElementById("privacyToggle");
    const privacyToggleLabel = document.getElementById("privacyToggleLabel");

    function fmtMoney(value) {
      if (state.hideAmounts) return "***";
      return new Intl.NumberFormat("zh-CN", { style: "currency", currency: "CNY", maximumFractionDigits: 2 }).format(value || 0);
    }
    function fmtMoneyCompact(value) {
      if (state.hideAmounts) return "***";
      const abs = Math.abs(value || 0);
      if (abs >= 100000000) return `¥${(value / 100000000).toFixed(2)}亿`;
      if (abs >= 10000) return `¥${(value / 10000).toFixed(1)}万`;
      return `¥${Math.round(value).toLocaleString("zh-CN")}`;
    }
    function fmtPercent(value) {
      return `${(value * 100).toFixed(2)}%`;
    }
    function text(el, value) {
      const node = document.getElementById(el);
      if (node) node.textContent = value;
    }

    function getAvailableYears() {
      const years = new Set();
      (REPORT_DATA.months || []).forEach((x) => {
        const m = String(x.month || "");
        if (m.length >= 4) years.add(m.slice(0, 4));
      });
      if (years.size === 0) {
        (REPORT_DATA.transactions || []).forEach((x) => {
          const m = String(x.month || "");
          if (m.length >= 4) years.add(m.slice(0, 4));
        });
      }
      return Array.from(years).sort((a, b) => b.localeCompare(a, "zh-CN", { numeric: true }));
    }

    function refreshMonthSelector() {
      const year = state.year || "";
      const monthRows = (REPORT_DATA.months || []).filter((x) => String(x.month || "").startsWith(`${year}-`));
      const monthOptions = [{ value: "ALL", label: `${year} 全年` }].concat(
        monthRows.map((x) => ({ value: x.month, label: x.month }))
      );
      if (!monthOptions.some((x) => x.value === state.month)) state.month = "ALL";
      monthSelect.innerHTML = monthOptions.map((x) => `<option value="${x.value}">${x.label}</option>`).join("");
      monthSelect.value = state.month;
    }

    function initSelectors() {
      const years = getAvailableYears();
      if (!state.year || !years.includes(state.year)) {
        state.year = years[0] || String(new Date().getFullYear());
      }
      yearSelect.innerHTML = years.map((y) => `<option value="${y}">${y}</option>`).join("");
      yearSelect.value = state.year;
      refreshMonthSelector();
    }

    function toggleSetValue(setObj, value) {
      if (!value) return;
      if (setObj.has(value)) setObj.delete(value);
      else setObj.add(value);
    }

    function getFilteredRows(ignoreMerchant = false) {
      const keyword = state.keyword.trim().toLowerCase();
      return REPORT_DATA.transactions.filter((row) => {
        if (state.year && !String(row.month || "").startsWith(`${state.year}-`)) return false;
        if (state.month !== "ALL" && row.month !== state.month) return false;
        if (state.selectedCategories.size > 0 && !state.selectedCategories.has(row.category)) return false;
        if (!ignoreMerchant && state.selectedMerchants.size > 0 && !state.selectedMerchants.has(row.merchant)) return false;
        if (!state.includePending && row.needs_review) return false;
        if (!keyword) return true;
        const haystack = `${row.merchant} ${row.description}`.toLowerCase();
        return haystack.includes(keyword);
      });
    }

    function aggregateByCategory(rows) {
      const m = new Map();
      for (const row of rows) {
        if (!m.has(row.category)) m.set(row.category, { category: row.category, amount: 0, count: 0, review: 0 });
        const item = m.get(row.category);
        item.amount += row.amount;
        item.count += 1;
        item.review += row.needs_review ? 1 : 0;
      }
      return Array.from(m.values()).sort((a, b) => b.amount - a.amount);
    }

    function aggregateByMonth(rows) {
      const base = new Map(
        REPORT_DATA.months
          .filter((m) => !state.year || String(m.month || "").startsWith(`${state.year}-`))
          .map((m) => [m.month, { month: m.month, amount: 0, count: 0 }])
      );
      for (const row of rows) {
        if (!base.has(row.month)) base.set(row.month, { month: row.month, amount: 0, count: 0 });
        const item = base.get(row.month);
        item.amount += row.amount;
        item.count += 1;
      }
      return Array.from(base.values()).sort((a, b) => a.month.localeCompare(b.month));
    }

    function aggregateByMerchant(rows) {
      const m = new Map();
      for (const row of rows) {
        if (!m.has(row.merchant)) m.set(row.merchant, { merchant: row.merchant, amount: 0, count: 0, category: row.category });
        const item = m.get(row.merchant);
        item.amount += row.amount;
        item.count += 1;
      }
      return Array.from(m.values()).sort((a, b) => b.amount - a.amount);
    }

    function getSortValue(row, field) {
      if (field === "amount") return row.amount || 0;
      if (field === "confidence") return row.confidence || 0;
      if (field === "date") return row.date || "";
      if (field === "category") return row.category || "";
      if (field === "merchant") return row.merchant || "";
      if (field === "description") return row.description || "";
      if (field === "source_path") return row.source_path || "";
      return row.date || "";
    }

    function sortRows(rows) {
      const dir = state.sortDir === "asc" ? 1 : -1;
      const field = state.sortField;
      const sorted = [...rows].sort((a, b) => {
        const av = getSortValue(a, field);
        const bv = getSortValue(b, field);
        if (typeof av === "number" && typeof bv === "number") {
          if (av !== bv) return (av - bv) * dir;
        } else {
          const cmp = String(av).localeCompare(String(bv), "zh-CN", { numeric: true, sensitivity: "base" });
          if (cmp !== 0) return cmp * dir;
        }
        const dateCmp = String(b.date || "").localeCompare(String(a.date || ""));
        if (dateCmp !== 0) return dateCmp;
        return (b.amount || 0) - (a.amount || 0);
      });
      return sorted;
    }

    function updateSortHeaders() {
      document.querySelectorAll(".th-sort").forEach((btn) => {
        const field = btn.getAttribute("data-sort");
        const arrow = btn.querySelector(".arrow");
        const active = field === state.sortField;
        btn.classList.toggle("active", active);
        if (!arrow) return;
        arrow.textContent = active ? (state.sortDir === "asc" ? "▲" : "▼") : "↕";
      });
    }

    function renderMetrics(rows) {
      const total = rows.reduce((s, x) => s + x.amount, 0);
      const count = rows.length;
      const avg = count ? total / count : 0;
      const review = rows.filter((x) => x.needs_review).length;
      const fileCount = new Set(rows.map((x) => String(x.source_path || ""))).size;

      text("metricTotal", fmtMoney(total));
      text("metricTotalSub", `${count.toLocaleString()} 笔交易`);
      text("metricAvg", fmtMoney(avg));
      text("metricReview", review.toLocaleString());
      text("metricReviewSub", count ? fmtPercent(review / count) : "0.00%");
      text("metricFiles", fileCount.toLocaleString());
      text("metricFilesSub", `解析失败 ${REPORT_DATA.failed_files_count}（全库导入任务）`);
    }

    function renderTrendChart(rows) {
      const svg = document.getElementById("trendChart");
      const data = aggregateByMonth(rows);
      const points = data.filter((x) => x.count > 0);
      if (!points.length) {
        svg.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="#6f7773" font-size="14">当前筛选无趋势数据</text>`;
        return;
      }
      const w = 820, h = 260, px = 38, py = 34;
      const max = Math.max(...points.map((p) => p.amount), 1);
      const spanX = w - px * 2;
      const spanY = h - py * 2;
      const x = (i) => px + (points.length === 1 ? spanX / 2 : (i * spanX) / (points.length - 1));
      const y = (v) => py + spanY - (v / max) * spanY;

      const grid = [0, 0.25, 0.5, 0.75, 1].map((r) => {
        const gy = y(max * r);
        return `<line x1="${px}" y1="${gy}" x2="${w - px}" y2="${gy}" stroke="#e8eeea" stroke-width="1"/>`;
      }).join("");

      const polyline = points.map((p, i) => `${x(i)},${y(p.amount)}`).join(" ");
      const area = `${px},${h - py} ${polyline} ${x(points.length - 1)},${h - py}`;
      const dots = points.map((p, i) => {
        const cx = x(i), cy = y(p.amount);
        return `<g><circle cx="${cx}" cy="${cy}" r="3.6" fill="#2f8f63"/><title>${p.month} ${fmtMoney(p.amount)}</title></g>`;
      }).join("");
      const valueLabels = points.map((p, i) => {
        const lx = x(i);
        const ly = Math.max(py - 6, y(p.amount) - (i % 2 === 0 ? 10 : 22));
        return `<text x="${lx}" y="${ly}" text-anchor="middle" fill="#2f5f49" font-size="10" font-weight="700" style="paint-order:stroke;stroke:#f8fbf9;stroke-width:3;stroke-linejoin:round">${fmtMoneyCompact(p.amount)}</text>`;
      }).join("");
      const labels = points.map((p, i) => {
        const lx = x(i);
        const show = points.length <= 8 || i % Math.ceil(points.length / 6) === 0 || i === points.length - 1;
        if (!show) return "";
        return `<text x="${lx}" y="${h - 6}" text-anchor="middle" fill="#6b746f" font-size="11">${p.month.slice(5)}</text>`;
      }).join("");

      svg.innerHTML = `
        ${grid}
        <polygon points="${area}" fill="rgba(47,143,99,0.14)"></polygon>
        <polyline points="${polyline}" fill="none" stroke="#2f8f63" stroke-width="2.2" stroke-linecap="round"></polyline>
        ${valueLabels}
        ${dots}
        ${labels}
      `;
    }

    function renderDonut(rows) {
      const donut = document.getElementById("donut");
      const legend = document.getElementById("donutLegend");
      const data = aggregateByCategory(rows).slice(0, 10);
      const total = data.reduce((s, x) => s + x.amount, 0);
      if (!data.length || total <= 0) {
        donut.style.background = "#edf1ee";
        legend.innerHTML = `<div class="empty">暂无分类数据</div>`;
        return;
      }

      let cursor = 0;
      const segments = data.map((item, i) => {
        const pct = item.amount / total;
        const start = cursor * 100;
        cursor += pct;
        const end = cursor * 100;
        const color = COLORS[i % COLORS.length];
        return { ...item, color, start, end, pct };
      });
      donut.style.background = `conic-gradient(${segments.map((s) => `${s.color} ${s.start}% ${s.end}%`).join(",")})`;

      legend.innerHTML = segments.map((s) => `
        <div class="legend-item" data-category="${s.category}">
          <span class="swatch" style="background:${s.color}"></span>
          <span class="legend-title">${s.category}</span>
          <span class="legend-value">${fmtMoney(s.amount)} · ${(s.pct * 100).toFixed(1)}%</span>
        </div>
      `).join("");

      legend.querySelectorAll(".legend-item").forEach((node) => {
        node.addEventListener("click", () => {
          const category = node.getAttribute("data-category");
          toggleSetValue(state.selectedCategories, category);
          render();
        });
      });
    }

    function renderCategoryBars(rows) {
      const holder = document.getElementById("categoryBars");
      const data = aggregateByCategory(rows).slice(0, 9);
      if (!data.length) {
        holder.innerHTML = `<div class="empty">当前筛选无分类排行</div>`;
        return;
      }
      const max = Math.max(...data.map((x) => x.amount), 1);
      holder.innerHTML = data.map((item) => `
        <div class="bar-row">
          <div class="bar-label">${item.category}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${(item.amount / max) * 100}%"></div></div>
          <div class="bar-value">${fmtMoney(item.amount)}</div>
        </div>
      `).join("");
    }

    function renderFilterPills() {
      if (!filterPills) return;
      const items = [];
      if (state.month !== "ALL") items.push({ type: "month", value: state.month, label: `月份: ${state.month}` });
      state.selectedCategories.forEach((v) => items.push({ type: "category", value: v, label: `分类: ${v}` }));
      state.selectedMerchants.forEach((v) => items.push({ type: "merchant", value: v, label: `商户: ${v}` }));
      if (state.keyword.trim()) items.push({ type: "keyword", value: "keyword", label: `关键词: ${state.keyword.trim()}` });
      if (state.includePending) items.push({ type: "pending", value: "pending", label: "显示待确认" });

      if (items.length === 0) {
        filterPills.innerHTML = `<span class="pill-empty">当前无筛选，展示默认分析结果。</span>`;
        return;
      }

      filterPills.innerHTML = `
        ${items
          .map(
            (x) => `<span class="pill" data-type="${x.type}" data-value="${x.value}">
              <span class="txt">${x.label}</span>
              <button type="button" title="移除筛选">×</button>
            </span>`
          )
          .join("")}
        <button class="pill-clear-all" type="button" data-action="clear-all">清空全部筛选 ×</button>
      `;

      filterPills.querySelectorAll(".pill button").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const pill = e.currentTarget.closest(".pill");
          if (!pill) return;
          const type = pill.getAttribute("data-type");
          const value = pill.getAttribute("data-value");
          if (type === "month") {
            state.month = "ALL";
            monthSelect.value = "ALL";
          }
          if (type === "category") state.selectedCategories.delete(value);
          if (type === "merchant") state.selectedMerchants.delete(value);
          if (type === "keyword") {
            state.keyword = "";
            keywordInput.value = "";
          }
          if (type === "pending") {
            state.includePending = false;
            includePending.checked = false;
          }
          render();
        });
      });
      const clearAll = filterPills.querySelector('[data-action="clear-all"]');
      if (clearAll) {
        clearAll.addEventListener("click", () => {
          state.month = "ALL";
          monthSelect.value = "ALL";
          state.selectedCategories.clear();
          state.selectedMerchants.clear();
          state.keyword = "";
          keywordInput.value = "";
          state.includePending = false;
          includePending.checked = false;
          render();
        });
      }
    }

    function renderCategoryCloud() {
      if (!categoryCloud) return;
      const categories = REPORT_DATA.categories.map((x) => x.category);
      if (!categories.length) {
        categoryCloud.innerHTML = `<div class="empty">暂无分类可筛选</div>`;
        return;
      }
      categoryCloud.innerHTML = categories.map((cat) => `
        <button class="chip ${state.selectedCategories.has(cat) ? "active" : ""}" data-category="${cat}">${cat}</button>
      `).join("");
      categoryCloud.querySelectorAll(".chip").forEach((btn) => {
        btn.addEventListener("click", () => {
          const category = btn.getAttribute("data-category");
          toggleSetValue(state.selectedCategories, category);
          render();
        });
      });
    }

    function renderMerchantCloud(rowsForCloud) {
      const holder = document.getElementById("merchantCloud");
      const data = aggregateByMerchant(rowsForCloud).slice(0, 22);
      if (!data.length) {
        holder.innerHTML = `<div class="empty">当前筛选无商户数据</div>`;
        return;
      }
      holder.innerHTML = data.map((item) => `
        <button class="chip ${state.selectedMerchants.has(item.merchant) ? "active" : ""}" data-merchant="${item.merchant}" title="${fmtMoney(item.amount)} · ${item.count}笔">${item.merchant}</button>
      `).join("");
      holder.querySelectorAll(".chip").forEach((btn) => {
        btn.addEventListener("click", () => {
          const merchant = btn.getAttribute("data-merchant");
          toggleSetValue(state.selectedMerchants, merchant);
          render();
        });
      });
    }

    function renderTable(rows) {
      const tbody = document.getElementById("txnBody");
      const sorted = sortRows(rows).slice(0, 160);
      updateSortHeaders();
      if (!sorted.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="empty">当前筛选无交易记录</td></tr>`;
        return;
      }
      tbody.innerHTML = sorted.map((row) => `
        <tr class="${row.needs_review ? "warn" : ""}">
          <td>${row.date}</td>
          <td>${row.category}</td>
          <td>${row.merchant}</td>
          <td>${row.description}</td>
          <td>${row.source_path}</td>
          <td>${(row.confidence * 100).toFixed(0)}%</td>
          <td class="num">${fmtMoney(row.amount)}</td>
        </tr>
      `).join("");
    }

    function render() {
      const rows = getFilteredRows();
      const rowsForCloud = getFilteredRows(true);
      const scopeLabel = state.month === "ALL" ? `${state.year} 全年` : state.month;
      if (privacyToggle) {
        privacyToggle.classList.toggle("active", state.hideAmounts);
        privacyToggle.setAttribute("aria-pressed", state.hideAmounts ? "true" : "false");
        privacyToggle.setAttribute("title", state.hideAmounts ? "点击显示金额" : "点击隐藏金额");
      }
      if (privacyToggleLabel) privacyToggleLabel.textContent = state.hideAmounts ? "显示金额" : "隐藏金额";
      text(
        "heroSubtitle",
        `${scopeLabel} 消费分析（筛选后 ${rows.length} 笔），金额 ${fmtMoney(rows.reduce((s, x) => s + x.amount, 0))}。`
      );
      renderMetrics(rows);
      renderTrendChart(rows);
      renderDonut(rows);
      renderCategoryCloud();
      renderCategoryBars(rows);
      renderMerchantCloud(rowsForCloud);
      renderFilterPills();
      renderTable(rows);

      text("resultHint", `· 当前筛选命中 ${rows.length.toLocaleString()} 笔`);
      text(
        "footInfo",
        `${scopeLabel} · 当前筛选 ${rows.length} 笔，待确认 ${rows.filter((x) => x.needs_review).length} 笔`
      );
      text("footTime", `生成时间：${REPORT_DATA.generated_at}`);
    }

    async function init() {
      const res = await fetch("/api/analytics/consumption-report");
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "加载消费分析失败");
      REPORT_DATA = data;
      initSelectors();

      includePending.checked = state.includePending;
      if (privacyToggle) {
        privacyToggle.addEventListener("click", () => {
          state.hideAmounts = !state.hideAmounts;
          try {
            window.localStorage.setItem(PRIVACY_MASK_STORAGE_KEY, state.hideAmounts ? "1" : "0");
          } catch {}
          render();
        });
      }
      monthSelect.addEventListener("change", () => {
        const value = monthSelect.value || "ALL";
        state.month = value;
        render();
      });
      yearSelect.addEventListener("change", () => {
        state.year = yearSelect.value || state.year;
        state.month = "ALL";
        refreshMonthSelector();
        render();
      });
      if (categorySelectAll) {
        categorySelectAll.addEventListener("click", () => {
          state.selectedCategories = new Set(REPORT_DATA.categories.map((x) => x.category));
          render();
        });
      }
      if (categoryClear) {
        categoryClear.addEventListener("click", () => {
          state.selectedCategories.clear();
          render();
        });
      }
      keywordInput.addEventListener("input", () => {
        state.keyword = keywordInput.value;
        render();
      });
      includePending.addEventListener("change", () => { state.includePending = includePending.checked; render(); });
      document.querySelectorAll(".th-sort").forEach((btn) => {
        btn.addEventListener("click", () => {
          const field = btn.getAttribute("data-sort");
          if (!field) return;
          if (state.sortField === field) {
            state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
          } else {
            state.sortField = field;
            state.sortDir = (field === "date" || field === "amount" || field === "confidence") ? "desc" : "asc";
          }
          render();
        });
      });
      try {
        state.hideAmounts = window.localStorage.getItem(PRIVACY_MASK_STORAGE_KEY) === "1";
      } catch {}
      render();
    }
    init().catch((err) => {
      const msg = (err && err.message) ? err.message : String(err);
      text("heroSubtitle", `加载失败：${msg}`);
      const tbody = document.getElementById("txnBody");
      if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">消费分析数据加载失败：${msg}</td></tr>`;
      text("footInfo", "数据加载失败");
      text("footTime", "生成时间：-");
    });
  </script>
</body>
</html>
