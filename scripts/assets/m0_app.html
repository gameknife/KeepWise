<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KeepWise M1 工作台</title>
  <link rel="stylesheet" href="/assets/m0_app.css">
</head>
<body>
  <div class="container">
    <section class="hero">
      <h1>KeepWise M1 工作台</h1>
      <p>主线：投资记录维护、区间收益率（现金加权）、财富总览、增长曲线。</p>
      <div class="hero-actions">
        <label class="privacy-toggle" for="privacyToggle">
          <input id="privacyToggle" type="checkbox">
          隐私截图模式（隐藏金额）
        </label>
      </div>
      <div class="tabs">
        <button class="tab-btn active" data-tab="tab-import">导入中心</button>
        <button class="tab-btn" data-tab="tab-records">记录录入</button>
        <button class="tab-btn" data-tab="tab-return">收益分析</button>
        <button class="tab-btn" data-tab="tab-wealth">财富总览</button>
        <button class="tab-btn" data-tab="tab-budget">预算与FIRE</button>
        <button class="tab-btn" data-tab="tab-query">基础查询</button>
        <button class="tab-btn" data-tab="tab-admin">高级管理</button>
      </div>
    </section>

    <section id="tab-import" class="panel">
      <h2>导入中心</h2>
      <p class="hint">先预览再确认导入。EML 支持多文件；有知有行支持 CSV / XLSX。</p>

      <h3>EML 导入</h3>
      <div class="row">
        <div>
          <label>选择 EML 文件（可多选）</label>
          <input id="emlFiles" type="file" multiple accept=".eml">
        </div>
        <div>
          <label>review_threshold</label>
          <input id="emlThreshold" type="number" step="0.01" min="0" max="1" value="0.70">
        </div>
      </div>
      <div class="actions">
        <button id="emlPreviewBtn" class="btn secondary">预览 EML</button>
        <button id="emlImportBtn" class="btn primary">确认导入 EML</button>
      </div>
      <div id="emlStatus" class="status hidden"></div>
      <div id="emlMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="emlErrorsWrap">
        <table>
          <thead><tr><th>错误文件</th><th>错误内容</th></tr></thead>
          <tbody id="emlErrorsBody"></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">有知有行导出表（CSV / XLSX）</h3>
      <div class="row">
        <div>
          <label>选择导出文件</label>
          <input id="yzxyCsvFile" type="file" accept=".csv,.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv">
        </div>
        <div></div>
      </div>
      <div class="actions">
        <button id="yzxyPreviewBtn" class="btn secondary">预览文件</button>
        <button id="yzxyImportBtn" class="btn primary">确认导入文件</button>
      </div>
      <div id="yzxyStatus" class="status hidden"></div>
      <div id="yzxyMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="yzxyErrorsWrap">
        <table>
          <thead><tr><th>错误信息</th></tr></thead>
          <tbody id="yzxyErrorsBody"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-records" class="panel hidden">
      <h2>记录录入</h2>
      <p class="hint">金额单位为元，系统自动转换为分。</p>

      <div class="split-grid">
        <div class="sub-panel">
          <h3>投资记录单条录入</h3>
          <div class="row-3">
            <div>
              <label>投资账户</label>
              <select id="invAccountId">
                <option value="">请先创建投资账户</option>
              </select>
            </div>
            <div>
              <label>快照日期</label>
              <input id="invSnapshotDate" type="date">
            </div>
            <div>
              <label>总资产（元）</label>
              <input id="invTotalAssets" type="number" step="0.01">
            </div>
            <div>
              <label>转入转出金额（元）</label>
              <input id="invTransferAmount" type="number" step="0.01" value="0">
            </div>
          </div>
          <div class="actions">
            <button id="invSaveBtn" class="btn primary">保存投资记录</button>
            <button id="invCancelEditBtn" class="btn secondary hidden" type="button">取消编辑</button>
          </div>
          <div id="invEditHint" class="hint hidden" style="margin-top:8px">当前为编辑模式</div>
          <div id="invStatus" class="status hidden"></div>
        </div>

        <div class="sub-panel">
          <h3>现金/不动产/负债记录录入</h3>
          <div class="row-3">
            <div>
              <label>资产类型</label>
              <select id="assetClass">
                <option value="cash">现金账户</option>
                <option value="real_estate">不动产账户</option>
                <option value="liability">负债账户</option>
              </select>
            </div>
            <div>
              <label>账户</label>
              <select id="assetAccountId">
                <option value="">请先创建账户</option>
              </select>
            </div>
            <div>
              <label>快照日期</label>
              <input id="assetSnapshotDate" type="date">
            </div>
            <div>
              <label>快照金额（元）</label>
              <input id="assetValue" type="number" step="0.01">
            </div>
          </div>
          <div class="actions">
            <button id="assetSaveBtn" class="btn primary">保存资产记录</button>
            <button id="assetCancelEditBtn" class="btn secondary hidden" type="button">取消编辑</button>
          </div>
          <div id="assetEditHint" class="hint hidden" style="margin-top:8px">当前为编辑模式</div>
          <div id="assetStatus" class="status hidden"></div>
        </div>
      </div>
    </section>

    <section id="tab-return" class="panel hidden">
      <h2>收益分析（现金加权）</h2>
      <p class="hint">公式：Modified Dietz。支持 YTD、近一年、近三年、成立以来、自定义区间。</p>

      <div class="row-4">
        <div>
          <label>投资账户</label>
          <select id="retAccountId"></select>
        </div>
        <div>
          <label>区间预设</label>
          <select id="retPreset">
            <option value="ytd">年度（YTD）</option>
            <option value="1y" selected>近一年</option>
            <option value="3y">近三年</option>
            <option value="since_inception">成立以来</option>
            <option value="custom">自定义</option>
          </select>
        </div>
        <div>
          <label>开始日期（custom）</label>
          <input id="retFrom" type="date">
        </div>
        <div>
          <label>结束日期（可选）</label>
          <input id="retTo" type="date">
        </div>
      </div>
      <div class="actions">
        <button id="retRefreshAccountsBtn" class="btn secondary">刷新账户列表</button>
        <button id="retBatchBtn" class="btn secondary">计算全部账户收益率</button>
      </div>
      <div id="retStatus" class="status hidden"></div>
      <div id="retMetrics" class="grid-metrics hidden"></div>

      <div class="pill-tabs" id="retChartTabs">
        <button class="pill-tab active" data-view="asset">总资产曲线</button>
        <button class="pill-tab" data-view="return">累计收益率曲线</button>
        <button class="pill-tab" data-view="growth">净增长资金曲线</button>
      </div>

      <div id="retChartAssetView" class="chart-card">
        <div class="chart-header">投资账户总资产曲线</div>
        <div id="retCurveLegend" class="legend hidden"></div>
        <div id="retCurveChart" class="chart-host"></div>
      </div>

      <div id="retChartReturnView" class="chart-card hidden">
        <div class="chart-header">区间累计收益率曲线（现金加权）</div>
        <div id="retRateLegend" class="legend hidden"></div>
        <div id="retRateChart" class="chart-host"></div>
      </div>

      <div id="retChartGrowthView" class="chart-card hidden">
        <div class="chart-header">区间净增长资金曲线</div>
        <div id="retGrowthLegend" class="legend hidden"></div>
        <div id="retGrowthChart" class="chart-host"></div>
      </div>

      <div class="table-wrap hidden" id="retFlowWrap">
        <table>
          <thead>
            <tr><th>日期</th><th>转入转出(元)</th><th>权重</th></tr>
          </thead>
          <tbody id="retFlowBody"></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">账户收益率对比（同一区间）</h3>
      <div id="retBatchMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="retBatchWrap">
        <table>
          <thead>
            <tr>
              <th>账户</th>
              <th>区间收益率</th>
              <th>年化收益率</th>
              <th>收益额(元)</th>
              <th>净流入(元)</th>
              <th>区间</th>
              <th>有效天数</th>
            </tr>
          </thead>
          <tbody id="retBatchBody"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-wealth" class="panel hidden">
      <h2>财富总览</h2>
      <p class="hint">按投资、现金、不动产、负债聚合展示资产趋势与结构关系。</p>

      <div class="pill-tabs" id="wealthAssetFilters">
        <button type="button" class="pill-tab active" data-key="include_investment" aria-pressed="true">投资</button>
        <button type="button" class="pill-tab active" data-key="include_cash" aria-pressed="true">现金</button>
        <button type="button" class="pill-tab active" data-key="include_real_estate" aria-pressed="true">不动产</button>
        <button type="button" class="pill-tab active" data-key="include_liability" aria-pressed="true">负债</button>
      </div>

      <div class="row">
        <div>
          <label>趋势区间</label>
          <select id="wealthCurvePreset">
            <option value="since_inception">成立以来</option>
            <option value="1y">近一年</option>
            <option value="ytd">YTD（今年以来）</option>
          </select>
        </div>
        <div></div>
      </div>

      <div id="wealthStatus" class="status hidden"></div>

      <h3 style="margin-top:16px">资产趋势</h3>
      <div id="wealthChartAssetView" class="chart-card">
        <div class="chart-header">资产趋势（堆叠）+ 总资产</div>
        <div id="wealthCurveLegend" class="legend hidden"></div>
        <div id="wealthCurveChart" class="chart-host"></div>
      </div>
      <div id="wealthChartGrowthView" class="chart-card">
        <div class="chart-header">资产 - 负债 - 净资产关系（Sankey）</div>
        <div id="wealthGrowthLegend" class="legend hidden"></div>
        <div id="wealthGrowthChart" class="chart-host"></div>
      </div>
    </section>

    <section id="tab-budget" class="panel hidden">
      <h2>预算与 FIRE 进度</h2>
      <p class="hint">低心智负担方案：维护少量平均月度支出预算项，系统自动折算年度预算，并对比实际消费与财务自由度。</p>

      <div class="split-grid">
        <div class="sub-panel">
          <h3>平均月度支出预算项</h3>
          <div class="row-4">
            <div>
              <label>项目名称</label>
              <input id="budgetItemName" type="text" placeholder="例如：房贷">
            </div>
            <div>
              <label>月度预算（元）</label>
              <input id="budgetItemMonthlyAmount" type="number" step="0.01" min="0" value="0">
            </div>
            <div>
              <label>排序</label>
              <input id="budgetItemSortOrder" type="number" step="1" value="1000">
            </div>
            <div>
              <label>状态</label>
              <select id="budgetItemIsActive">
                <option value="true" selected>启用</option>
                <option value="false">停用</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>编辑中的预算项 ID</label>
              <div id="budgetItemEditingId" class="metric" style="padding:9px 11px">-</div>
            </div>
            <div></div>
          </div>
          <div class="actions">
            <button id="budgetItemSaveBtn" class="btn primary">保存预算项</button>
            <button id="budgetItemCancelEditBtn" class="btn secondary hidden" type="button">取消编辑</button>
            <button id="budgetItemRefreshBtn" class="btn secondary" type="button">刷新预算项</button>
          </div>
          <div id="budgetItemEditHint" class="hint hidden" style="margin-top:8px">当前为编辑模式</div>
          <div id="budgetItemsStatus" class="status hidden"></div>
          <div id="budgetItemsMetrics" class="grid-metrics hidden"></div>

          <div class="table-wrap hidden" id="budgetItemsWrap">
            <table>
              <thead>
                <tr><th>项目</th><th>月度预算(元)</th><th>年度预算(元)</th><th>状态</th><th>来源</th><th>操作</th></tr>
              </thead>
              <tbody id="budgetItemsBody"></tbody>
            </table>
          </div>
        </div>

        <div class="sub-panel">
          <h3>预算总览与财务自由度</h3>
          <div class="row-3">
            <div>
              <label>预算年度</label>
              <input id="budgetYear" type="number" min="2000" max="2100" step="1">
            </div>
            <div>
              <label>提取率（%）</label>
              <input id="budgetWithdrawalRatePct" type="number" min="0.01" max="99.99" step="0.01" value="4.00">
            </div>
            <div></div>
          </div>
          <div class="actions">
            <button id="budgetRefreshBtn" class="btn primary" type="button">刷新预算/FIRE指标</button>
          </div>
          <div id="budgetStatus" class="status hidden"></div>

          <h4 style="margin-top:12px">预算总览</h4>
          <div id="budgetSummaryMetrics" class="grid-metrics hidden"></div>

          <h4 style="margin-top:12px">FIRE 进度</h4>
          <div id="fireMetrics" class="grid-metrics hidden"></div>

          <h4 style="margin-top:12px">月度复盘（总额）</h4>
          <div id="budgetMonthlyReviewMetrics" class="grid-metrics hidden"></div>
          <div class="table-wrap hidden" id="budgetMonthlyReviewWrap">
            <table>
              <thead>
                <tr><th>月份</th><th>预算(元)</th><th>实际消费(元)</th><th>差额(元)</th><th>达成率</th><th>笔数</th><th>状态</th></tr>
              </thead>
              <tbody id="budgetMonthlyReviewBody"></tbody>
            </table>
          </div>

          <p class="hint" style="margin-top:12px">
            实际消费口径默认排除待确认交易与排除统计交易；财务自由度口径使用「投资 + 现金」，默认提取率 4%。
          </p>
        </div>
      </div>
    </section>

    <section id="tab-query" class="panel hidden">
      <h2>基础查询</h2>
      <p class="hint">提供交易、投资、非投资资产记录的筛选与列表。</p>

      <h3>账户管理</h3>
      <p class="hint">手动创建账户后，记录录入与查询会自动使用下拉菜单展示。</p>
      <div class="sub-panel">
        <div class="row-4">
          <div>
            <label>账户类型</label>
            <select id="acctKind">
              <option value="investment">投资</option>
              <option value="cash">现金</option>
              <option value="real_estate">不动产</option>
              <option value="bank">银行卡</option>
              <option value="credit_card">信用卡</option>
              <option value="wallet">钱包</option>
              <option value="liability">负债</option>
              <option value="other">其他</option>
            </select>
          </div>
          <div>
            <label>账户名称</label>
            <input id="acctName" type="text" placeholder="例如：富途主账户">
          </div>
          <div>
            <label>编辑中的账户 ID</label>
            <div id="acctEditingId" class="metric" style="padding:9px 11px">-</div>
          </div>
          <div></div>
        </div>
        <div class="actions">
          <button id="acctSaveBtn" class="btn primary">创建账户</button>
          <button id="acctCancelEditBtn" class="btn secondary hidden" type="button">取消编辑</button>
          <button id="acctRefreshBtn" class="btn secondary" type="button">刷新账户列表</button>
        </div>
        <div id="acctEditHint" class="hint hidden" style="margin-top:8px">当前为账户编辑模式</div>
        <div id="acctStatus" class="status hidden"></div>
      </div>
      <div class="row-3" style="margin-top:12px">
        <div>
          <label>筛选类型</label>
          <select id="acctFilterKind">
            <option value="all">全部</option>
            <option value="investment">投资</option>
            <option value="cash">现金</option>
            <option value="real_estate">不动产</option>
            <option value="bank">银行卡</option>
            <option value="credit_card">信用卡</option>
            <option value="wallet">钱包</option>
            <option value="liability">负债</option>
            <option value="other">其他</option>
          </select>
        </div>
        <div>
          <label>关键词（名称/ID）</label>
          <input id="acctKeyword" type="text" placeholder="搜索账户">
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="actions" style="margin-top:0">
            <button id="acctFilterBtn" class="btn secondary" type="button">应用筛选</button>
            <button id="acctClearFilterBtn" class="btn secondary" type="button">清空筛选</button>
          </div>
        </div>
      </div>
      <div id="acctMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="acctWrap">
        <table>
          <thead>
            <tr>
              <th>类型</th>
              <th>账户名称</th>
              <th>账户 ID</th>
              <th>交易</th>
              <th>投资</th>
              <th>资产</th>
              <th>更新时间</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="acctBody"></tbody>
        </table>
      </div>

      <h3>交易查询</h3>
      <div class="row-3">
        <div><label>月份（YYYY-MM）</label><input id="qMonthKey" type="text" placeholder="2025-01"></div>
        <div><label>来源</label><input id="qTxSourceType" type="text" placeholder="cmb_eml"></div>
        <div>
          <label>账户</label>
          <select id="qTxAccountId">
            <option value="">全部账户</option>
          </select>
        </div>
        <div><label>关键词</label><input id="qTxKeyword" type="text"></div>
        <div><label>limit</label><input id="qTxLimit" type="number" value="100"></div>
      </div>
      <div class="actions">
        <button id="qTxBtn" class="btn secondary">查询交易</button>
      </div>
      <div id="qTxMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="qTxWrap">
        <table>
          <thead><tr><th>日期</th><th>商户</th><th>摘要</th><th>金额(元)</th><th>分类</th><th>来源</th></tr></thead>
          <tbody id="qTxBody"></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">投资记录查询</h3>
      <div class="row-3">
        <div><label>开始日期</label><input id="qInvFrom" type="date"></div>
        <div><label>结束日期</label><input id="qInvTo" type="date"></div>
        <div><label>来源</label><input id="qInvSourceType" type="text" placeholder="manual"></div>
        <div>
          <label>投资账户</label>
          <select id="qInvAccountId">
            <option value="">全部投资账户</option>
          </select>
        </div>
        <div><label>limit</label><input id="qInvLimit" type="number" value="100"></div>
      </div>
      <div class="actions">
        <button id="qInvBtn" class="btn secondary">查询投资记录</button>
      </div>
      <div id="qInvMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="qInvWrap">
        <table>
          <thead><tr><th>日期</th><th>账户</th><th>总资产(元)</th><th>转入转出(元)</th><th>来源</th><th>操作</th></tr></thead>
          <tbody id="qInvBody"></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">现金/不动产/负债记录查询</h3>
      <div class="row-3">
        <div><label>开始日期</label><input id="qAssetFrom" type="date"></div>
        <div><label>结束日期</label><input id="qAssetTo" type="date"></div>
        <div>
          <label>资产类型</label>
          <select id="qAssetClass">
            <option value="">全部</option>
            <option value="cash">现金</option>
            <option value="real_estate">不动产</option>
            <option value="liability">负债</option>
          </select>
        </div>
        <div>
          <label>账户</label>
          <select id="qAssetAccountId">
            <option value="">全部资产账户</option>
          </select>
        </div>
        <div><label>limit</label><input id="qAssetLimit" type="number" value="100"></div>
      </div>
      <div class="actions">
        <button id="qAssetBtn" class="btn secondary">查询资产/负债记录</button>
      </div>
      <div id="qAssetMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="qAssetWrap">
        <table>
          <thead><tr><th>日期</th><th>类型</th><th>账户</th><th>金额(元)</th><th>来源</th><th>操作</th></tr></thead>
          <tbody id="qAssetBody"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-admin" class="panel hidden">
      <h2>高级管理</h2>
      <p class="hint">用于开发验证：清空数据库后重新导入，验证流程可重复执行。</p>
      <div class="admin-warning">
        <strong>危险操作：</strong>会删除数据库中的全部业务数据（交易、投资、资产、导入任务、账户等），结构和索引会保留。
      </div>

      <div class="row-3" style="margin-top:10px">
        <div>
          <label>确认口令</label>
          <input id="adminConfirmText" type="text" placeholder="请输入确认口令">
        </div>
        <div>
          <label>系统口令</label>
          <div id="adminConfirmPhrase" class="metric" style="padding:9px 11px">-</div>
        </div>
        <div></div>
      </div>

      <div class="actions">
        <button id="adminLoadStatsBtn" class="btn secondary">查看数据库数据量</button>
        <button id="adminResetTxBtn" class="btn danger">仅清理交易数据（EML）</button>
        <button id="adminResetDbBtn" class="btn danger">清空全部数据库数据</button>
      </div>
      <p class="hint">“仅清理交易数据”会清空交易流水、对账记录，以及交易相关导入任务（`cmb_eml`），不会影响投资/资产/预算数据。</p>
      <div id="adminStatus" class="status hidden"></div>
      <div id="adminMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="adminRowsWrap">
        <table>
          <thead><tr><th>表名</th><th>清理前</th><th>清理后</th><th>删除行数</th></tr></thead>
          <tbody id="adminRowsBody"></tbody>
        </table>
      </div>
      <h3 style="margin-top:18px">交易规则管理</h3>
      <p class="hint">规则编辑已拆分到独立页面，便于集中维护和查看。</p>
      <div class="actions">
        <a class="btn secondary" href="/rules" target="_blank" rel="noopener">打开交易规则管理页面</a>
      </div>
    </section>
  </div>

  <script>
    const PRIVACY_MASK_STORAGE_KEY = "keepwise:privacy-mask-amounts";
    const BUDGET_WITHDRAWAL_RATE_PCT_STORAGE_KEY = "keepwise:budget-withdrawal-rate-pct";

    const state = {
      emlPreviewToken: "",
      yzxyPreviewToken: "",
      investmentAccounts: [],
      accountCatalogRows: [],
      refreshReturnAnalytics: null,
      refreshReturnBatchAnalytics: null,
      refreshWealthAnalytics: null,
      refreshBudgetAnalytics: null,
      refreshInvestmentQuery: null,
      refreshAssetQuery: null,
      renderAccountCatalog: null,
      privacyMaskAmounts: false,
      editingAccountRecord: null,
      editingInvestmentRecord: null,
      editingAssetRecord: null,
      editingBudgetItem: null,
    };

    const ACCOUNT_KIND_LABELS = {
      investment: "投资",
      cash: "现金",
      real_estate: "不动产",
      bank: "银行卡",
      credit_card: "信用卡",
      wallet: "钱包",
      liability: "负债",
      other: "其他",
    };

    function escapeHtml(text) {
      return String(text ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function shouldMaskAmounts() {
      return !!state.privacyMaskAmounts;
    }

    function formatAmountRaw(value) {
      if (value === null || value === undefined) return "-";
      const text = String(value);
      return text === "" ? "-" : text;
    }

    function renderAmountValue(value) {
      const raw = formatAmountRaw(value);
      const safe = escapeHtml(raw);
      const shown = shouldMaskAmounts() && raw !== "-" ? "****" : safe;
      return `<span class="amount-sensitive" data-amount-raw="${safe}">${shown}</span>`;
    }

    function applyAmountMaskInDom(root = document) {
      const nodes = root.querySelectorAll(".amount-sensitive[data-amount-raw]");
      nodes.forEach(node => {
        const raw = node.getAttribute("data-amount-raw") || "";
        if (shouldMaskAmounts() && raw && raw !== "-") {
          node.textContent = "****";
        } else {
          node.textContent = raw;
        }
      });
      document.body.classList.toggle("privacy-masked", shouldMaskAmounts());
    }

    function money(cents) {
      return (Number(cents || 0) / 100).toFixed(2);
    }

    function pct(value) {
      if (value === null || value === undefined || Number.isNaN(Number(value))) return "-";
      return `${(Number(value) * 100).toFixed(2)}%`;
    }

    function formatYuanShortFromCents(cents) {
      const yuan = Number(cents || 0) / 100;
      const abs = Math.abs(yuan);
      if (abs >= 100000000) return `${(yuan / 100000000).toFixed(2)}亿`;
      if (abs >= 10000) return `${(yuan / 10000).toFixed(1)}万`;
      return yuan.toFixed(0);
    }

    function buildReturnReferenceLines(rows) {
      const candidates = [-30, -20, -10, -5, 0, 5, 10, 20, 30, 40, 50];
      const values = (rows || [])
        .map(row => Number(row.cumulative_return_pct))
        .filter(v => Number.isFinite(v));
      const minVal = values.length ? Math.min(...values) : -5;
      const maxVal = values.length ? Math.max(...values) : 5;
      return candidates
        .filter(v => v >= minVal - 2 && v <= maxVal + 2)
        .map(v => ({
          value: v,
          label: `${v}%`,
          color: v === 0 ? "#b45309" : "#d2d9c7",
        }));
    }

    function setStatus(el, ok, text) {
      el.classList.remove("hidden", "ok", "err");
      el.classList.add(ok ? "ok" : "err");
      el.textContent = text;
    }

    function hide(el) {
      el.classList.add("hidden");
    }

    function isAmountMetricKey(key) {
      return /(\(元\)|金额|总资产|总财富|净流入|净增长|收益额)/.test(String(key || ""));
    }

    function showMetrics(holder, items) {
      holder.classList.remove("hidden");
      holder.innerHTML = items.map(item => `
        <div class="metric">
          <div class="k">${escapeHtml(item.k)}</div>
          <div class="v">${
            (item.amount === true || (item.amount !== false && isAmountMetricKey(item.k)))
              ? renderAmountValue(item.v)
              : escapeHtml(item.v)
          }</div>
        </div>
      `).join("");
      applyAmountMaskInDom(holder);
    }

    async function applyPrivacyMode(enabled, options = {}) {
      const { refreshAnalytics = true } = options;
      state.privacyMaskAmounts = !!enabled;
      try {
        window.localStorage.setItem(PRIVACY_MASK_STORAGE_KEY, state.privacyMaskAmounts ? "1" : "0");
      } catch {}
      const toggle = document.getElementById("privacyToggle");
      if (toggle && toggle.checked !== state.privacyMaskAmounts) {
        toggle.checked = state.privacyMaskAmounts;
      }
      applyAmountMaskInDom(document);

      if (!refreshAnalytics) return;
      const tasks = [];
      if (typeof state.refreshReturnAnalytics === "function") {
        tasks.push(state.refreshReturnAnalytics({ silent: true }));
      }
      if (typeof state.refreshReturnBatchAnalytics === "function") {
        tasks.push(state.refreshReturnBatchAnalytics({ silent: true }));
      }
      if (typeof state.refreshWealthAnalytics === "function") {
        tasks.push(state.refreshWealthAnalytics({ silent: true }));
      }
      if (typeof state.refreshBudgetAnalytics === "function") {
        tasks.push(state.refreshBudgetAnalytics({ silent: true }));
      }
      if (tasks.length > 0) {
        await Promise.allSettled(tasks);
      }
    }

    function initPrivacyToggle() {
      const toggle = document.getElementById("privacyToggle");
      if (!toggle) return;
      let enabled = false;
      try {
        enabled = window.localStorage.getItem(PRIVACY_MASK_STORAGE_KEY) === "1";
      } catch {}
      toggle.checked = enabled;
      applyPrivacyMode(enabled, { refreshAnalytics: false }).catch(() => {});
      toggle.addEventListener("change", () => {
        applyPrivacyMode(toggle.checked).catch(() => {});
      });
    }

    async function api(path, method = "GET", body = null) {
      const res = await fetch(path, {
        method,
        headers: { "Content-Type": "application/json" },
        body: body ? JSON.stringify(body) : null,
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "请求失败");
      return data;
    }

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = String(reader.result || "");
          const base64 = result.split(",")[1] || "";
          resolve({ name: file.name, content_base64: base64 });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function collectFiles(inputEl) {
      const files = Array.from(inputEl.files || []);
      const payload = [];
      for (const file of files) {
        payload.push(await readFileAsBase64(file));
      }
      return payload;
    }

    function openTab(targetTabId) {
      if (!targetTabId) return;
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-tab") === targetTabId);
      });
      document.querySelectorAll("section.panel").forEach(panel => {
        panel.classList.toggle("hidden", panel.id !== targetTabId);
      });
    }

    function initTabs() {
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          openTab(btn.getAttribute("data-tab"));
        });
      });
    }

    function setTodayIfEmpty(elId) {
      const el = document.getElementById(elId);
      if (el && !el.value) {
        el.value = new Date().toISOString().slice(0, 10);
      }
    }

    function syncCustomDateState(selectId, fromInputId) {
      const selectEl = document.getElementById(selectId);
      const fromEl = document.getElementById(fromInputId);
      if (!selectEl || !fromEl) return;
      const apply = () => {
        const isCustom = selectEl.value === "custom";
        fromEl.disabled = !isCustom;
        if (!isCustom) fromEl.value = "";
      };
      selectEl.addEventListener("change", apply);
      apply();
    }

    function accountKindLabel(kind) {
      return ACCOUNT_KIND_LABELS[kind] || kind || "-";
    }

    function accountTypeLabel(type) {
      if (type === "other") return "other(含不动产)";
      return type || "-";
    }

    function getAccountCatalogRowsByKinds(kinds) {
      const set = new Set(Array.isArray(kinds) ? kinds : [kinds]);
      return (state.accountCatalogRows || []).filter(row => set.has(String(row.account_kind || "")));
    }

    function accountOptionText(row, options = {}) {
      const { includeId = true, includeKind = false } = options;
      const name = String(row.account_name || row.account_id || "");
      const parts = [name];
      if (includeKind) parts.push(accountKindLabel(row.account_kind));
      if (includeId) parts.push(String(row.account_id || ""));
      return parts.filter(Boolean).join(" | ");
    }

    function buildAccountOptionsMarkup(rows, options = {}) {
      const {
        selectedValue = "",
        blankLabel = null,
        includeId = true,
        includeKind = false,
      } = options;
      const list = Array.isArray(rows) ? rows : [];
      const html = [];
      if (blankLabel !== null) {
        html.push(`<option value="">${escapeHtml(blankLabel)}</option>`);
      }
      list.forEach(row => {
        const id = String(row.account_id || "");
        const selected = id === String(selectedValue || "") ? " selected" : "";
        html.push(
          `<option value="${escapeHtml(id)}"${selected}>${escapeHtml(accountOptionText(row, { includeId, includeKind }))}</option>`
        );
      });
      if (selectedValue && !list.some(row => String(row.account_id || "") === String(selectedValue))) {
        html.push(`<option value="${escapeHtml(String(selectedValue))}" selected>${escapeHtml(String(selectedValue))}</option>`);
      }
      return html.join("");
    }

    function setSelectAccountOptions(selectEl, rows, options = {}) {
      if (!selectEl) return;
      const {
        blankLabel = "",
        includeId = true,
        includeKind = false,
        emptyLabel = "暂无可选账户",
      } = options;
      const prev = selectEl.value;
      const list = Array.isArray(rows) ? rows : [];
      const html = [];
      if (blankLabel !== null) {
        html.push(`<option value="">${escapeHtml(blankLabel)}</option>`);
      }
      list.forEach(row => {
        const id = String(row.account_id || "");
        html.push(`<option value="${escapeHtml(id)}">${escapeHtml(accountOptionText(row, { includeId, includeKind }))}</option>`);
      });
      if (html.length === 0) {
        html.push(`<option value="">${escapeHtml(emptyLabel)}</option>`);
      }
      selectEl.innerHTML = html.join("");
      const exists = prev && Array.from(selectEl.options).some(opt => opt.value === prev);
      if (exists) {
        selectEl.value = prev;
      } else if (prev && blankLabel === null) {
        selectEl.innerHTML += `<option value="${escapeHtml(prev)}" selected>${escapeHtml(prev)}</option>`;
      }
    }

    function refreshAccountSelectorsFromCatalog() {
      const allRows = state.accountCatalogRows || [];
      const investmentRows = getAccountCatalogRowsByKinds("investment");
      const cashRows = getAccountCatalogRowsByKinds("cash");
      const realEstateRows = getAccountCatalogRowsByKinds("real_estate");
      const liabilityRows = getAccountCatalogRowsByKinds("liability");

      setSelectAccountOptions(document.getElementById("invAccountId"), investmentRows, {
        blankLabel: "请选择投资账户",
        includeKind: false,
      });
      setSelectAccountOptions(document.getElementById("qInvAccountId"), investmentRows, {
        blankLabel: "全部投资账户",
        includeKind: false,
      });
      setSelectAccountOptions(document.getElementById("qTxAccountId"), allRows, {
        blankLabel: "全部账户",
        includeKind: true,
      });

      const assetClassEl = document.getElementById("assetClass");
      const assetClass = assetClassEl ? assetClassEl.value : "cash";
      const assetRows = assetClass === "real_estate"
        ? realEstateRows
        : (assetClass === "liability" ? liabilityRows : cashRows);
      const assetAccountLabel = assetClass === "real_estate"
        ? "请选择不动产账户"
        : (assetClass === "liability" ? "请选择负债账户" : "请选择现金账户");
      setSelectAccountOptions(document.getElementById("assetAccountId"), assetRows, {
        blankLabel: assetAccountLabel,
        includeKind: false,
      });

      const qAssetClassEl = document.getElementById("qAssetClass");
      const qAssetClass = qAssetClassEl ? qAssetClassEl.value : "";
      const qAssetRows = qAssetClass === "cash"
        ? cashRows
        : (
          qAssetClass === "real_estate"
            ? realEstateRows
            : (qAssetClass === "liability" ? liabilityRows : [...cashRows, ...realEstateRows, ...liabilityRows])
        );
      const qAssetLabel = qAssetClass
        ? `全部${qAssetClass === "cash" ? "现金" : (qAssetClass === "real_estate" ? "不动产" : "负债")}账户`
        : "全部资产/负债账户";
      setSelectAccountOptions(document.getElementById("qAssetAccountId"), qAssetRows, {
        blankLabel: qAssetLabel,
        includeKind: qAssetClass === "",
      });
    }

    async function refreshAccountCatalog() {
      const data = await api("/api/accounts/catalog?kind=all&limit=1000");
      state.accountCatalogRows = Array.isArray(data.rows) ? data.rows : [];
      refreshAccountSelectorsFromCatalog();
      if (typeof state.renderAccountCatalog === "function") {
        state.renderAccountCatalog();
      }
    }

    function renderLineChart(hostId, legendId, rows, seriesDefs, options = {}) {
      const host = document.getElementById(hostId);
      const legend = document.getElementById(legendId);
      if (!rows || rows.length === 0) {
        host.innerHTML = `<div class="empty">暂无可视化数据</div>`;
        legend.classList.add("hidden");
        return;
      }

      const width = 1000;
      const height = 360;
      const padLeft = 60;
      const padRight = 24;
      const padTop = 16;
      const padBottom = 30;
      const chartWidth = width - padLeft - padRight;
      const chartHeight = height - padTop - padBottom;

      const yTickCount = Math.max(2, Number(options.yTickCount || 4));
      const includeZero = options.includeZero !== false;
      const yAxisFormatter = options.yAxisFormatter || ((v) => `${Number(v).toFixed(2)}`);
      const referenceLines = Array.isArray(options.referenceLines) ? options.referenceLines : [];

      const values = rows.flatMap(row => seriesDefs.map(s => Number(row[s.key])));
      const numericValues = values.filter(v => Number.isFinite(v));
      if (numericValues.length === 0) {
        host.innerHTML = `<div class="empty">暂无可视化数据</div>`;
        legend.classList.add("hidden");
        return;
      }

      let minVal = Math.min(...numericValues);
      let maxVal = Math.max(...numericValues);
      if (includeZero) {
        minVal = Math.min(minVal, 0);
        maxVal = Math.max(maxVal, 0);
      }
      if (Number.isFinite(options.minValue)) minVal = Number(options.minValue);
      if (Number.isFinite(options.maxValue)) maxVal = Number(options.maxValue);
      if (Math.abs(maxVal - minVal) < 1e-9) {
        const padding = Math.max(1, Math.abs(maxVal) * 0.1);
        minVal -= padding;
        maxVal += padding;
      }
      const span = maxVal - minVal;
      const xStep = rows.length > 1 ? chartWidth / (rows.length - 1) : 0;

      const x = idx => padLeft + idx * xStep;
      const y = val => padTop + ((maxVal - val) / span) * chartHeight;

      const gridLines = [];
      const yLabels = [];
      for (let i = 0; i <= yTickCount; i += 1) {
        const ratio = i / yTickCount;
        const val = maxVal - ratio * span;
        const yy = y(val);
        gridLines.push(
          `<line x1="${padLeft}" y1="${yy.toFixed(2)}" x2="${width - padRight}" y2="${yy.toFixed(2)}" stroke="#e3e8d8" stroke-width="1" />`
        );
        yLabels.push(
          `<text x="${padLeft - 8}" y="${(yy + 4).toFixed(2)}" font-size="11" text-anchor="end" fill="#6a767f">${yAxisFormatter(val)}</text>`
        );
      }

      const refLineSvg = referenceLines
        .filter(line => Number.isFinite(line.value))
        .filter(line => line.value >= minVal && line.value <= maxVal)
        .map(line => {
          const yy = y(Number(line.value));
          const color = line.color || "#d2d9c7";
          return `
            <line x1="${padLeft}" y1="${yy.toFixed(2)}" x2="${width - padRight}" y2="${yy.toFixed(2)}" stroke="${color}" stroke-width="1.2" stroke-dasharray="5 4" />
            <text x="${padLeft + 4}" y="${(yy - 4).toFixed(2)}" font-size="11" fill="${color}">${line.label || ""}</text>
          `;
        }).join("");

      const seriesPaths = seriesDefs.map(def => {
        const segments = [];
        let current = [];
        rows.forEach((row, idx) => {
          const val = Number(row[def.key]);
          if (!Number.isFinite(val)) {
            if (current.length > 1) {
              segments.push(current);
            }
            current = [];
            return;
          }
          current.push(`${x(idx).toFixed(2)},${y(val).toFixed(2)}`);
        });
        if (current.length > 1) segments.push(current);
        return segments
          .map(points => `<polyline fill="none" stroke="${def.color}" stroke-width="2.4" points="${points.join(" ")}" />`)
          .join("");
      }).join("");

      const xStartLabel = rows[0].snapshot_date || "";
      const xEndLabel = rows[rows.length - 1].snapshot_date || "";

      host.innerHTML = `
        <div class="chart-stage">
          <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" class="chart-svg">
            ${gridLines.join("")}
            ${yLabels.join("")}
            ${refLineSvg}
            <line x1="${padLeft}" y1="${height - padBottom}" x2="${width - padRight}" y2="${height - padBottom}" stroke="#cfd8c3" stroke-width="1.2" />
            <line x1="${padLeft}" y1="${padTop}" x2="${padLeft}" y2="${height - padBottom}" stroke="#cfd8c3" stroke-width="1.2" />
            ${seriesPaths}
            <line data-role="hover-line" x1="${padLeft}" y1="${padTop}" x2="${padLeft}" y2="${height - padBottom}" stroke="#6f7f86" stroke-width="1.2" stroke-dasharray="4 4" visibility="hidden" />
            ${seriesDefs.map((def, idx) => `
              <circle data-role="hover-dot" data-series="${idx}" r="4.5" fill="#fff" stroke="${def.color}" stroke-width="2" visibility="hidden" />
            `).join("")}
            <text x="${padLeft}" y="${height - 8}" font-size="11" fill="#6a767f">${xStartLabel}</text>
            <text x="${width - padRight - 90}" y="${height - 8}" font-size="11" fill="#6a767f">${xEndLabel}</text>
            <rect data-role="overlay" x="${padLeft}" y="${padTop}" width="${chartWidth}" height="${chartHeight}" fill="transparent" />
          </svg>
          <div class="chart-tooltip hidden" data-role="tooltip"></div>
        </div>
      `;

      legend.classList.remove("hidden");
      legend.innerHTML = seriesDefs.map(def => `
        <span class="legend-item"><i style="background:${def.color}"></i>${def.label}</span>
      `).join("");

      const stage = host.querySelector(".chart-stage");
      const overlay = host.querySelector('[data-role="overlay"]');
      const hoverLine = host.querySelector('[data-role="hover-line"]');
      const dots = Array.from(host.querySelectorAll('[data-role="hover-dot"]'));
      const tooltip = host.querySelector('[data-role="tooltip"]');
      if (!stage || !overlay || !hoverLine || !tooltip) return;

      function showAt(index, pointerX = null) {
        if (index < 0 || index >= rows.length) return;
        const row = rows[index];
        const xCoord = x(index);
        hoverLine.setAttribute("x1", xCoord.toFixed(2));
        hoverLine.setAttribute("x2", xCoord.toFixed(2));
        hoverLine.setAttribute("visibility", "visible");

        const lines = [];
        seriesDefs.forEach((def, idx) => {
          const val = Number(row[def.key]);
          const dot = dots[idx];
          if (!dot) return;
          if (Number.isFinite(val)) {
            const yCoord = y(val);
            dot.setAttribute("cx", xCoord.toFixed(2));
            dot.setAttribute("cy", yCoord.toFixed(2));
            dot.setAttribute("visibility", "visible");
            const valueText = typeof def.formatValue === "function" ? def.formatValue(val, row) : `${val}`;
            lines.push(`<div class="t-row"><i style="background:${def.color}"></i><span>${def.label}: ${valueText}</span></div>`);
          } else {
            dot.setAttribute("visibility", "hidden");
          }
        });

        const title = typeof options.tooltipTitle === "function"
          ? options.tooltipTitle(row, index)
          : (row.snapshot_date || "");
        tooltip.innerHTML = `<div class="t-title">${title}</div>${lines.join("")}`;
        tooltip.classList.remove("hidden");

        const stageRect = stage.getBoundingClientRect();
        const targetX = pointerX !== null ? pointerX : (xCoord / width) * stageRect.width;
        const tooltipWidth = tooltip.offsetWidth || 140;
        let left = targetX + 12;
        if (left + tooltipWidth > stageRect.width - 6) left = targetX - tooltipWidth - 12;
        if (left < 6) left = 6;
        tooltip.style.left = `${left}px`;
        tooltip.style.top = "8px";
      }

      function hideHover() {
        hoverLine.setAttribute("visibility", "hidden");
        dots.forEach(dot => dot.setAttribute("visibility", "hidden"));
        tooltip.classList.add("hidden");
      }

      overlay.addEventListener("mousemove", (event) => {
        const rect = overlay.getBoundingClientRect();
        if (rect.width <= 0) return;
        const px = event.clientX - rect.left;
        const localX = (px / rect.width) * chartWidth;
        const idx = rows.length > 1 ? Math.round(localX / xStep) : 0;
        const clampedIdx = Math.max(0, Math.min(rows.length - 1, idx));
        showAt(clampedIdx, event.clientX - stage.getBoundingClientRect().left);
      });

      overlay.addEventListener("mouseenter", () => {
        showAt(rows.length - 1);
      });
      overlay.addEventListener("mouseleave", hideHover);
    }

    function renderWealthStackedTrendChart(hostId, legendId, rows, filters = {}) {
      const host = document.getElementById(hostId);
      const legend = document.getElementById(legendId);
      if (!host || !legend) return;
      if (!rows || rows.length === 0) {
        host.innerHTML = `<div class="empty">暂无可视化数据</div>`;
        legend.classList.add("hidden");
        return;
      }

      const width = 1000;
      const height = 380;
      const padLeft = 104;
      const padRight = 24;
      const padTop = 16;
      const padBottom = 30;
      const chartWidth = width - padLeft - padRight;
      const chartHeight = height - padTop - padBottom;
      const xStep = rows.length > 1 ? chartWidth / (rows.length - 1) : 0;
      const x = idx => padLeft + idx * xStep;

      const stackSeries = [];
      if (filters.include_investment) stackSeries.push({ key: "investment_total_cents", label: "投资", color: "#e28b00" });
      if (filters.include_cash) stackSeries.push({ key: "cash_total_cents", label: "现金", color: "#2f6db4" });
      if (filters.include_real_estate) stackSeries.push({ key: "real_estate_total_cents", label: "不动产", color: "#7d5a97" });

      const includeLiability = !!filters.include_liability;
      const areaSegments = [];
      let maxVal = 0;
      let minVal = 0;
      const grossLine = [];
      const liabilityLine = [];
      const pointMeta = [];

      rows.forEach((row, idx) => {
        let positiveBase = 0;
        const segmentsAtPoint = [];
        stackSeries.forEach(series => {
          const value = Number(row[series.key] || 0);
          const y0 = positiveBase;
          const y1 = positiveBase + value;
          positiveBase = y1;
          segmentsAtPoint.push({ ...series, y0, y1, value });
          maxVal = Math.max(maxVal, y1);
        });
        const liability = includeLiability ? Number(row.liability_total_cents || 0) : 0;
        const liabilityBottom = -liability;
        minVal = Math.min(minVal, liabilityBottom);
        const gross = Number(row.wealth_total_cents || 0);
        const net = Number(row.net_asset_total_cents || 0);
        maxVal = Math.max(maxVal, gross);
        minVal = Math.min(minVal, 0);
        grossLine.push(gross);
        liabilityLine.push(liability);
        pointMeta.push({
          snapshot_date: row.snapshot_date || "",
          gross,
          liability,
          net,
          segments: segmentsAtPoint,
        });

        segmentsAtPoint.forEach(seg => {
          let holder = areaSegments.find(item => item.key === seg.key);
          if (!holder) {
            holder = { key: seg.key, label: seg.label, color: seg.color, uppers: [], lowers: [] };
            areaSegments.push(holder);
          }
          holder.uppers.push({ x: x(idx), yValue: seg.y1 });
          holder.lowers.push({ x: x(idx), yValue: seg.y0 });
        });
      });

      if (Math.abs(maxVal - minVal) < 1e-9) {
        maxVal += 1;
        minVal -= 1;
      }
      const span = maxVal - minVal;
      const y = val => padTop + ((maxVal - val) / span) * chartHeight;
      const zeroY = y(0);

      const yTickCount = 4;
      const gridLines = [];
      const yLabels = [];
      for (let i = 0; i <= yTickCount; i += 1) {
        const ratio = i / yTickCount;
        const val = maxVal - ratio * span;
        const yy = y(val);
        gridLines.push(
          `<line x1="${padLeft}" y1="${yy.toFixed(2)}" x2="${width - padRight}" y2="${yy.toFixed(2)}" stroke="#e3e8d8" stroke-width="1" />`
        );
        yLabels.push(
          `<text x="${padLeft - 8}" y="${(yy + 4).toFixed(2)}" font-size="11" text-anchor="end" fill="#6a767f">${
            shouldMaskAmounts() ? "****" : `${formatYuanShortFromCents(val)}元`
          }</text>`
        );
      }
      const areaPolygons = areaSegments.map(seg => {
        const upper = seg.uppers.map(p => `${p.x.toFixed(2)},${y(p.yValue).toFixed(2)}`);
        const lower = seg.lowers.slice().reverse().map(p => `${p.x.toFixed(2)},${y(p.yValue).toFixed(2)}`);
        return `
          <polygon points="${upper.concat(lower).join(" ")}"
            fill="${seg.color}" fill-opacity="0.14" stroke="${seg.color}" stroke-width="1.4" />
        `;
      }).join("");

      const liabilityArea = includeLiability
        ? (() => {
            const upper = rows.map((_, idx) => `${x(idx).toFixed(2)},${zeroY.toFixed(2)}`);
            const lower = rows.slice().reverse().map((row, reverseIdx) => {
              const idx = rows.length - 1 - reverseIdx;
              const liab = Number(row.liability_total_cents || 0);
              return `${x(idx).toFixed(2)},${y(-liab).toFixed(2)}`;
            });
            return `
              <polygon points="${upper.concat(lower).join(" ")}"
                fill="#b42318" fill-opacity="0.07" stroke="none" />
              <polygon points="${upper.concat(lower).join(" ")}"
                fill="url(#wealthLiabilityPattern)" stroke="#b42318" stroke-opacity="0.75" stroke-width="1.2" />
            `;
          })()
        : "";

      function polyline(values, color, widthPx = 2.4, dash = "") {
        const points = values.map((val, idx) => `${x(idx).toFixed(2)},${y(Number(val)).toFixed(2)}`).join(" ");
        return `<polyline fill="none" stroke="${color}" stroke-width="${widthPx}" ${dash ? `stroke-dasharray="${dash}"` : ""} points="${points}" />`;
      }

      const grossLineSvg = polyline(grossLine, "#0f766e", 2.8);
      const liabilityLineSvg = includeLiability ? polyline(liabilityLine.map(v => -v), "#b42318", 2.0, "6 4") : "";

      const xStartLabel = rows[0].snapshot_date || "";
      const xEndLabel = rows[rows.length - 1].snapshot_date || "";

      host.innerHTML = `
        <div class="chart-stage">
          <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" class="chart-svg">
            <defs>
              <pattern id="wealthLiabilityPattern" patternUnits="userSpaceOnUse" width="12" height="12" patternTransform="rotate(135)">
                <line x1="0" y1="0" x2="0" y2="12" stroke="#b42318" stroke-width="2" stroke-opacity="0.22" stroke-dasharray="3 4" />
              </pattern>
            </defs>
            ${gridLines.join("")}
            ${yLabels.join("")}
            <line x1="${padLeft}" y1="${height - padBottom}" x2="${width - padRight}" y2="${height - padBottom}" stroke="#cfd8c3" stroke-width="1.2" />
            <line x1="${padLeft}" y1="${padTop}" x2="${padLeft}" y2="${height - padBottom}" stroke="#cfd8c3" stroke-width="1.2" />
            ${areaPolygons}
            ${liabilityArea}
            <line x1="${padLeft}" y1="${zeroY.toFixed(2)}" x2="${width - padRight}" y2="${zeroY.toFixed(2)}" stroke="#b6c2bd" stroke-width="1.3" stroke-dasharray="5 4" />
            ${grossLineSvg}
            ${liabilityLineSvg}
            <line data-role="hover-line" x1="${padLeft}" y1="${padTop}" x2="${padLeft}" y2="${height - padBottom}" stroke="#6f7f86" stroke-width="1.2" stroke-dasharray="4 4" visibility="hidden" />
            <circle data-role="hover-dot-gross" r="4.5" fill="#fff" stroke="#0f766e" stroke-width="2" visibility="hidden" />
            ${includeLiability ? '<circle data-role="hover-dot-liab" r="4.2" fill="#fff" stroke="#b42318" stroke-width="2" visibility="hidden" />' : ""}
            <text x="${padLeft}" y="${height - 8}" font-size="11" fill="#6a767f">${xStartLabel}</text>
            <text x="${width - padRight - 90}" y="${height - 8}" font-size="11" fill="#6a767f">${xEndLabel}</text>
            <rect data-role="overlay" x="${padLeft}" y="${padTop}" width="${chartWidth}" height="${chartHeight}" fill="transparent" />
          </svg>
          <div class="chart-tooltip hidden" data-role="tooltip"></div>
        </div>
      `;

      const legendItems = [
        ...areaSegments.map(seg => `<span class="legend-item"><i style="background:${seg.color}"></i>${seg.label}(堆叠)</span>`),
        includeLiability ? `<span class="legend-item"><i style="background:#b42318"></i>负债(向下堆叠/虚线)</span>` : "",
        `<span class="legend-item"><i style="background:#0f766e"></i>总资产</span>`,
      ].filter(Boolean);
      legend.classList.remove("hidden");
      legend.innerHTML = legendItems.join("");

      const stage = host.querySelector(".chart-stage");
      const overlay = host.querySelector('[data-role="overlay"]');
      const hoverLine = host.querySelector('[data-role="hover-line"]');
      const dotGross = host.querySelector('[data-role="hover-dot-gross"]');
      const dotLiab = host.querySelector('[data-role="hover-dot-liab"]');
      const tooltip = host.querySelector('[data-role="tooltip"]');
      if (!stage || !overlay || !hoverLine || !tooltip || !dotGross) return;

      function showAt(index, pointerX = null) {
        if (index < 0 || index >= pointMeta.length) return;
        const meta = pointMeta[index];
        const xx = x(index);
        hoverLine.setAttribute("x1", xx.toFixed(2));
        hoverLine.setAttribute("x2", xx.toFixed(2));
        hoverLine.setAttribute("visibility", "visible");

        dotGross.setAttribute("cx", xx.toFixed(2));
        dotGross.setAttribute("cy", y(meta.gross).toFixed(2));
        dotGross.setAttribute("visibility", "visible");

        if (dotLiab) {
          dotLiab.setAttribute("cx", xx.toFixed(2));
          dotLiab.setAttribute("cy", y(-meta.liability).toFixed(2));
          dotLiab.setAttribute("visibility", includeLiability ? "visible" : "hidden");
        }

        const lines = [];
        meta.segments.forEach(seg => {
          lines.push(`<div class="t-row"><i style="background:${seg.color}"></i><span>${seg.label}: ${renderAmountValue(`${money(seg.value)} 元`)}</span></div>`);
        });
        if (includeLiability) {
          lines.push(`<div class="t-row"><i style="background:#b42318"></i><span>负债: ${renderAmountValue(`${money(meta.liability)} 元`)}</span></div>`);
        }
        lines.push(`<div class="t-row"><i style="background:#0f766e"></i><span>总资产: ${renderAmountValue(`${money(meta.gross)} 元`)}</span></div>`);

        tooltip.innerHTML = `<div class="t-title">${meta.snapshot_date}</div>${lines.join("")}`;
        tooltip.classList.remove("hidden");

        const stageRect = stage.getBoundingClientRect();
        const targetX = pointerX !== null ? pointerX : (xx / width) * stageRect.width;
        const tooltipWidth = tooltip.offsetWidth || 180;
        let left = targetX + 12;
        if (left + tooltipWidth > stageRect.width - 6) left = targetX - tooltipWidth - 12;
        if (left < 6) left = 6;
        tooltip.style.left = `${left}px`;
        tooltip.style.top = "8px";
      }

      function hideHover() {
        hoverLine.setAttribute("visibility", "hidden");
        dotGross.setAttribute("visibility", "hidden");
        if (dotLiab) dotLiab.setAttribute("visibility", "hidden");
        tooltip.classList.add("hidden");
      }

      overlay.addEventListener("mousemove", (event) => {
        const rect = overlay.getBoundingClientRect();
        if (rect.width <= 0) return;
        const px = event.clientX - rect.left;
        const localX = (px / rect.width) * chartWidth;
        const idx = rows.length > 1 ? Math.round(localX / xStep) : 0;
        const clampedIdx = Math.max(0, Math.min(rows.length - 1, idx));
        showAt(clampedIdx, event.clientX - stage.getBoundingClientRect().left);
      });
      overlay.addEventListener("mouseenter", () => showAt(rows.length - 1));
      overlay.addEventListener("mouseleave", hideHover);
      applyAmountMaskInDom(host);
    }

    function renderWealthSankeyChart(hostId, legendId, overviewData, filters = {}) {
      const host = document.getElementById(hostId);
      const legend = document.getElementById(legendId);
      if (!host || !legend) return;
      const summary = overviewData && overviewData.summary ? overviewData.summary : null;
      if (!summary) {
        host.innerHTML = `<div class="empty">暂无关系图数据</div>`;
        legend.classList.add("hidden");
        return;
      }

      const liability = filters.include_liability ? Number(summary.liability_total_cents || 0) : 0;
      const gross = Number(summary.gross_assets_total_cents || summary.wealth_total_cents || 0);
      const net = Number(summary.net_asset_total_cents || (gross - liability));
      if (gross <= 0 && liability <= 0) {
        host.innerHTML = `<div class="empty">暂无关系图数据</div>`;
        legend.classList.add("hidden");
        return;
      }

      const categories = [
        { key: "cash", enabled: !!filters.include_cash, label: "现金", color: "#2f6db4", total: Number(summary.cash_total_cents || 0) },
        { key: "real_estate", enabled: !!filters.include_real_estate, label: "不动产", color: "#7d5a97", total: Number(summary.real_estate_total_cents || 0) },
        { key: "investment", enabled: !!filters.include_investment, label: "投资", color: "#e28b00", total: Number(summary.investment_total_cents || 0) },
      ].filter(item => item.enabled && item.total > 0);

      const width = 980;
      const height = 420;
      const centerY = 220;

      function formatSankeyAmount(cents, options = {}) {
        const { negative = false } = options;
        if (shouldMaskAmounts()) return "****";
        const raw = Number(cents || 0);
        const value = negative ? -Math.abs(raw) : raw;
        const yuan = value / 100;
        const abs = Math.abs(yuan);
        if (abs >= 100000000) return `${(yuan / 100000000).toFixed(2)}亿`;
        if (abs >= 10000) return `${(yuan / 10000).toFixed(2)}万`;
        return `${yuan.toFixed(2)}元`;
      }

      function escapeSvgText(text) {
        return escapeHtml(String(text || "")).replaceAll("\n", " ");
      }

      function linkPath(x1, y1, x2, y2, bend = 0.42) {
        const dx = x2 - x1;
        const c1 = x1 + dx * bend;
        const c2 = x2 - dx * (1 - bend);
        return `M ${x1} ${y1} C ${c1} ${y1}, ${c2} ${y2}, ${x2} ${y2}`;
      }

      const flowBase = Math.max(gross, Math.abs(net), liability, 1);
      const flowWidth = (value, minWidth = 3, maxWidth = 58) => {
        const raw = (Math.abs(Number(value || 0)) / flowBase) * maxWidth;
        return Math.max(minWidth, Math.min(maxWidth, raw));
      };

      const leftNodeX = 56;
      const leftNodeW = 170;
      const leftNodeH = 42;
      const leftGap = 16;
      const leftBlockH = categories.length > 0 ? categories.length * leftNodeH + (categories.length - 1) * leftGap : 0;
      const leftStartY = Math.max(78, centerY - Math.round(leftBlockH / 2));

      const grossNode = { x: 392, y: centerY - 32, w: 170, h: 64, label: "总资产", value: gross, color: "#6366f1" };
      const netNode = { x: 700, y: centerY - 74, w: 170, h: 48, label: "净资产", value: net, color: "#10b981" };
      const debtNode = { x: 700, y: centerY + 30, w: 170, h: 48, label: "负债", value: liability, color: "#b42318" };

      categories.forEach((item, idx) => {
        item.x = leftNodeX;
        item.y = leftStartY + idx * (leftNodeH + leftGap);
        item.w = leftNodeW;
        item.h = leftNodeH;
      });

      const topCards = [
        { x: 392, y: 16, w: 120, h: 52, label: "总资产", value: gross, color: "#6366f1" },
        { x: 520, y: 16, w: 120, h: 52, label: "总负债", value: liability, color: "#b42318", negative: true },
        { x: 648, y: 16, w: 120, h: 52, label: "净资产", value: net, color: "#10b981" },
      ];

      function nodeBox(node, options = {}) {
        const { muted = false } = options;
        const stroke = muted ? "rgba(148,163,184,0.28)" : "rgba(99,102,241,0.14)";
        return `
          <g>
            <rect x="${node.x}" y="${node.y}" width="${node.w}" height="${node.h}" rx="12" ry="12"
              fill="rgba(255,255,255,0.96)" stroke="${stroke}" stroke-width="1" />
            <rect x="${node.x}" y="${node.y}" width="8" height="${node.h}" rx="12" ry="12" fill="${node.color}" opacity="0.88" />
            <text x="${node.x + 14}" y="${node.y + 18}" font-size="12" fill="#475569">${escapeSvgText(node.label)}</text>
            <text x="${node.x + 14}" y="${node.y + node.h - 12}" font-size="13" font-weight="700" fill="${node.color}">
              ${escapeSvgText(formatSankeyAmount(node.value, { negative: node.label.includes("负债") }))}
            </text>
          </g>
        `;
      }

      function categoryNodeBox(node) {
        const ratio = gross > 0 ? (Number(node.total || 0) / gross) : 0;
        const ratioText = `${(ratio * 100).toFixed(1)}%`;
        return `
          <g>
            <rect x="${node.x}" y="${node.y}" width="${node.w}" height="${node.h}" rx="10" ry="10"
              fill="rgba(255,255,255,0.95)" stroke="rgba(148,163,184,0.22)" stroke-width="1" />
            <rect x="${node.x}" y="${node.y}" width="7" height="${node.h}" rx="10" ry="10" fill="${node.color}" />
            <text x="${node.x + 13}" y="${node.y + 16}" font-size="11.5" fill="#334155">${escapeSvgText(node.label)}</text>
            <text x="${node.x + 13}" y="${node.y + 31}" font-size="10.5" fill="rgba(71,85,105,0.78)">
              ${escapeSvgText(formatSankeyAmount(node.total))} · ${escapeSvgText(ratioText)}
            </text>
          </g>
        `;
      }

      function summaryCard(card) {
        return `
          <g>
            <rect x="${card.x}" y="${card.y}" width="${card.w}" height="${card.h}" rx="12" ry="12"
              fill="rgba(255,255,255,0.90)" stroke="rgba(148,163,184,0.20)" stroke-width="1" />
            <text x="${card.x + 12}" y="${card.y + 17}" font-size="11.5" fill="#64748b">${escapeSvgText(card.label)}</text>
            <text x="${card.x + 12}" y="${card.y + 38}" font-size="13.5" font-weight="700" fill="${card.color}">
              ${escapeSvgText(formatSankeyAmount(card.value, { negative: !!card.negative }))}
            </text>
          </g>
        `;
      }

      const links = [];
      categories.forEach((cat, idx) => {
        links.push({
          d: linkPath(cat.x + cat.w, cat.y + cat.h / 2, grossNode.x, grossNode.y + grossNode.h / 2 + (idx - (categories.length - 1) / 2) * 8, 0.46),
          color: cat.color,
          width: flowWidth(cat.total, 4, 44),
          glow: 0.22,
        });
      });

      const netPortion = Math.max(0, gross - liability);
      if (netPortion > 0) {
        links.push({
          d: linkPath(grossNode.x + grossNode.w, grossNode.y + grossNode.h / 2 - 6, netNode.x, netNode.y + netNode.h / 2, 0.44),
          color: "#10b981",
          width: flowWidth(netPortion, 5, 52),
          glow: 0.20,
        });
      }
      if (liability > 0) {
        links.push({
          d: linkPath(grossNode.x + grossNode.w, grossNode.y + grossNode.h / 2 + 8, debtNode.x, debtNode.y + debtNode.h / 2, 0.44),
          color: "#b42318",
          width: flowWidth(liability, 4, 44),
          glow: 0.16,
          dash: "8 5",
        });
      }

      host.innerHTML = `
        <div class="chart-stage">
          <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" class="chart-svg">
            <defs>
              <linearGradient id="wealthSankeyBg" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#fbfdff" />
                <stop offset="100%" stop-color="#f7faff" />
              </linearGradient>
              <radialGradient id="wealthSankeyGlowA" cx="22%" cy="22%" r="70%">
                <stop offset="0%" stop-color="rgba(99,102,241,0.07)" />
                <stop offset="100%" stop-color="rgba(99,102,241,0)" />
              </radialGradient>
              <radialGradient id="wealthSankeyGlowB" cx="72%" cy="60%" r="65%">
                <stop offset="0%" stop-color="rgba(16,185,129,0.06)" />
                <stop offset="100%" stop-color="rgba(16,185,129,0)" />
              </radialGradient>
            </defs>
            <rect x="0.5" y="0.5" width="${width - 1}" height="${height - 1}" rx="14" ry="14" fill="url(#wealthSankeyBg)" stroke="rgba(148,163,184,0.20)" />
            <rect x="0" y="0" width="${width}" height="${height}" rx="14" ry="14" fill="url(#wealthSankeyGlowA)" />
            <rect x="0" y="0" width="${width}" height="${height}" rx="14" ry="14" fill="url(#wealthSankeyGlowB)" />
            <text x="22" y="28" font-size="15.5" fill="#0f172a" font-weight="700">财富关系图</text>

            ${topCards.map(summaryCard).join("")}

            ${links.map(link => `
              <path d="${link.d}" fill="none" stroke="${link.color}" stroke-opacity="${link.glow}" stroke-linecap="round"
                stroke-width="${link.width}" ${link.dash ? `stroke-dasharray="${link.dash}"` : ""} />
              <path d="${link.d}" fill="none" stroke="${link.color}" stroke-opacity="0.72" stroke-linecap="round"
                stroke-width="${Math.max(1.05, link.width * 0.16)}" ${link.dash ? `stroke-dasharray="${link.dash}"` : ""} />
            `).join("")}

            ${categories.map(categoryNodeBox).join("")}
            ${nodeBox(grossNode)}
            ${nodeBox(netNode, { muted: true })}
            ${liability > 0 ? nodeBox(debtNode, { muted: true }) : ""}

            <text x="22" y="${height - 16}" font-size="11" fill="rgba(100,116,139,0.88)">
              说明：总资产由现金 / 不动产 / 投资构成，总资产再拆分为净资产与负债（虚线）。
            </text>
          </svg>
        </div>
      `;

      legend.classList.add("hidden");
      legend.innerHTML = "";
      applyAmountMaskInDom(host);
    }
    async function refreshInvestmentAccounts() {
      const data = await api("/api/meta/accounts?kind=investment");
      state.investmentAccounts = data.investment_accounts || [];
      const accountOptions = state.investmentAccounts
        .map(item => `<option value="${item.account_id}">${item.account_name} (${item.account_id})</option>`)
        .join("");
      const options = state.investmentAccounts.length > 0
        ? `<option value="__portfolio__">全部投资账户（组合）</option>${accountOptions}`
        : "";

      ["retAccountId"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const prev = el.value;
        el.innerHTML = options || `<option value="">暂无投资账户</option>`;
        if (prev && Array.from(el.options).some(opt => opt.value === prev)) {
          el.value = prev;
        }
      });

      await refreshAccountCatalog();

      if (typeof state.refreshReturnAnalytics === "function") {
        await state.refreshReturnAnalytics({ silent: true });
      }
      if (typeof state.refreshReturnBatchAnalytics === "function") {
        await state.refreshReturnBatchAnalytics({ silent: true });
      }
      if (typeof state.refreshWealthAnalytics === "function") {
        await state.refreshWealthAnalytics({ silent: true });
      }
    }

    async function initImportActions() {
      const emlFiles = document.getElementById("emlFiles");
      const emlThreshold = document.getElementById("emlThreshold");
      const emlStatus = document.getElementById("emlStatus");
      const emlMetrics = document.getElementById("emlMetrics");
      const emlErrorsWrap = document.getElementById("emlErrorsWrap");
      const emlErrorsBody = document.getElementById("emlErrorsBody");

      document.getElementById("emlPreviewBtn").addEventListener("click", async () => {
        try {
          const files = await collectFiles(emlFiles);
          if (files.length === 0) throw new Error("请至少选择一个 .eml 文件");
          const data = await api("/api/eml/preview", "POST", {
            files,
            review_threshold: Number(emlThreshold.value || 0.7),
          });
          state.emlPreviewToken = data.preview_token;
          setStatus(emlStatus, true, "EML 预览完成，可确认导入。");
          showMetrics(emlMetrics, [
            { k: "文件数", v: data.summary.input_files_count },
            { k: "交易数", v: data.summary.records_count },
            { k: "消费笔数", v: data.summary.consume_count },
            { k: "待确认", v: data.summary.needs_review_count },
          ]);
          const errors = data.summary.failed_files || [];
          if (errors.length > 0) {
            emlErrorsWrap.classList.remove("hidden");
            emlErrorsBody.innerHTML = errors.map(e => `<tr><td>${e.file}</td><td>${e.error}</td></tr>`).join("");
          } else {
            hide(emlErrorsWrap);
          }
        } catch (err) {
          setStatus(emlStatus, false, err.message || String(err));
          hide(emlMetrics);
        }
      });

      document.getElementById("emlImportBtn").addEventListener("click", async () => {
        try {
          if (!state.emlPreviewToken) throw new Error("请先做 EML 预览。");
          const data = await api("/api/eml/import", "POST", {
            preview_token: state.emlPreviewToken,
            review_threshold: Number(emlThreshold.value || 0.7),
          });
          setStatus(
            emlStatus,
            true,
            `EML 导入成功：交易 ${data.imported_count} 条，失败 ${data.import_error_count} 条，任务ID ${data.import_job_id}`
          );
          await refreshAccountCatalog();
        } catch (err) {
          setStatus(emlStatus, false, err.message || String(err));
        }
      });

      const yzxyCsvFile = document.getElementById("yzxyCsvFile");
      const yzxyStatus = document.getElementById("yzxyStatus");
      const yzxyMetrics = document.getElementById("yzxyMetrics");
      const yzxyErrorsWrap = document.getElementById("yzxyErrorsWrap");
      const yzxyErrorsBody = document.getElementById("yzxyErrorsBody");

      document.getElementById("yzxyPreviewBtn").addEventListener("click", async () => {
        try {
          const files = await collectFiles(yzxyCsvFile);
          if (files.length !== 1) throw new Error("请只选择一个 CSV 或 XLSX 文件");
          const data = await api("/api/yzxy/preview", "POST", { file: files[0] });
          state.yzxyPreviewToken = data.preview_token;
          setStatus(yzxyStatus, true, "文件预览完成，可确认导入。");
          showMetrics(yzxyMetrics, [
            { k: "解析成功", v: data.preview.parsed_count },
            { k: "错误数", v: data.preview.error_count },
            { k: "映射列数", v: Object.keys(data.preview.mapping || {}).length },
            { k: "预览行", v: (data.preview.preview_rows || []).length },
          ]);
          const errors = data.preview.errors || [];
          if (errors.length > 0) {
            yzxyErrorsWrap.classList.remove("hidden");
            yzxyErrorsBody.innerHTML = errors.map(e => `<tr><td>${e}</td></tr>`).join("");
          } else {
            hide(yzxyErrorsWrap);
          }
        } catch (err) {
          setStatus(yzxyStatus, false, err.message || String(err));
          hide(yzxyMetrics);
        }
      });

      document.getElementById("yzxyImportBtn").addEventListener("click", async () => {
        try {
          if (!state.yzxyPreviewToken) throw new Error("请先做文件预览。");
          const data = await api("/api/yzxy/import", "POST", { preview_token: state.yzxyPreviewToken });
          setStatus(
            yzxyStatus,
            true,
            `导入成功：记录 ${data.imported_count} 条，失败 ${data.error_count} 条，任务ID ${data.import_job_id}`
          );
          await refreshInvestmentAccounts();
        } catch (err) {
          setStatus(yzxyStatus, false, err.message || String(err));
        }
      });
    }

    function initRecordActions() {
      const invStatus = document.getElementById("invStatus");
      const invSaveBtn = document.getElementById("invSaveBtn");
      const invCancelEditBtn = document.getElementById("invCancelEditBtn");
      const invEditHint = document.getElementById("invEditHint");
      const invAccountIdEl = document.getElementById("invAccountId");
      const invSnapshotDateEl = document.getElementById("invSnapshotDate");
      const invTotalAssetsEl = document.getElementById("invTotalAssets");
      const invTransferAmountEl = document.getElementById("invTransferAmount");

      function setInvestmentEditMode(record) {
        state.editingInvestmentRecord = record || null;
        const editing = !!state.editingInvestmentRecord;
        invSaveBtn.textContent = editing ? "更新投资记录" : "保存投资记录";
        invCancelEditBtn.classList.toggle("hidden", !editing);
        invEditHint.classList.toggle("hidden", !editing);
      }

      function clearInvestmentEditMode() {
        setInvestmentEditMode(null);
      }

      function fillInvestmentFormFromRow(row) {
        invAccountIdEl.value = row.account_id || "";
        invSnapshotDateEl.value = row.snapshot_date || "";
        invTotalAssetsEl.value = money(row.total_assets_cents || 0);
        invTransferAmountEl.value = money(row.transfer_amount_cents || 0);
      }

      state.startEditInvestmentRecord = (row) => {
        if (!row || !row.id) return;
        fillInvestmentFormFromRow(row);
        setInvestmentEditMode(row);
        openTab("tab-records");
        setStatus(invStatus, true, `已载入投资记录编辑：${row.account_name || row.account_id} ${row.snapshot_date}`);
      };

      invCancelEditBtn.addEventListener("click", () => {
        clearInvestmentEditMode();
        setStatus(invStatus, true, "已退出投资记录编辑模式");
      });

      invSaveBtn.addEventListener("click", async () => {
        try {
          const accountId = invAccountIdEl.value.trim();
          if (!accountId) throw new Error("请先在账户管理中创建并选择投资账户");
          const basePayload = {
            account_id: accountId,
            snapshot_date: invSnapshotDateEl.value.trim(),
            total_assets: invTotalAssetsEl.value.trim(),
            transfer_amount: invTransferAmountEl.value.trim(),
          };
          let data;
          if (state.editingInvestmentRecord && state.editingInvestmentRecord.id) {
            data = await api("/api/investments/update", "POST", {
              id: state.editingInvestmentRecord.id,
              ...basePayload,
            });
            setStatus(invStatus, true, `投资记录已更新：${data.account_name} ${data.snapshot_date}`);
            clearInvestmentEditMode();
          } else {
            data = await api("/api/investments/manual", "POST", basePayload);
            setStatus(invStatus, true, `投资记录已保存：${data.account_name} ${data.snapshot_date}`);
          }
          await refreshInvestmentAccounts();
          if (typeof state.refreshInvestmentQuery === "function") {
            await state.refreshInvestmentQuery({ silent: true });
          }
        } catch (err) {
          setStatus(invStatus, false, err.message || String(err));
        }
      });

      const assetStatus = document.getElementById("assetStatus");
      const assetSaveBtn = document.getElementById("assetSaveBtn");
      const assetCancelEditBtn = document.getElementById("assetCancelEditBtn");
      const assetEditHint = document.getElementById("assetEditHint");
      const assetClassEl = document.getElementById("assetClass");
      const assetAccountIdEl = document.getElementById("assetAccountId");
      const assetSnapshotDateEl = document.getElementById("assetSnapshotDate");
      const assetValueEl = document.getElementById("assetValue");
      assetClassEl.addEventListener("change", () => {
        refreshAccountSelectorsFromCatalog();
      });

      function setAssetEditMode(record) {
        state.editingAssetRecord = record || null;
        const editing = !!state.editingAssetRecord;
        assetSaveBtn.textContent = editing ? "更新资产记录" : "保存资产记录";
        assetCancelEditBtn.classList.toggle("hidden", !editing);
        assetEditHint.classList.toggle("hidden", !editing);
      }

      function clearAssetEditMode() {
        setAssetEditMode(null);
      }

      function fillAssetFormFromRow(row) {
        assetClassEl.value = row.asset_class || "cash";
        refreshAccountSelectorsFromCatalog();
        assetAccountIdEl.value = row.account_id || "";
        assetSnapshotDateEl.value = row.snapshot_date || "";
        assetValueEl.value = money(row.value_cents || 0);
      }

      state.startEditAssetRecord = (row) => {
        if (!row || !row.id) return;
        fillAssetFormFromRow(row);
        setAssetEditMode(row);
        openTab("tab-records");
        setStatus(assetStatus, true, `已载入资产记录编辑：${row.account_name || row.account_id} ${row.snapshot_date}`);
      };

      assetCancelEditBtn.addEventListener("click", () => {
        clearAssetEditMode();
        setStatus(assetStatus, true, "已退出资产记录编辑模式");
      });

      assetSaveBtn.addEventListener("click", async () => {
        try {
          const accountId = assetAccountIdEl.value.trim();
          if (!accountId) throw new Error("请先在账户管理中创建并选择对应资产账户");
          const payload = {
            asset_class: assetClassEl.value,
            account_id: accountId,
            snapshot_date: assetSnapshotDateEl.value.trim(),
            value: assetValueEl.value.trim(),
          };
          let data;
          if (state.editingAssetRecord && state.editingAssetRecord.id) {
            data = await api("/api/assets/update", "POST", {
              id: state.editingAssetRecord.id,
              ...payload,
            });
            setStatus(assetStatus, true, `资产记录已更新：${data.account_name} ${data.snapshot_date}`);
            clearAssetEditMode();
          } else {
            data = await api("/api/assets/manual", "POST", payload);
            setStatus(assetStatus, true, `资产记录已保存：${data.account_name} ${data.snapshot_date}`);
          }
          if (typeof state.refreshWealthAnalytics === "function") {
            await state.refreshWealthAnalytics({ silent: true });
          }
          if (typeof state.refreshAssetQuery === "function") {
            await state.refreshAssetQuery({ silent: true });
          }
        } catch (err) {
          setStatus(assetStatus, false, err.message || String(err));
        }
      });
    }

    function buildPresetParams(prefix) {
      return {
        preset: document.getElementById(`${prefix}Preset`).value,
        from: document.getElementById(`${prefix}From`).value.trim(),
        to: document.getElementById(`${prefix}To`).value.trim(),
      };
    }

    function readWealthFilters() {
      const buttons = Array.from(document.querySelectorAll("#wealthAssetFilters .pill-tab"));
      const filters = {
        include_investment: true,
        include_cash: true,
        include_real_estate: true,
        include_liability: true,
      };
      buttons.forEach(btn => {
        const key = btn.getAttribute("data-key");
        if (!key || !(key in filters)) return;
        filters[key] = btn.classList.contains("active");
      });
      return filters;
    }

    function toQueryBool(raw) {
      return raw ? "true" : "false";
    }

    function initReturnAnalytics() {
      const retStatus = document.getElementById("retStatus");
      const retMetrics = document.getElementById("retMetrics");
      const retFlowWrap = document.getElementById("retFlowWrap");
      const retFlowBody = document.getElementById("retFlowBody");
      const retBatchMetrics = document.getElementById("retBatchMetrics");
      const retBatchWrap = document.getElementById("retBatchWrap");
      const retBatchBody = document.getElementById("retBatchBody");
      const retAccountId = document.getElementById("retAccountId");
      const retPreset = document.getElementById("retPreset");
      const retFrom = document.getElementById("retFrom");
      const retTo = document.getElementById("retTo");
      const retChartAssetView = document.getElementById("retChartAssetView");
      const retChartReturnView = document.getElementById("retChartReturnView");
      const retChartGrowthView = document.getElementById("retChartGrowthView");
      const retTabButtons = Array.from(document.querySelectorAll("#retChartTabs .pill-tab"));

      let latestRequestId = 0;
      let latestBatchRequestId = 0;

      function setReturnChartView(view) {
        const views = {
          asset: retChartAssetView,
          return: retChartReturnView,
          growth: retChartGrowthView,
        };
        Object.entries(views).forEach(([key, el]) => {
          if (!el) return;
          el.classList.toggle("hidden", key !== view);
        });
        retTabButtons.forEach(btn => {
          btn.classList.toggle("active", btn.getAttribute("data-view") === view);
        });
      }

      function applyReturnPresetState() {
        const isCustom = retPreset.value === "custom";
        retFrom.disabled = !isCustom;
        if (!isCustom) retFrom.value = "";
      }

      function clearReturnVisuals() {
        hide(retMetrics);
        hide(retFlowWrap);
        renderLineChart("retCurveChart", "retCurveLegend", [], [
          { key: "total_assets_cents", color: "#0f766e", label: "总资产" },
        ]);
        renderLineChart("retRateChart", "retRateLegend", [], [
          { key: "cumulative_return_pct", color: "#b45309", label: "累计收益率(%)" },
        ]);
        renderLineChart("retGrowthChart", "retGrowthLegend", [], [
          { key: "cumulative_net_growth_cents", color: "#2f6db4", label: "净增长资金" },
        ]);
      }

      function clearReturnBatchVisuals() {
        hide(retBatchMetrics);
        hide(retBatchWrap);
        retBatchBody.innerHTML = "";
      }

      async function refreshReturnAnalytics(options = {}) {
        const { silent = false } = options;
        const requestId = ++latestRequestId;
        try {
          const accountId = retAccountId.value;
          if (!accountId) {
            clearReturnVisuals();
            if (!silent) setStatus(retStatus, false, "请先选择投资账户");
            return;
          }
          if (retPreset.value === "custom" && !retFrom.value.trim()) {
            clearReturnVisuals();
            if (!silent) setStatus(retStatus, false, "自定义区间需要填写开始日期");
            return;
          }

          const params = new URLSearchParams({ account_id: accountId, ...buildPresetParams("ret") });
          const [retData, curveData] = await Promise.all([
            api(`/api/analytics/investment-return?${params.toString()}`),
            api(`/api/analytics/investment-curve?${params.toString()}`),
          ]);
          if (requestId !== latestRequestId) return;

          const targetLabel = retData.account_count ? `组合（${retData.account_count}个账户）` : (retData.account_name || "-");
          showMetrics(retMetrics, [
            { k: "分析对象", v: targetLabel },
            { k: "区间收益率", v: retData.metrics.return_rate_pct || "-" },
            { k: "年化收益率", v: retData.metrics.annualized_rate_pct || "-" },
            { k: "净增长资金(元)", v: retData.metrics.net_growth_yuan || retData.metrics.profit_yuan },
            { k: "曲线点位数", v: curveData.summary.count ?? curveData.range?.points ?? "-", amount: false },
            { k: "起点总资产(元)", v: curveData.summary.start_assets_yuan || "-" },
            { k: "终点总资产(元)", v: curveData.summary.end_assets_yuan || "-" },
            { k: "资产涨跌额(元)", v: curveData.summary.change_yuan || "-" },
            { k: "资产涨跌幅", v: curveData.summary.change_pct_text || "-", amount: false },
          ]);

          const flows = retData.cash_flows || [];
          if (flows.length > 0) {
            retFlowWrap.classList.remove("hidden");
            retFlowBody.innerHTML = flows.map(flow => `
              <tr>
                <td>${flow.snapshot_date}</td>
                <td>${renderAmountValue(flow.transfer_amount_yuan)}</td>
                <td>${flow.weight.toFixed(4)}</td>
              </tr>
            `).join("");
            applyAmountMaskInDom(retFlowWrap);
          } else {
            hide(retFlowWrap);
          }

          renderLineChart("retCurveChart", "retCurveLegend", curveData.rows || [], [
            {
              key: "total_assets_cents",
              color: "#0f766e",
              label: "总资产",
              formatValue: (val) => renderAmountValue(`${money(val)} 元`),
            },
          ], {
            includeZero: false,
            yTickCount: 4,
            yAxisFormatter: (val) => (shouldMaskAmounts() ? "****" : `${formatYuanShortFromCents(val)}元`),
            tooltipTitle: (row) =>
              row.effective_snapshot_date && row.effective_snapshot_date !== row.snapshot_date
                ? `${row.snapshot_date}（按${row.effective_snapshot_date}快照）`
                : (row.snapshot_date || ""),
          });
          renderLineChart("retRateChart", "retRateLegend", curveData.rows || [], [
            {
              key: "cumulative_return_pct",
              color: "#b45309",
              label: "累计收益率(%)",
              formatValue: (val) => `${Number(val).toFixed(2)}%`,
            },
          ], {
            includeZero: true,
            yTickCount: 4,
            yAxisFormatter: (val) => `${Number(val).toFixed(1)}%`,
            referenceLines: buildReturnReferenceLines(curveData.rows || []),
            tooltipTitle: (row) =>
              row.effective_snapshot_date && row.effective_snapshot_date !== row.snapshot_date
                ? `${row.snapshot_date}（按${row.effective_snapshot_date}快照）`
                : (row.snapshot_date || ""),
          });
          renderLineChart("retGrowthChart", "retGrowthLegend", curveData.rows || [], [
            {
              key: "cumulative_net_growth_cents",
              color: "#2f6db4",
              label: "净增长资金",
              formatValue: (val) => renderAmountValue(`${money(val)} 元`),
            },
          ], {
            includeZero: true,
            yTickCount: 4,
            yAxisFormatter: (val) => (shouldMaskAmounts() ? "****" : `${formatYuanShortFromCents(val)}元`),
            referenceLines: [{ value: 0, label: shouldMaskAmounts() ? "****" : "0元", color: "#9ca3af" }],
            tooltipTitle: (row) =>
              row.effective_snapshot_date && row.effective_snapshot_date !== row.snapshot_date
                ? `${row.snapshot_date}（按${row.effective_snapshot_date}快照）`
                : (row.snapshot_date || ""),
          });

          if (!silent) {
            setStatus(
              retStatus,
              true,
              `已自动更新：${targetLabel}，区间 ${retData.range.effective_from} ~ ${retData.range.effective_to}`
            );
          }
        } catch (err) {
          if (requestId !== latestRequestId) return;
          clearReturnVisuals();
          setStatus(retStatus, false, err.message || String(err));
        }
      }

      async function refreshReturnBatchAnalytics(options = {}) {
        const { silent = false } = options;
        const requestId = ++latestBatchRequestId;
        try {
          if (retPreset.value === "custom" && !retFrom.value.trim()) {
            clearReturnBatchVisuals();
            if (!silent) setStatus(retStatus, false, "自定义区间需要填写开始日期");
            return;
          }

          const params = new URLSearchParams(buildPresetParams("ret"));
          const data = await api(`/api/analytics/investment-returns?${params.toString()}`);
          if (requestId !== latestBatchRequestId) return;

          showMetrics(retBatchMetrics, [
            { k: "参与账户", v: data.summary.account_count },
            { k: "可计算账户", v: data.summary.computed_count },
            { k: "异常账户", v: data.summary.error_count },
            { k: "平均收益率", v: data.summary.avg_return_pct || "-" },
          ]);

          retBatchWrap.classList.remove("hidden");
          const rows = data.rows || [];
          if (rows.length === 0) {
            retBatchBody.innerHTML = `<tr><td colspan="7">当前区间暂无可计算账户</td></tr>`;
          } else {
            retBatchBody.innerHTML = rows.map(row => `
              <tr>
                <td>${row.account_name || row.account_id}</td>
                <td>${row.return_rate_pct || "-"}</td>
                <td>${row.annualized_rate_pct || "-"}</td>
                <td>${renderAmountValue(row.profit_yuan)}</td>
                <td>${renderAmountValue(row.net_flow_yuan)}</td>
                <td>${row.effective_from} ~ ${row.effective_to}</td>
                <td>${row.interval_days}</td>
              </tr>
            `).join("");
          }
          applyAmountMaskInDom(retBatchWrap);

          if (!silent) {
            if (data.summary.error_count > 0) {
              setStatus(
                retStatus,
                false,
                `对比已更新：可计算 ${data.summary.computed_count} 个，异常 ${data.summary.error_count} 个`
              );
            } else {
              setStatus(retStatus, true, `账户收益率对比已更新：${data.summary.computed_count} 个账户`);
            }
          }
        } catch (err) {
          if (requestId !== latestBatchRequestId) return;
          clearReturnBatchVisuals();
          setStatus(retStatus, false, err.message || String(err));
        }
      }

      async function refreshAllReturnAnalytics(options = {}) {
        const { silent = false } = options;
        await Promise.all([
          refreshReturnAnalytics({ silent }),
          refreshReturnBatchAnalytics({ silent: true }),
        ]);
      }

      state.refreshReturnAnalytics = refreshReturnAnalytics;
      state.refreshReturnBatchAnalytics = refreshReturnBatchAnalytics;

      retTabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          setReturnChartView(btn.getAttribute("data-view") || "asset");
        });
      });
      setReturnChartView("asset");

      retAccountId.addEventListener("change", () => {
        refreshReturnAnalytics({ silent: false });
      });
      retPreset.addEventListener("change", () => {
        applyReturnPresetState();
        refreshAllReturnAnalytics({ silent: false });
      });
      retFrom.addEventListener("change", () => {
        refreshAllReturnAnalytics({ silent: false });
      });
      retTo.addEventListener("change", () => {
        refreshAllReturnAnalytics({ silent: false });
      });
      document.getElementById("retBatchBtn").addEventListener("click", async () => {
        await refreshReturnBatchAnalytics({ silent: false });
      });

      document.getElementById("retRefreshAccountsBtn").addEventListener("click", async () => {
        try {
          await refreshInvestmentAccounts();
          setStatus(retStatus, true, "投资账户列表已刷新并自动更新收益分析与账户对比");
        } catch (err) {
          setStatus(retStatus, false, err.message || String(err));
        }
      });

      applyReturnPresetState();
      refreshReturnBatchAnalytics({ silent: true });
    }

    function initWealth() {
      const wealthStatus = document.getElementById("wealthStatus");
      const wealthCurvePreset = document.getElementById("wealthCurvePreset");
      const wealthFilterButtons = Array.from(document.querySelectorAll("#wealthAssetFilters .pill-tab"));

      let latestOverviewRequestId = 0;
      let latestCurveRequestId = 0;

      function setFilterButtonState(btn, enabled) {
        btn.classList.toggle("active", enabled);
        btn.setAttribute("aria-pressed", enabled ? "true" : "false");
      }

      function hasAnyFilterEnabled(filters) {
        return (
          filters.include_investment
          || filters.include_cash
          || filters.include_real_estate
          || filters.include_liability
        );
      }

      function serializeFilterParams(filters) {
        return {
          include_investment: toQueryBool(filters.include_investment),
          include_cash: toQueryBool(filters.include_cash),
          include_real_estate: toQueryBool(filters.include_real_estate),
          include_liability: toQueryBool(filters.include_liability),
        };
      }

      function wealthPresetLabel(preset) {
        if (preset === "since_inception") return "成立以来";
        if (preset === "1y") return "近一年";
        if (preset === "ytd") return "YTD";
        return preset || "-";
      }

      function clearWealthOverviewVisuals() {
        renderWealthSankeyChart("wealthGrowthChart", "wealthGrowthLegend", null, {});
      }

      function clearWealthCurveVisuals() {
        renderWealthStackedTrendChart("wealthCurveChart", "wealthCurveLegend", [], {});
      }

      async function refreshWealthOverview(options = {}) {
        const { silent = false } = options;
        const requestId = ++latestOverviewRequestId;
        try {
          const filters = readWealthFilters();
          if (!hasAnyFilterEnabled(filters)) {
            clearWealthOverviewVisuals();
            if (!silent) setStatus(wealthStatus, false, "至少需要选择一个资产类型");
            return;
          }

          const params = new URLSearchParams({
            ...serializeFilterParams(filters),
          });
          const data = await api(`/api/analytics/wealth-overview?${params.toString()}`);
          if (requestId !== latestOverviewRequestId) return;
          renderWealthSankeyChart("wealthGrowthChart", "wealthGrowthLegend", data, filters);

          if (!silent) {
            setStatus(wealthStatus, true, `财富结构关系图已更新（as_of: ${data.as_of}）`);
          }
        } catch (err) {
          if (requestId !== latestOverviewRequestId) return;
          clearWealthOverviewVisuals();
          setStatus(wealthStatus, false, err.message || String(err));
        }
      }

      async function refreshWealthCurve(options = {}) {
        const { silent = false } = options;
        const requestId = ++latestCurveRequestId;
        try {
          const filters = readWealthFilters();
          if (!hasAnyFilterEnabled(filters)) {
            clearWealthCurveVisuals();
            if (!silent) setStatus(wealthStatus, false, "至少需要选择一个资产类型");
            return;
          }

          const params = new URLSearchParams({
            preset: wealthCurvePreset ? wealthCurvePreset.value : "since_inception",
            ...serializeFilterParams(filters),
          });
          const data = await api(`/api/analytics/wealth-curve?${params.toString()}`);
          if (requestId !== latestCurveRequestId) return;
          renderWealthStackedTrendChart("wealthCurveChart", "wealthCurveLegend", data.rows || [], filters);

          if (!silent) {
            const presetText = wealthPresetLabel(wealthCurvePreset ? wealthCurvePreset.value : data.range.preset);
            setStatus(
              wealthStatus,
              true,
              `资产趋势已更新（${presetText}）：${data.range.effective_from} ~ ${data.range.effective_to}`
            );
          }
        } catch (err) {
          if (requestId !== latestCurveRequestId) return;
          clearWealthCurveVisuals();
          setStatus(wealthStatus, false, err.message || String(err));
        }
      }

      async function refreshWealthAnalytics(options = {}) {
        const { silent = true } = options;
        await Promise.all([
          refreshWealthOverview({ silent }),
          refreshWealthCurve({ silent }),
        ]);
      }

      state.refreshWealthAnalytics = refreshWealthAnalytics;

      wealthFilterButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const isEnabled = btn.classList.contains("active");
          const activeCount = wealthFilterButtons.filter(item => item.classList.contains("active")).length;
          if (isEnabled && activeCount <= 1) {
            setStatus(wealthStatus, false, "至少需要选择一个资产类型");
            return;
          }
          setFilterButtonState(btn, !isEnabled);
          refreshWealthAnalytics({ silent: true });
        });
      });

      if (wealthCurvePreset) {
        wealthCurvePreset.addEventListener("change", () => {
          refreshWealthCurve({ silent: true });
        });
      }

      refreshWealthAnalytics({ silent: true });
    }

    function initBudget() {
      const budgetStatus = document.getElementById("budgetStatus");
      const budgetYear = document.getElementById("budgetYear");
      const budgetSummaryMetrics = document.getElementById("budgetSummaryMetrics");
      const fireMetrics = document.getElementById("fireMetrics");
      const budgetMonthlyReviewMetrics = document.getElementById("budgetMonthlyReviewMetrics");
      const budgetMonthlyReviewWrap = document.getElementById("budgetMonthlyReviewWrap");
      const budgetMonthlyReviewBody = document.getElementById("budgetMonthlyReviewBody");

      const budgetItemsStatus = document.getElementById("budgetItemsStatus");
      const budgetItemsMetrics = document.getElementById("budgetItemsMetrics");
      const budgetItemsWrap = document.getElementById("budgetItemsWrap");
      const budgetItemsBody = document.getElementById("budgetItemsBody");
      const budgetItemName = document.getElementById("budgetItemName");
      const budgetItemMonthlyAmount = document.getElementById("budgetItemMonthlyAmount");
      const budgetItemSortOrder = document.getElementById("budgetItemSortOrder");
      const budgetItemIsActive = document.getElementById("budgetItemIsActive");
      const budgetItemEditingId = document.getElementById("budgetItemEditingId");
      const budgetItemEditHint = document.getElementById("budgetItemEditHint");
      const budgetItemSaveBtn = document.getElementById("budgetItemSaveBtn");
      const budgetItemCancelEditBtn = document.getElementById("budgetItemCancelEditBtn");
      const budgetItemRefreshBtn = document.getElementById("budgetItemRefreshBtn");
      const budgetRefreshBtn = document.getElementById("budgetRefreshBtn");
      const budgetWithdrawalRatePct = document.getElementById("budgetWithdrawalRatePct");

      if (!budgetYear) return;
      if (!budgetYear.value) budgetYear.value = String(new Date().getFullYear());
      if (budgetWithdrawalRatePct) {
        let restored = "";
        try {
          restored = String(window.localStorage.getItem(BUDGET_WITHDRAWAL_RATE_PCT_STORAGE_KEY) || "").trim();
        } catch {}
        const restoredNum = Number(restored);
        if (restored && Number.isFinite(restoredNum) && restoredNum > 0 && restoredNum < 100) {
          budgetWithdrawalRatePct.value = restoredNum.toFixed(2);
        } else if (!budgetWithdrawalRatePct.value) {
          budgetWithdrawalRatePct.value = "4.00";
        }
      }

      let latestBudgetOverviewReq = 0;
      let latestFireReq = 0;
      let latestBudgetItemsReq = 0;

      function clearBudgetItemEditMode() {
        state.editingBudgetItem = null;
        budgetItemEditingId.textContent = "-";
        budgetItemEditHint.classList.add("hidden");
        budgetItemCancelEditBtn.classList.add("hidden");
        budgetItemSaveBtn.textContent = "保存预算项";
        budgetItemName.value = "";
        budgetItemMonthlyAmount.value = "0";
        budgetItemSortOrder.value = "1000";
        budgetItemIsActive.value = "true";
      }

      function setBudgetItemEditMode(row) {
        state.editingBudgetItem = row;
        budgetItemEditingId.textContent = String(row.id || "-");
        budgetItemEditHint.classList.remove("hidden");
        budgetItemCancelEditBtn.classList.remove("hidden");
        budgetItemSaveBtn.textContent = "更新预算项";
        budgetItemName.value = String(row.name || "");
        budgetItemMonthlyAmount.value = Number(row.monthly_amount_yuan || 0);
        budgetItemSortOrder.value = String(row.sort_order ?? 1000);
        budgetItemIsActive.value = row.is_active ? "true" : "false";
      }

      function getSelectedBudgetYear() {
        const value = String(budgetYear.value || "").trim();
        const yearNum = Number(value);
        if (!Number.isFinite(yearNum) || yearNum < 2000 || yearNum > 2100) {
          return new Date().getFullYear();
        }
        return Math.trunc(yearNum);
      }

      function getWithdrawalRateDecimal() {
        const raw = String(budgetWithdrawalRatePct ? budgetWithdrawalRatePct.value : "4").trim();
        const pctNum = Number(raw);
        if (!Number.isFinite(pctNum) || pctNum <= 0 || pctNum >= 100) {
          throw new Error("提取率必须在 0 到 100 之间（百分比）");
        }
        try {
          window.localStorage.setItem(BUDGET_WITHDRAWAL_RATE_PCT_STORAGE_KEY, pctNum.toFixed(2));
        } catch {}
        return pctNum / 100;
      }

      async function refreshBudgetItems(options = {}) {
        const { silent = true } = options;
        const reqId = ++latestBudgetItemsReq;
        try {
          const data = await api("/api/budgets/monthly-items");
          if (reqId !== latestBudgetItemsReq) return;

          showMetrics(budgetItemsMetrics, [
            { k: "预算项总数", v: data.summary.total_count, amount: false },
            { k: "启用预算项", v: data.summary.active_count, amount: false },
            { k: "月度预算总额(元)", v: data.summary.monthly_budget_total_yuan },
            { k: "年度预算(元)", v: data.summary.annual_budget_yuan },
          ]);

          budgetItemsWrap.classList.remove("hidden");
          budgetItemsBody.innerHTML = (data.rows || []).map(row => `
            <tr data-budget-item-id="${row.id}">
              <td>${escapeHtml(row.name)}</td>
              <td>${renderAmountValue(row.monthly_amount_yuan)}</td>
              <td>${renderAmountValue(row.annual_amount_yuan)}</td>
              <td>${row.is_active ? "启用" : "停用"}</td>
              <td>${row.is_builtin ? "内置" : "自定义"}</td>
              <td>
                <button class="btn secondary js-budget-edit" type="button">编辑</button>
                <button class="btn danger js-budget-delete" type="button">删除</button>
              </td>
            </tr>
          `).join("");
          applyAmountMaskInDom(budgetItemsWrap);
          state.budgetItemsRows = data.rows || [];
          if (!silent) setStatus(budgetItemsStatus, true, "预算项已刷新");
        } catch (err) {
          if (reqId !== latestBudgetItemsReq) return;
          hide(budgetItemsMetrics);
          hide(budgetItemsWrap);
          budgetItemsBody.innerHTML = "";
          setStatus(budgetItemsStatus, false, err.message || String(err));
        }
      }

      async function refreshBudgetOverview(options = {}) {
        const { silent = true } = options;
        const reqId = ++latestBudgetOverviewReq;
        try {
          const year = getSelectedBudgetYear();
          const data = await api(`/api/analytics/budget-overview?year=${encodeURIComponent(year)}`);
          if (reqId !== latestBudgetOverviewReq) return;
          showMetrics(budgetSummaryMetrics, [
            { k: "预算年度", v: data.year, amount: false },
            { k: "月度预算总额(元)", v: data.budget.monthly_total_yuan },
            { k: "年度预算(元)", v: data.budget.annual_total_yuan },
            { k: "实际消费累计(元)", v: data.actual.spent_total_yuan },
            { k: "剩余预算(元)", v: data.metrics.annual_remaining_yuan },
            { k: "达成率/使用率", v: data.metrics.usage_rate_pct_text, amount: false },
            { k: "YTD预算(元)", v: data.budget.ytd_budget_yuan },
            { k: "YTD实际(元)", v: data.actual.ytd_spent_yuan },
            { k: "YTD偏差(元)", v: data.metrics.ytd_variance_yuan },
            { k: "已过月份", v: data.analysis_scope.elapsed_months, amount: false },
          ]);
          if (!silent) {
            setStatus(budgetStatus, true, `预算总览已更新（${data.year}年，as_of: ${data.as_of_date}）`);
          }
        } catch (err) {
          if (reqId !== latestBudgetOverviewReq) return;
          hide(budgetSummaryMetrics);
          setStatus(budgetStatus, false, err.message || String(err));
        }
      }

      async function refreshFireProgress(options = {}) {
        const { silent = true } = options;
        const reqId = ++latestFireReq;
        try {
          const year = getSelectedBudgetYear();
          const withdrawalRate = getWithdrawalRateDecimal();
          const data = await api(
            `/api/analytics/fire-progress?year=${encodeURIComponent(year)}&withdrawal_rate=${encodeURIComponent(withdrawalRate)}`
          );
          if (reqId !== latestFireReq) return;
          showMetrics(fireMetrics, [
            { k: "可投资资产(元)", v: data.investable_assets.total_yuan },
            { k: "其中投资(元)", v: data.investable_assets.investment_yuan },
            { k: "其中现金(元)", v: data.investable_assets.cash_yuan },
            { k: "FIRE目标资产(元)", v: data.metrics.required_assets_yuan },
            { k: "与目标差额(元)", v: data.metrics.goal_gap_yuan },
            { k: "尚需资产(元)", v: data.metrics.remaining_to_goal_yuan },
            { k: "覆盖年数", v: data.metrics.coverage_years_text || "-", amount: false },
            { k: "财务自由度", v: data.metrics.freedom_ratio_pct_text || "-", amount: false },
            { k: "提取率", v: data.withdrawal_rate_pct_text, amount: false },
            { k: "资产快照日期", v: data.investable_assets.as_of, amount: false },
          ]);
          if (!silent && budgetStatus.classList.contains("hidden")) {
            setStatus(budgetStatus, true, `FIRE 指标已更新（${data.year}年）`);
          }
        } catch (err) {
          if (reqId !== latestFireReq) return;
          hide(fireMetrics);
          setStatus(budgetStatus, false, err.message || String(err));
        }
      }

      async function refreshBudgetMonthlyReview(options = {}) {
        const { silent = true } = options;
        try {
          const year = getSelectedBudgetYear();
          const data = await api(`/api/analytics/budget-monthly-review?year=${encodeURIComponent(year)}`);
          showMetrics(budgetMonthlyReviewMetrics, [
            { k: "月度预算(元)", v: data.summary.monthly_budget_yuan },
            { k: "年度预算(元)", v: data.summary.annual_budget_yuan },
            { k: "年度实际消费(元)", v: data.summary.annual_spent_yuan },
            { k: "年度差额(元)", v: data.summary.annual_variance_yuan },
            { k: "年度达成率", v: data.summary.annual_usage_rate_pct_text, amount: false },
            { k: "超预算月份", v: data.summary.over_budget_months, amount: false },
            { k: "低于预算月份", v: data.summary.under_budget_months, amount: false },
            { k: "持平月份", v: data.summary.equal_months, amount: false },
          ]);
          budgetMonthlyReviewWrap.classList.remove("hidden");
          budgetMonthlyReviewBody.innerHTML = (data.rows || []).map(row => `
            <tr>
              <td>${escapeHtml(row.month_key)}</td>
              <td>${renderAmountValue(row.budget_yuan)}</td>
              <td>${renderAmountValue(row.spent_yuan)}</td>
              <td>${renderAmountValue(row.variance_yuan)}</td>
              <td>${escapeHtml(row.usage_rate_pct_text || "-")}</td>
              <td>${escapeHtml(String(row.tx_count || 0))}</td>
              <td>${escapeHtml(row.status || "-")}</td>
            </tr>
          `).join("");
          applyAmountMaskInDom(budgetMonthlyReviewWrap);
          if (!silent && budgetStatus.classList.contains("hidden")) {
            setStatus(budgetStatus, true, `月度复盘已更新（${data.year}年）`);
          }
        } catch (err) {
          hide(budgetMonthlyReviewMetrics);
          hide(budgetMonthlyReviewWrap);
          budgetMonthlyReviewBody.innerHTML = "";
          setStatus(budgetStatus, false, err.message || String(err));
        }
      }

      async function refreshBudgetAnalytics(options = {}) {
        const { silent = true } = options;
        await Promise.all([
          refreshBudgetItems({ silent }),
          refreshBudgetOverview({ silent }),
          refreshFireProgress({ silent }),
          refreshBudgetMonthlyReview({ silent }),
        ]);
      }

      state.refreshBudgetAnalytics = refreshBudgetAnalytics;

      budgetItemSaveBtn.addEventListener("click", async () => {
        try {
          const name = String(budgetItemName.value || "").trim();
          if (!name) throw new Error("请填写预算项名称");
          const monthlyAmount = String(budgetItemMonthlyAmount.value || "").trim();
          const payload = {
            id: state.editingBudgetItem ? state.editingBudgetItem.id : undefined,
            name,
            monthly_amount: monthlyAmount,
            sort_order: String(budgetItemSortOrder.value || "1000").trim(),
            is_active: budgetItemIsActive.value === "true",
          };
          const data = await api("/api/budgets/monthly-items/upsert", "POST", payload);
          setStatus(
            budgetItemsStatus,
            true,
            state.editingBudgetItem ? `预算项已更新：${data.name}` : `预算项已保存：${data.name}`
          );
          clearBudgetItemEditMode();
          await Promise.all([
            refreshBudgetItems({ silent: true }),
            refreshBudgetOverview({ silent: true }),
            refreshFireProgress({ silent: true }),
            refreshBudgetMonthlyReview({ silent: true }),
          ]);
        } catch (err) {
          setStatus(budgetItemsStatus, false, err.message || String(err));
        }
      });

      budgetItemCancelEditBtn.addEventListener("click", () => {
        clearBudgetItemEditMode();
      });

      budgetItemRefreshBtn.addEventListener("click", async () => {
        await refreshBudgetItems({ silent: false });
      });

      budgetRefreshBtn.addEventListener("click", async () => {
        await Promise.all([
          refreshBudgetOverview({ silent: false }),
          refreshFireProgress({ silent: true }),
          refreshBudgetMonthlyReview({ silent: true }),
        ]);
      });

      budgetYear.addEventListener("change", () => {
        refreshBudgetOverview({ silent: true });
        refreshFireProgress({ silent: true });
        refreshBudgetMonthlyReview({ silent: true });
      });

      if (budgetWithdrawalRatePct) {
        budgetWithdrawalRatePct.addEventListener("change", () => {
          refreshFireProgress({ silent: true });
        });
      }

      budgetItemsBody.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const rowEl = target.closest("tr[data-budget-item-id]");
        if (!rowEl) return;
        const itemId = rowEl.getAttribute("data-budget-item-id");
        if (!itemId) return;
        const row = (state.budgetItemsRows || []).find(item => String(item.id) === itemId);
        if (!row) return;

        if (target.classList.contains("js-budget-edit")) {
          setBudgetItemEditMode(row);
          return;
        }

        if (target.classList.contains("js-budget-delete")) {
          const ok = window.confirm(`确认删除预算项「${row.name}」？`);
          if (!ok) return;
          try {
            await api("/api/budgets/monthly-items/delete", "POST", { id: itemId });
            if (state.editingBudgetItem && String(state.editingBudgetItem.id) === itemId) {
              clearBudgetItemEditMode();
            }
            setStatus(budgetItemsStatus, true, `预算项已删除：${row.name}`);
            await Promise.all([
              refreshBudgetItems({ silent: true }),
              refreshBudgetOverview({ silent: true }),
              refreshFireProgress({ silent: true }),
              refreshBudgetMonthlyReview({ silent: true }),
            ]);
          } catch (err) {
            setStatus(budgetItemsStatus, false, err.message || String(err));
          }
        }
      });

      clearBudgetItemEditMode();
      refreshBudgetAnalytics({ silent: true });
    }

    function initAccountManagement() {
      const acctStatus = document.getElementById("acctStatus");
      const acctMetrics = document.getElementById("acctMetrics");
      const acctWrap = document.getElementById("acctWrap");
      const acctBody = document.getElementById("acctBody");
      const acctKind = document.getElementById("acctKind");
      const acctName = document.getElementById("acctName");
      const acctEditingId = document.getElementById("acctEditingId");
      const acctSaveBtn = document.getElementById("acctSaveBtn");
      const acctCancelEditBtn = document.getElementById("acctCancelEditBtn");
      const acctEditHint = document.getElementById("acctEditHint");
      const acctFilterKind = document.getElementById("acctFilterKind");
      const acctKeyword = document.getElementById("acctKeyword");

      function setAccountEditMode(row) {
        state.editingAccountRecord = row || null;
        const editing = !!state.editingAccountRecord;
        acctSaveBtn.textContent = editing ? "更新账户" : "创建账户";
        acctCancelEditBtn.classList.toggle("hidden", !editing);
        acctEditHint.classList.toggle("hidden", !editing);
        acctEditingId.textContent = editing ? (row.account_id || "-") : "-";
        acctKind.disabled = editing;
      }

      function clearAccountEditMode() {
        state.editingAccountRecord = null;
        acctKind.value = "investment";
        acctName.value = "";
        setAccountEditMode(null);
      }

      function getFilteredAccountRows() {
        const kind = String(acctFilterKind.value || "all");
        const keyword = String(acctKeyword.value || "").trim().toLowerCase();
        return (state.accountCatalogRows || []).filter(row => {
          if (kind !== "all" && String(row.account_kind || "") !== kind) return false;
          if (!keyword) return true;
          const haystack = [
            row.account_id,
            row.account_name,
            row.account_kind,
            row.account_type,
          ].map(v => String(v || "")).join(" ").toLowerCase();
          return haystack.includes(keyword);
        });
      }

      function renderAccountCatalog() {
        const rows = getFilteredAccountRows();
        const referencedCount = rows.filter(row =>
          Number(row.transaction_count || 0) > 0
          || Number(row.investment_record_count || 0) > 0
          || Number(row.asset_valuation_count || 0) > 0
        ).length;
        showMetrics(acctMetrics, [
          { k: "账户数", v: rows.length, amount: false },
          { k: "已引用账户", v: referencedCount, amount: false },
          { k: "投资账户", v: rows.filter(r => r.account_kind === "investment").length, amount: false },
          { k: "资产/负债账户", v: rows.filter(r => ["cash", "real_estate", "liability"].includes(String(r.account_kind || ""))).length, amount: false },
        ]);

        acctWrap.classList.remove("hidden");
        if (rows.length === 0) {
          acctBody.innerHTML = `<tr><td colspan="8">暂无账户</td></tr>`;
          return;
        }

        acctBody.innerHTML = rows.map(row => {
          const rowJson = encodeURIComponent(JSON.stringify({
            account_id: row.account_id,
            account_name: row.account_name,
            account_kind: row.account_kind,
          }));
          const canDelete = Number(row.transaction_count || 0) === 0
            && Number(row.investment_record_count || 0) === 0
            && Number(row.asset_valuation_count || 0) === 0;
          return `
            <tr>
              <td>${accountKindLabel(row.account_kind)}</td>
              <td>${escapeHtml(row.account_name || "")}</td>
              <td>${escapeHtml(row.account_id || "")}</td>
              <td>${Number(row.transaction_count || 0)}</td>
              <td>${Number(row.investment_record_count || 0)}</td>
              <td>${Number(row.asset_valuation_count || 0)}</td>
              <td>${escapeHtml(String(row.updated_at || "").replace("T", " ").slice(0, 19))}</td>
              <td class="actions-cell">
                <button type="button" class="btn secondary small acct-edit-btn" data-row="${rowJson}">编辑</button>
                <button type="button" class="btn danger small acct-del-btn" data-id="${escapeHtml(row.account_id || "")}"${canDelete ? "" : " disabled"}>删除</button>
              </td>
            </tr>
          `;
        }).join("");
      }

      state.renderAccountCatalog = renderAccountCatalog;

      document.getElementById("acctFilterBtn").addEventListener("click", renderAccountCatalog);
      document.getElementById("acctClearFilterBtn").addEventListener("click", () => {
        acctFilterKind.value = "all";
        acctKeyword.value = "";
        renderAccountCatalog();
      });
      acctFilterKind.addEventListener("change", renderAccountCatalog);
      acctKeyword.addEventListener("input", () => {
        renderAccountCatalog();
      });

      acctCancelEditBtn.addEventListener("click", () => {
        clearAccountEditMode();
        setStatus(acctStatus, true, "已退出账户编辑模式");
      });

      document.getElementById("acctRefreshBtn").addEventListener("click", async () => {
        try {
          await refreshAccountCatalog();
          setStatus(acctStatus, true, `账户列表已刷新，共 ${(state.accountCatalogRows || []).length} 个账户`);
        } catch (err) {
          setStatus(acctStatus, false, err.message || String(err));
        }
      });

      acctSaveBtn.addEventListener("click", async () => {
        try {
          const accountKind = String(acctKind.value || "").trim();
          const accountName = String(acctName.value || "").trim();
          if (!accountKind) throw new Error("请选择账户类型");
          if (!accountName) throw new Error("请输入账户名称");
          const payload = {
            account_kind: accountKind,
            account_name: accountName,
          };
          if (state.editingAccountRecord && state.editingAccountRecord.account_id) {
            payload.account_id = state.editingAccountRecord.account_id;
          }
          const data = await api("/api/accounts/upsert", "POST", payload);
          setStatus(
            acctStatus,
            true,
            payload.account_id
              ? `账户已更新：${data.row?.account_name || accountName}`
              : `账户已创建：${data.row?.account_name || accountName}`
          );
          clearAccountEditMode();
          await refreshInvestmentAccounts();
          if (typeof state.refreshInvestmentQuery === "function") {
            await state.refreshInvestmentQuery({ silent: true });
          }
          if (typeof state.refreshAssetQuery === "function") {
            await state.refreshAssetQuery({ silent: true });
          }
        } catch (err) {
          setStatus(acctStatus, false, err.message || String(err));
        }
      });

      acctBody.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;

        if (target.classList.contains("acct-edit-btn")) {
          try {
            const raw = decodeURIComponent(target.getAttribute("data-row") || "{}");
            const row = JSON.parse(raw);
            acctKind.value = row.account_kind || "other";
            acctName.value = row.account_name || "";
            setAccountEditMode(row);
            setStatus(acctStatus, true, `已载入账户编辑：${row.account_name || row.account_id}`);
          } catch {
            setStatus(acctStatus, false, "账户信息解析失败");
          }
          return;
        }

        if (target.classList.contains("acct-del-btn")) {
          const accountId = String(target.getAttribute("data-id") || "").trim();
          if (!accountId) return;
          if (!window.confirm(`确认删除账户：${accountId} ?（仅允许删除无引用账户）`)) return;
          try {
            const payload = await api("/api/accounts/delete", "POST", { account_id: accountId });
            setStatus(acctStatus, true, `账户已删除：${payload.account_name || accountId}`);
            if (state.editingAccountRecord && state.editingAccountRecord.account_id === accountId) {
              clearAccountEditMode();
            }
            await refreshInvestmentAccounts();
          } catch (err) {
            setStatus(acctStatus, false, err.message || String(err));
          }
        }
      });

      setAccountEditMode(null);
    }

    function initQuery() {
      const qTxMetrics = document.getElementById("qTxMetrics");
      const qTxWrap = document.getElementById("qTxWrap");
      const qTxBody = document.getElementById("qTxBody");
      document.getElementById("qTxBtn").addEventListener("click", async () => {
        const params = new URLSearchParams({
          month_key: document.getElementById("qMonthKey").value.trim(),
          source_type: document.getElementById("qTxSourceType").value.trim(),
          account_id: document.getElementById("qTxAccountId").value.trim(),
          keyword: document.getElementById("qTxKeyword").value.trim(),
          limit: document.getElementById("qTxLimit").value.trim() || "100",
        });
        const data = await api(`/api/query/transactions?${params.toString()}`);
        showMetrics(qTxMetrics, [
          { k: "总笔数", v: data.summary.count },
          { k: "总金额(元)", v: data.summary.total_amount_yuan },
          { k: "返回条数", v: data.rows.length },
          { k: "来源", v: data.summary.source_type || "-" },
        ]);
        qTxWrap.classList.remove("hidden");
        qTxBody.innerHTML = data.rows.map(row => `
          <tr>
            <td>${row.posted_at || row.occurred_at || ""}</td>
            <td>${row.merchant_normalized || ""}</td>
            <td>${row.description || ""}</td>
            <td>${renderAmountValue(money(row.amount_cents))}</td>
            <td>${row.expense_category || row.statement_category || ""}</td>
            <td>${row.source_type || ""}</td>
          </tr>
        `).join("");
        applyAmountMaskInDom(qTxWrap);
      });

      const qInvMetrics = document.getElementById("qInvMetrics");
      const qInvWrap = document.getElementById("qInvWrap");
      const qInvBody = document.getElementById("qInvBody");
      let investmentRowsCache = [];
      let invInlineEditId = "";

      function renderInvestmentInlineEditorRow(row) {
        const rowId = escapeHtml(String(row.id || ""));
        const accountId = String(row.account_id || "");
        const snapshotDate = escapeHtml(String(row.snapshot_date || ""));
        const totalAssets = escapeHtml(money(row.total_assets_cents || 0));
        const transferAmount = escapeHtml(money(row.transfer_amount_cents || 0));
        const accountOptions = buildAccountOptionsMarkup(getAccountCatalogRowsByKinds("investment"), {
          selectedValue: accountId,
          blankLabel: "请选择投资账户",
          includeKind: false,
        });
        return `
          <tr class="inline-edit-row">
            <td colspan="6">
              <div class="inline-edit-box" data-edit-id="${rowId}">
                <div class="inline-edit-title">编辑投资记录</div>
                <div class="row-4 inline-edit-grid">
                  <div>
                    <label>投资账户</label>
                    <select data-role="account_id">${accountOptions}</select>
                  </div>
                  <div>
                    <label>快照日期</label>
                    <input type="date" data-role="snapshot_date" value="${snapshotDate}">
                  </div>
                  <div>
                    <label>总资产(元)</label>
                    <input type="number" step="0.01" data-role="total_assets" value="${totalAssets}">
                  </div>
                  <div>
                    <label>转入转出(元)</label>
                    <input type="number" step="0.01" data-role="transfer_amount" value="${transferAmount}">
                  </div>
                </div>
                <div class="actions">
                  <button type="button" class="btn primary small q-inv-inline-save-btn" data-id="${rowId}">保存</button>
                  <button type="button" class="btn secondary small q-inv-inline-cancel-btn">取消</button>
                </div>
              </div>
            </td>
          </tr>
        `;
      }

      function renderInvestmentQueryRows(rows) {
        investmentRowsCache = Array.isArray(rows) ? rows : [];
        qInvBody.innerHTML = investmentRowsCache.map(row => {
          const rowJson = encodeURIComponent(JSON.stringify(row));
          const label = encodeURIComponent(`${row.account_name || row.account_id || ""} ${row.snapshot_date || ""}`);
          const baseRow = `
            <tr data-row-id="${escapeHtml(row.id || "")}">
              <td>${row.snapshot_date || ""}</td>
              <td>${row.account_name || row.account_id || ""}</td>
              <td>${renderAmountValue(money(row.total_assets_cents))}</td>
              <td>${renderAmountValue(money(row.transfer_amount_cents || 0))}</td>
              <td>${row.source_type || ""}</td>
              <td class="actions-cell">
                <button class="btn secondary small q-inv-edit-btn" data-row="${rowJson}">${invInlineEditId === row.id ? "收起" : "编辑"}</button>
                <button class="btn danger small q-inv-del-btn" data-id="${escapeHtml(row.id || "")}" data-label="${label}">删除</button>
              </td>
            </tr>
          `;
          if (row.id && invInlineEditId === row.id) {
            return baseRow + renderInvestmentInlineEditorRow(row);
          }
          return baseRow;
        }).join("");
        applyAmountMaskInDom(qInvWrap);
      }

      async function loadInvestmentQuery() {
        const params = new URLSearchParams({
          from: document.getElementById("qInvFrom").value.trim(),
          to: document.getElementById("qInvTo").value.trim(),
          source_type: document.getElementById("qInvSourceType").value.trim(),
          account_id: document.getElementById("qInvAccountId").value.trim(),
          limit: document.getElementById("qInvLimit").value.trim() || "100",
        });
        const data = await api(`/api/query/investments?${params.toString()}`);
        showMetrics(qInvMetrics, [
          { k: "记录数", v: data.summary.count },
          { k: "最新总资产(元)", v: data.summary.latest_total_assets_yuan },
          { k: "区间转入转出(元)", v: data.summary.net_transfer_amount_yuan },
          { k: "来源", v: data.summary.source_type || "-" },
        ]);
        qInvWrap.classList.remove("hidden");
        if (invInlineEditId && !(data.rows || []).some(row => row.id === invInlineEditId)) {
          invInlineEditId = "";
        }
        renderInvestmentQueryRows(data.rows || []);
      }
      state.refreshInvestmentQuery = loadInvestmentQuery;
      document.getElementById("qInvBtn").addEventListener("click", () => {
        loadInvestmentQuery().catch(err => window.alert(err.message || String(err)));
      });

      qInvBody.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;

        if (target.classList.contains("q-inv-edit-btn")) {
          try {
            const raw = decodeURIComponent(target.getAttribute("data-row") || "{}");
            const row = JSON.parse(raw);
            invInlineEditId = invInlineEditId === row.id ? "" : String(row.id || "");
            renderInvestmentQueryRows(investmentRowsCache);
          } catch {
            window.alert("投资记录解析失败");
          }
          return;
        }

        if (target.classList.contains("q-inv-inline-cancel-btn")) {
          invInlineEditId = "";
          renderInvestmentQueryRows(investmentRowsCache);
          return;
        }

        if (target.classList.contains("q-inv-inline-save-btn")) {
          const id = (target.getAttribute("data-id") || "").trim();
          const box = target.closest(".inline-edit-box");
          if (!id || !box) return;
          const accountId = box.querySelector('[data-role="account_id"]');
          const snapshotDate = box.querySelector('[data-role="snapshot_date"]');
          const totalAssets = box.querySelector('[data-role="total_assets"]');
          const transferAmount = box.querySelector('[data-role="transfer_amount"]');
          try {
            const selectedAccountId = accountId ? accountId.value.trim() : "";
            if (!selectedAccountId) throw new Error("请选择投资账户");
            await api("/api/investments/update", "POST", {
              id,
              account_id: selectedAccountId,
              snapshot_date: snapshotDate ? snapshotDate.value.trim() : "",
              total_assets: totalAssets ? totalAssets.value.trim() : "",
              transfer_amount: transferAmount ? transferAmount.value.trim() : "",
            });
            invInlineEditId = "";
            await refreshInvestmentAccounts();
            await loadInvestmentQuery();
          } catch (err) {
            window.alert(err.message || String(err));
          }
          return;
        }

        if (target.classList.contains("q-inv-del-btn")) {
          const id = (target.getAttribute("data-id") || "").trim();
          const label = decodeURIComponent(target.getAttribute("data-label") || "");
          if (!id) return;
          if (!window.confirm(`确认删除投资记录：${label} ?`)) return;
          try {
            await api("/api/investments/delete", "POST", { id });
            await refreshInvestmentAccounts();
            await loadInvestmentQuery();
          } catch (err) {
            window.alert(err.message || String(err));
          }
        }
      });

      const qAssetMetrics = document.getElementById("qAssetMetrics");
      const qAssetWrap = document.getElementById("qAssetWrap");
      const qAssetBody = document.getElementById("qAssetBody");
      let assetRowsCache = [];
      let assetInlineEditId = "";

      function renderAssetInlineEditorRow(row) {
        const rowId = escapeHtml(String(row.id || ""));
        const accountId = String(row.account_id || "");
        const snapshotDate = escapeHtml(String(row.snapshot_date || ""));
        const value = escapeHtml(money(row.value_cents || 0));
        const assetClass = String(row.asset_class || "cash");
        const assetAccountRows = getAccountCatalogRowsByKinds(
          assetClass === "real_estate" ? "real_estate" : (assetClass === "liability" ? "liability" : "cash")
        );
        const accountOptions = buildAccountOptionsMarkup(assetAccountRows, {
          selectedValue: accountId,
          blankLabel: assetClass === "real_estate"
            ? "请选择不动产账户"
            : (assetClass === "liability" ? "请选择负债账户" : "请选择现金账户"),
          includeKind: false,
        });
        return `
          <tr class="inline-edit-row">
            <td colspan="6">
              <div class="inline-edit-box" data-edit-id="${rowId}">
                <div class="inline-edit-title">编辑资产记录</div>
                <div class="row-4 inline-edit-grid">
                  <div>
                    <label>资产类型</label>
                    <select data-role="asset_class">
                      <option value="cash"${assetClass === "cash" ? " selected" : ""}>现金</option>
                      <option value="real_estate"${assetClass === "real_estate" ? " selected" : ""}>不动产</option>
                      <option value="liability"${assetClass === "liability" ? " selected" : ""}>负债</option>
                    </select>
                  </div>
                  <div>
                    <label>账户</label>
                    <select data-role="account_id">${accountOptions}</select>
                  </div>
                  <div>
                    <label>快照日期</label>
                    <input type="date" data-role="snapshot_date" value="${snapshotDate}">
                  </div>
                  <div>
                    <label>金额(元)</label>
                    <input type="number" step="0.01" data-role="value" value="${value}">
                  </div>
                </div>
                <div class="actions">
                  <button type="button" class="btn primary small q-asset-inline-save-btn" data-id="${rowId}">保存</button>
                  <button type="button" class="btn secondary small q-asset-inline-cancel-btn">取消</button>
                </div>
              </div>
            </td>
          </tr>
        `;
      }

      function renderAssetQueryRows(rows) {
        assetRowsCache = Array.isArray(rows) ? rows : [];
        qAssetBody.innerHTML = assetRowsCache.map(row => {
          const rowJson = encodeURIComponent(JSON.stringify(row));
          const label = encodeURIComponent(`${row.account_name || row.account_id || ""} ${row.snapshot_date || ""}`);
          const baseRow = `
            <tr data-row-id="${escapeHtml(row.id || "")}">
              <td>${row.snapshot_date}</td>
              <td>${row.asset_class}</td>
              <td>${row.account_name || row.account_id}</td>
              <td>${renderAmountValue(money(row.value_cents))}</td>
              <td>${row.source_type || ""}</td>
              <td class="actions-cell">
                <button class="btn secondary small q-asset-edit-btn" data-row="${rowJson}">${assetInlineEditId === row.id ? "收起" : "编辑"}</button>
                <button class="btn danger small q-asset-del-btn" data-id="${escapeHtml(row.id || "")}" data-label="${label}">删除</button>
              </td>
            </tr>
          `;
          if (row.id && assetInlineEditId === row.id) {
            return baseRow + renderAssetInlineEditorRow(row);
          }
          return baseRow;
        }).join("");
        applyAmountMaskInDom(qAssetWrap);
      }

      async function loadAssetQuery() {
        const params = new URLSearchParams({
          from: document.getElementById("qAssetFrom").value.trim(),
          to: document.getElementById("qAssetTo").value.trim(),
          asset_class: document.getElementById("qAssetClass").value,
          account_id: document.getElementById("qAssetAccountId").value.trim(),
          limit: document.getElementById("qAssetLimit").value.trim() || "100",
        });
        const data = await api(`/api/query/assets?${params.toString()}`);
        showMetrics(qAssetMetrics, [
          { k: "记录数", v: data.summary.count },
          { k: "金额合计(元)", v: data.summary.sum_value_yuan },
          { k: "资产类型", v: data.summary.asset_class || "全部" },
          { k: "返回条数", v: data.rows.length },
        ]);
        qAssetWrap.classList.remove("hidden");
        if (assetInlineEditId && !(data.rows || []).some(row => row.id === assetInlineEditId)) {
          assetInlineEditId = "";
        }
        renderAssetQueryRows(data.rows || []);
      }
      state.refreshAssetQuery = loadAssetQuery;
      document.getElementById("qAssetBtn").addEventListener("click", () => {
        loadAssetQuery().catch(err => window.alert(err.message || String(err)));
      });
      document.getElementById("qAssetClass").addEventListener("change", () => {
        refreshAccountSelectorsFromCatalog();
      });

      qAssetBody.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;

        if (target.classList.contains("q-asset-edit-btn")) {
          try {
            const raw = decodeURIComponent(target.getAttribute("data-row") || "{}");
            const row = JSON.parse(raw);
            assetInlineEditId = assetInlineEditId === row.id ? "" : String(row.id || "");
            renderAssetQueryRows(assetRowsCache);
          } catch {
            window.alert("资产记录解析失败");
          }
          return;
        }

        if (target.classList.contains("q-asset-inline-cancel-btn")) {
          assetInlineEditId = "";
          renderAssetQueryRows(assetRowsCache);
          return;
        }

        if (target.classList.contains("q-asset-inline-save-btn")) {
          const id = (target.getAttribute("data-id") || "").trim();
          const box = target.closest(".inline-edit-box");
          if (!id || !box) return;
          const assetClass = box.querySelector('[data-role="asset_class"]');
          const accountId = box.querySelector('[data-role="account_id"]');
          const snapshotDate = box.querySelector('[data-role="snapshot_date"]');
          const valueInput = box.querySelector('[data-role="value"]');
          try {
            const selectedAccountId = accountId ? accountId.value.trim() : "";
            if (!selectedAccountId) throw new Error("请选择资产账户");
            await api("/api/assets/update", "POST", {
              id,
              asset_class: assetClass ? assetClass.value : "",
              account_id: selectedAccountId,
              snapshot_date: snapshotDate ? snapshotDate.value.trim() : "",
              value: valueInput ? valueInput.value.trim() : "",
            });
            assetInlineEditId = "";
            if (typeof state.refreshWealthAnalytics === "function") {
              await state.refreshWealthAnalytics({ silent: true });
            }
            await loadAssetQuery();
          } catch (err) {
            window.alert(err.message || String(err));
          }
          return;
        }

        if (target.classList.contains("q-asset-del-btn")) {
          const id = (target.getAttribute("data-id") || "").trim();
          const label = decodeURIComponent(target.getAttribute("data-label") || "");
          if (!id) return;
          if (!window.confirm(`确认删除资产记录：${label} ?`)) return;
          try {
            await api("/api/assets/delete", "POST", { id });
            if (typeof state.refreshWealthAnalytics === "function") {
              await state.refreshWealthAnalytics({ silent: true });
            }
            await loadAssetQuery();
          } catch (err) {
            window.alert(err.message || String(err));
          }
        }
      });

      qAssetBody.addEventListener("change", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        if (!target.matches('select[data-role="asset_class"]')) return;
        const box = target.closest(".inline-edit-box");
        if (!box) return;
        const accountSelect = box.querySelector('select[data-role="account_id"]');
        if (!(accountSelect instanceof HTMLSelectElement)) return;
        const assetClass = target.value === "real_estate"
          ? "real_estate"
          : (target.value === "liability" ? "liability" : "cash");
        const rows = getAccountCatalogRowsByKinds(assetClass);
        accountSelect.innerHTML = buildAccountOptionsMarkup(rows, {
          selectedValue: "",
          blankLabel: assetClass === "real_estate"
            ? "请选择不动产账户"
            : (assetClass === "liability" ? "请选择负债账户" : "请选择现金账户"),
          includeKind: false,
        });
      });
    }

    function initAdmin() {
      const adminStatus = document.getElementById("adminStatus");
      const adminMetrics = document.getElementById("adminMetrics");
      const adminRowsWrap = document.getElementById("adminRowsWrap");
      const adminRowsBody = document.getElementById("adminRowsBody");
      const adminConfirmPhrase = document.getElementById("adminConfirmPhrase");
      const adminConfirmText = document.getElementById("adminConfirmText");

      function renderAdminRows(beforeRows, afterRows) {
        const afterMap = new Map((afterRows || []).map(item => [item.table, Number(item.row_count || 0)]));
        const base = beforeRows || [];
        adminRowsWrap.classList.remove("hidden");
        adminRowsBody.innerHTML = base.map(item => {
          const before = Number(item.row_count || 0);
          const after = Number(afterMap.has(item.table) ? afterMap.get(item.table) : 0);
          return `
            <tr>
              <td>${item.table}</td>
              <td>${before}</td>
              <td>${after}</td>
              <td>${before - after}</td>
            </tr>
          `;
        }).join("");
      }

      async function loadAdminStats(options = {}) {
        const { silent = false } = options;
        const data = await api("/api/admin/db-stats");
        adminConfirmPhrase.textContent = data.confirm_phrase || "-";
        showMetrics(adminMetrics, [
          { k: "数据表数量", v: data.summary.table_count },
          { k: "当前总行数", v: data.summary.total_rows },
          { k: "确认口令", v: data.confirm_phrase || "-" },
          { k: "数据库", v: "keepwise.db" },
        ]);
        renderAdminRows(data.rows || [], data.rows || []);
        if (!silent) {
          setStatus(adminStatus, true, `数据库统计已更新，当前共 ${data.summary.total_rows} 行`);
        }
      }

      document.getElementById("adminLoadStatsBtn").addEventListener("click", async () => {
        try {
          await loadAdminStats({ silent: false });
        } catch (err) {
          setStatus(adminStatus, false, err.message || String(err));
        }
      });

      document.getElementById("adminResetTxBtn").addEventListener("click", async () => {
        try {
          const payload = await api("/api/admin/reset-transactions", "POST", {
            confirm_text: adminConfirmText.value.trim(),
            clear_import_sessions: true,
          });
          showMetrics(adminMetrics, [
            { k: "清理范围", v: "交易数据（EML）" },
            { k: "清理前总行数", v: payload.summary.total_rows_before },
            { k: "清理后总行数", v: payload.summary.total_rows_after },
            { k: "已删除行数", v: payload.summary.deleted_rows },
          ]);
          renderAdminRows(payload.before_rows || [], payload.after_rows || []);
          setStatus(
            adminStatus,
            true,
            `交易数据已清理，可重新导入 EML（清理会话目录 ${payload.cleared_preview_sessions || 0} 个）`
          );
          adminConfirmText.value = "";
          if (typeof state.refreshBudgetAnalytics === "function") {
            state.refreshBudgetAnalytics().catch(() => {});
          }
          if (typeof state.refreshInvestmentQuery === "function") {
            state.refreshInvestmentQuery().catch(() => {});
          }
          if (typeof state.refreshAssetQuery === "function") {
            state.refreshAssetQuery().catch(() => {});
          }
        } catch (err) {
          setStatus(adminStatus, false, err.message || String(err));
        }
      });

      document.getElementById("adminResetDbBtn").addEventListener("click", async () => {
        try {
          const payload = await api("/api/admin/reset-db", "POST", {
            confirm_text: adminConfirmText.value.trim(),
            clear_import_sessions: true,
          });
          showMetrics(adminMetrics, [
            { k: "数据表数量", v: payload.summary.table_count },
            { k: "清理前总行数", v: payload.summary.total_rows_before },
            { k: "清理后总行数", v: payload.summary.total_rows_after },
            { k: "已删除行数", v: payload.summary.deleted_rows },
          ]);
          renderAdminRows(payload.before_rows || [], payload.after_rows || []);
          setStatus(
            adminStatus,
            true,
            `数据库已清空，可重新导入验证（清理会话目录 ${payload.cleared_preview_sessions || 0} 个）`
          );
          adminConfirmText.value = "";
          await refreshInvestmentAccounts();
        } catch (err) {
          setStatus(adminStatus, false, err.message || String(err));
        }
      });

      loadAdminStats({ silent: true }).catch(() => {
        adminConfirmPhrase.textContent = "RESET KEEPWISE";
      });
    }

    async function init() {
      initTabs();
      initPrivacyToggle();

      setTodayIfEmpty("invSnapshotDate");
      setTodayIfEmpty("assetSnapshotDate");

      await initImportActions();
      initRecordActions();
      initReturnAnalytics();
      initWealth();
      initBudget();
      initAccountManagement();
      initQuery();
      initAdmin();
      await refreshInvestmentAccounts();
    }

    init();
  </script>
</body>
</html>
