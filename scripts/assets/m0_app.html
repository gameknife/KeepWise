<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KeepWise M1 工作台</title>
  <link rel="stylesheet" href="/assets/m0_app.css">
</head>
<body>
  <div class="container">
    <section class="hero">
      <h1>KeepWise M1 工作台</h1>
      <p>主线：投资记录维护、区间收益率（现金加权）、财富总览、增长曲线。</p>
      <div class="tabs">
        <button class="tab-btn active" data-tab="tab-import">导入中心</button>
        <button class="tab-btn" data-tab="tab-records">记录录入</button>
        <button class="tab-btn" data-tab="tab-return">收益分析</button>
        <button class="tab-btn" data-tab="tab-wealth">财富总览</button>
        <button class="tab-btn" data-tab="tab-query">基础查询</button>
        <button class="tab-btn" data-tab="tab-admin">高级管理</button>
      </div>
    </section>

    <section id="tab-import" class="panel">
      <h2>导入中心</h2>
      <p class="hint">先预览再确认导入。EML 支持多文件；有知有行支持 CSV / XLSX。</p>

      <h3>EML 导入</h3>
      <div class="row">
        <div>
          <label>选择 EML 文件（可多选）</label>
          <input id="emlFiles" type="file" multiple accept=".eml">
        </div>
        <div>
          <label>review_threshold</label>
          <input id="emlThreshold" type="number" step="0.01" min="0" max="1" value="0.70">
        </div>
      </div>
      <div class="actions">
        <button id="emlPreviewBtn" class="btn secondary">预览 EML</button>
        <button id="emlImportBtn" class="btn primary">确认导入 EML</button>
      </div>
      <div id="emlStatus" class="status hidden"></div>
      <div id="emlMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="emlErrorsWrap">
        <table>
          <thead><tr><th>错误文件</th><th>错误内容</th></tr></thead>
          <tbody id="emlErrorsBody"></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">有知有行导出表（CSV / XLSX）</h3>
      <div class="row">
        <div>
          <label>选择导出文件</label>
          <input id="yzxyCsvFile" type="file" accept=".csv,.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv">
        </div>
        <div></div>
      </div>
      <div class="actions">
        <button id="yzxyPreviewBtn" class="btn secondary">预览文件</button>
        <button id="yzxyImportBtn" class="btn primary">确认导入文件</button>
      </div>
      <div id="yzxyStatus" class="status hidden"></div>
      <div id="yzxyMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="yzxyErrorsWrap">
        <table>
          <thead><tr><th>错误信息</th></tr></thead>
          <tbody id="yzxyErrorsBody"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-records" class="panel hidden">
      <h2>记录录入</h2>
      <p class="hint">金额单位为元，系统自动转换为分。</p>

      <div class="split-grid">
        <div class="sub-panel">
          <h3>投资记录单条录入</h3>
          <div class="row-3">
            <div>
              <label>账户名称</label>
              <input id="invAccountName" type="text" value="有知有行投资账户">
            </div>
            <div>
              <label>快照日期</label>
              <input id="invSnapshotDate" type="date">
            </div>
            <div>
              <label>总资产（元）</label>
              <input id="invTotalAssets" type="number" step="0.01">
            </div>
            <div>
              <label>转入转出金额（元）</label>
              <input id="invTransferAmount" type="number" step="0.01" value="0">
            </div>
          </div>
          <div class="actions">
            <button id="invSaveBtn" class="btn primary">保存投资记录</button>
          </div>
          <div id="invStatus" class="status hidden"></div>
        </div>

        <div class="sub-panel">
          <h3>现金/不动产记录录入</h3>
          <div class="row-3">
            <div>
              <label>资产类型</label>
              <select id="assetClass">
                <option value="cash">现金账户</option>
                <option value="real_estate">不动产账户</option>
              </select>
            </div>
            <div>
              <label>账户名称</label>
              <input id="assetAccountName" type="text" value="家庭现金账户">
            </div>
            <div>
              <label>快照日期</label>
              <input id="assetSnapshotDate" type="date">
            </div>
            <div>
              <label>资产金额（元）</label>
              <input id="assetValue" type="number" step="0.01">
            </div>
          </div>
          <div class="actions">
            <button id="assetSaveBtn" class="btn primary">保存资产记录</button>
          </div>
          <div id="assetStatus" class="status hidden"></div>
        </div>
      </div>
    </section>

    <section id="tab-return" class="panel hidden">
      <h2>收益分析（现金加权）</h2>
      <p class="hint">公式：Modified Dietz。支持 YTD、近一年、近三年、成立以来、自定义区间。</p>

      <div class="row-4">
        <div>
          <label>投资账户</label>
          <select id="retAccountId"></select>
        </div>
        <div>
          <label>区间预设</label>
          <select id="retPreset">
            <option value="ytd">年度（YTD）</option>
            <option value="1y" selected>近一年</option>
            <option value="3y">近三年</option>
            <option value="since_inception">成立以来</option>
            <option value="custom">自定义</option>
          </select>
        </div>
        <div>
          <label>开始日期（custom）</label>
          <input id="retFrom" type="date">
        </div>
        <div>
          <label>结束日期（可选）</label>
          <input id="retTo" type="date">
        </div>
      </div>
      <div class="actions">
        <button id="retRefreshAccountsBtn" class="btn secondary">刷新账户列表</button>
        <button id="retBatchBtn" class="btn secondary">计算全部账户收益率</button>
      </div>
      <div id="retStatus" class="status hidden"></div>
      <div id="retMetrics" class="grid-metrics hidden"></div>

      <div class="pill-tabs" id="retChartTabs">
        <button class="pill-tab active" data-view="asset">总资产曲线</button>
        <button class="pill-tab" data-view="return">累计收益率曲线</button>
        <button class="pill-tab" data-view="growth">净增长资金曲线</button>
      </div>

      <div id="retChartAssetView" class="chart-card">
        <div class="chart-header">投资账户总资产曲线</div>
        <div id="retCurveLegend" class="legend hidden"></div>
        <div id="retCurveChart" class="chart-host"></div>
      </div>

      <div id="retChartReturnView" class="chart-card hidden">
        <div class="chart-header">区间累计收益率曲线（现金加权）</div>
        <div id="retRateLegend" class="legend hidden"></div>
        <div id="retRateChart" class="chart-host"></div>
      </div>

      <div id="retChartGrowthView" class="chart-card hidden">
        <div class="chart-header">区间净增长资金曲线</div>
        <div id="retGrowthLegend" class="legend hidden"></div>
        <div id="retGrowthChart" class="chart-host"></div>
      </div>

      <div class="table-wrap hidden" id="retFlowWrap">
        <table>
          <thead>
            <tr><th>日期</th><th>转入转出(元)</th><th>权重</th></tr>
          </thead>
          <tbody id="retFlowBody"></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">账户收益率对比（同一区间）</h3>
      <div id="retBatchMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="retBatchWrap">
        <table>
          <thead>
            <tr>
              <th>账户</th>
              <th>区间收益率</th>
              <th>年化收益率</th>
              <th>收益额(元)</th>
              <th>净流入(元)</th>
              <th>区间</th>
              <th>有效天数</th>
            </tr>
          </thead>
          <tbody id="retBatchBody"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-wealth" class="panel hidden">
      <h2>财富总览</h2>
      <p class="hint">按投资、现金、不动产三类聚合展示，并支持随时间曲线。</p>

      <h3>总览快照</h3>
      <div class="row">
        <div>
          <label>as_of（可选）</label>
          <input id="wealthAsOf" type="date">
        </div>
        <div></div>
      </div>
      <div class="pill-tabs" id="wealthAssetFilters">
        <button type="button" class="pill-tab active" data-key="include_investment" aria-pressed="true">投资</button>
        <button type="button" class="pill-tab active" data-key="include_cash" aria-pressed="true">现金</button>
        <button type="button" class="pill-tab active" data-key="include_real_estate" aria-pressed="true">不动产</button>
      </div>
      <div class="actions">
        <button id="wealthOverviewBtn" class="btn primary">查询总览</button>
      </div>
      <div id="wealthStatus" class="status hidden"></div>
      <div id="wealthMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="wealthRowsWrap">
        <table>
          <thead>
            <tr><th>类型</th><th>账户</th><th>日期</th><th>金额(元)</th></tr>
          </thead>
          <tbody id="wealthRowsBody"></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">财富增长曲线</h3>
      <div class="row-4">
        <div>
          <label>区间预设</label>
          <select id="wealthPreset">
            <option value="ytd">年度（YTD）</option>
            <option value="1y" selected>近一年</option>
            <option value="3y">近三年</option>
            <option value="since_inception">成立以来</option>
            <option value="custom">自定义</option>
          </select>
        </div>
        <div>
          <label>开始日期（custom）</label>
          <input id="wealthFrom" type="date">
        </div>
        <div>
          <label>结束日期（可选）</label>
          <input id="wealthTo" type="date">
        </div>
        <div></div>
      </div>
      <div class="actions">
        <button id="wealthCurveBtn" class="btn secondary">加载财富曲线</button>
      </div>
      <div id="wealthCurveMetrics" class="grid-metrics hidden"></div>
      <div class="pill-tabs" id="wealthChartTabs">
        <button class="pill-tab active" data-view="asset">总财富曲线</button>
        <button class="pill-tab" data-view="growth">净增长资金曲线</button>
      </div>
      <div id="wealthChartAssetView" class="chart-card">
        <div class="chart-header">财富总览曲线</div>
        <div id="wealthCurveLegend" class="legend hidden"></div>
        <div id="wealthCurveChart" class="chart-host"></div>
      </div>
      <div id="wealthChartGrowthView" class="chart-card hidden">
        <div class="chart-header">财富净增长资金曲线</div>
        <div id="wealthGrowthLegend" class="legend hidden"></div>
        <div id="wealthGrowthChart" class="chart-host"></div>
      </div>
    </section>

    <section id="tab-query" class="panel hidden">
      <h2>基础查询</h2>
      <p class="hint">提供交易、投资、非投资资产记录的筛选与列表。</p>

      <h3>交易查询</h3>
      <div class="row-3">
        <div><label>月份（YYYY-MM）</label><input id="qMonthKey" type="text" placeholder="2025-01"></div>
        <div><label>来源</label><input id="qTxSourceType" type="text" placeholder="cmb_eml"></div>
        <div><label>账户 ID</label><input id="qTxAccountId" type="text"></div>
        <div><label>关键词</label><input id="qTxKeyword" type="text"></div>
        <div><label>limit</label><input id="qTxLimit" type="number" value="100"></div>
      </div>
      <div class="actions">
        <button id="qTxBtn" class="btn secondary">查询交易</button>
      </div>
      <div id="qTxMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="qTxWrap">
        <table>
          <thead><tr><th>日期</th><th>商户</th><th>摘要</th><th>金额(元)</th><th>分类</th><th>来源</th></tr></thead>
          <tbody id="qTxBody"></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">投资记录查询</h3>
      <div class="row-3">
        <div><label>开始日期</label><input id="qInvFrom" type="date"></div>
        <div><label>结束日期</label><input id="qInvTo" type="date"></div>
        <div><label>来源</label><input id="qInvSourceType" type="text" placeholder="manual"></div>
        <div><label>账户 ID</label><input id="qInvAccountId" type="text"></div>
        <div><label>limit</label><input id="qInvLimit" type="number" value="100"></div>
      </div>
      <div class="actions">
        <button id="qInvBtn" class="btn secondary">查询投资记录</button>
      </div>
      <div id="qInvMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="qInvWrap">
        <table>
          <thead><tr><th>日期</th><th>账户</th><th>总资产(元)</th><th>转入转出(元)</th><th>来源</th></tr></thead>
          <tbody id="qInvBody"></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">非投资资产查询</h3>
      <div class="row-3">
        <div><label>开始日期</label><input id="qAssetFrom" type="date"></div>
        <div><label>结束日期</label><input id="qAssetTo" type="date"></div>
        <div>
          <label>资产类型</label>
          <select id="qAssetClass">
            <option value="">全部</option>
            <option value="cash">现金</option>
            <option value="real_estate">不动产</option>
          </select>
        </div>
        <div><label>账户 ID</label><input id="qAssetAccountId" type="text"></div>
        <div><label>limit</label><input id="qAssetLimit" type="number" value="100"></div>
      </div>
      <div class="actions">
        <button id="qAssetBtn" class="btn secondary">查询非投资资产</button>
      </div>
      <div id="qAssetMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="qAssetWrap">
        <table>
          <thead><tr><th>日期</th><th>类型</th><th>账户</th><th>金额(元)</th><th>来源</th></tr></thead>
          <tbody id="qAssetBody"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-admin" class="panel hidden">
      <h2>高级管理</h2>
      <p class="hint">用于开发验证：清空数据库后重新导入，验证流程可重复执行。</p>
      <div class="admin-warning">
        <strong>危险操作：</strong>会删除数据库中的全部业务数据（交易、投资、资产、导入任务、账户等），结构和索引会保留。
      </div>

      <div class="row-3" style="margin-top:10px">
        <div>
          <label>确认口令</label>
          <input id="adminConfirmText" type="text" placeholder="请输入确认口令">
        </div>
        <div>
          <label>系统口令</label>
          <div id="adminConfirmPhrase" class="metric" style="padding:9px 11px">-</div>
        </div>
        <div></div>
      </div>

      <div class="actions">
        <button id="adminLoadStatsBtn" class="btn secondary">查看数据库数据量</button>
        <button id="adminResetDbBtn" class="btn danger">清空全部数据库数据</button>
      </div>
      <div id="adminStatus" class="status hidden"></div>
      <div id="adminMetrics" class="grid-metrics hidden"></div>
      <div class="table-wrap hidden" id="adminRowsWrap">
        <table>
          <thead><tr><th>表名</th><th>清理前</th><th>清理后</th><th>删除行数</th></tr></thead>
          <tbody id="adminRowsBody"></tbody>
        </table>
      </div>
      <h3 style="margin-top:18px">交易规则管理</h3>
      <p class="hint">规则编辑已拆分到独立页面，便于集中维护和查看。</p>
      <div class="actions">
        <a class="btn secondary" href="/rules" target="_blank" rel="noopener">打开交易规则管理页面</a>
      </div>
    </section>
  </div>

  <script>
    const state = {
      emlPreviewToken: "",
      yzxyPreviewToken: "",
      investmentAccounts: [],
      refreshReturnAnalytics: null,
      refreshReturnBatchAnalytics: null,
      refreshWealthAnalytics: null,
    };

    function money(cents) {
      return (Number(cents || 0) / 100).toFixed(2);
    }

    function pct(value) {
      if (value === null || value === undefined || Number.isNaN(Number(value))) return "-";
      return `${(Number(value) * 100).toFixed(2)}%`;
    }

    function formatYuanShortFromCents(cents) {
      const yuan = Number(cents || 0) / 100;
      const abs = Math.abs(yuan);
      if (abs >= 100000000) return `${(yuan / 100000000).toFixed(2)}亿`;
      if (abs >= 10000) return `${(yuan / 10000).toFixed(1)}万`;
      return yuan.toFixed(0);
    }

    function buildReturnReferenceLines(rows) {
      const candidates = [-30, -20, -10, -5, 0, 5, 10, 20, 30, 40, 50];
      const values = (rows || [])
        .map(row => Number(row.cumulative_return_pct))
        .filter(v => Number.isFinite(v));
      const minVal = values.length ? Math.min(...values) : -5;
      const maxVal = values.length ? Math.max(...values) : 5;
      return candidates
        .filter(v => v >= minVal - 2 && v <= maxVal + 2)
        .map(v => ({
          value: v,
          label: `${v}%`,
          color: v === 0 ? "#b45309" : "#d2d9c7",
        }));
    }

    function setStatus(el, ok, text) {
      el.classList.remove("hidden", "ok", "err");
      el.classList.add(ok ? "ok" : "err");
      el.textContent = text;
    }

    function hide(el) {
      el.classList.add("hidden");
    }

    function showMetrics(holder, items) {
      holder.classList.remove("hidden");
      holder.innerHTML = items.map(item => `
        <div class="metric">
          <div class="k">${item.k}</div>
          <div class="v">${item.v}</div>
        </div>
      `).join("");
    }

    async function api(path, method = "GET", body = null) {
      const res = await fetch(path, {
        method,
        headers: { "Content-Type": "application/json" },
        body: body ? JSON.stringify(body) : null,
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "请求失败");
      return data;
    }

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = String(reader.result || "");
          const base64 = result.split(",")[1] || "";
          resolve({ name: file.name, content_base64: base64 });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function collectFiles(inputEl) {
      const files = Array.from(inputEl.files || []);
      const payload = [];
      for (const file of files) {
        payload.push(await readFileAsBase64(file));
      }
      return payload;
    }

    function initTabs() {
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const target = btn.getAttribute("data-tab");
          document.querySelectorAll(".tab-btn").forEach(x => x.classList.remove("active"));
          btn.classList.add("active");
          document.querySelectorAll("section.panel").forEach(panel => {
            panel.classList.toggle("hidden", panel.id !== target);
          });
        });
      });
    }

    function setTodayIfEmpty(elId) {
      const el = document.getElementById(elId);
      if (el && !el.value) {
        el.value = new Date().toISOString().slice(0, 10);
      }
    }

    function syncCustomDateState(selectId, fromInputId) {
      const selectEl = document.getElementById(selectId);
      const fromEl = document.getElementById(fromInputId);
      const apply = () => {
        const isCustom = selectEl.value === "custom";
        fromEl.disabled = !isCustom;
        if (!isCustom) fromEl.value = "";
      };
      selectEl.addEventListener("change", apply);
      apply();
    }

    function renderLineChart(hostId, legendId, rows, seriesDefs, options = {}) {
      const host = document.getElementById(hostId);
      const legend = document.getElementById(legendId);
      if (!rows || rows.length === 0) {
        host.innerHTML = `<div class="empty">暂无可视化数据</div>`;
        legend.classList.add("hidden");
        return;
      }

      const width = 1000;
      const height = 360;
      const padLeft = 60;
      const padRight = 24;
      const padTop = 16;
      const padBottom = 30;
      const chartWidth = width - padLeft - padRight;
      const chartHeight = height - padTop - padBottom;

      const yTickCount = Math.max(2, Number(options.yTickCount || 4));
      const includeZero = options.includeZero !== false;
      const yAxisFormatter = options.yAxisFormatter || ((v) => `${Number(v).toFixed(2)}`);
      const referenceLines = Array.isArray(options.referenceLines) ? options.referenceLines : [];

      const values = rows.flatMap(row => seriesDefs.map(s => Number(row[s.key])));
      const numericValues = values.filter(v => Number.isFinite(v));
      if (numericValues.length === 0) {
        host.innerHTML = `<div class="empty">暂无可视化数据</div>`;
        legend.classList.add("hidden");
        return;
      }

      let minVal = Math.min(...numericValues);
      let maxVal = Math.max(...numericValues);
      if (includeZero) {
        minVal = Math.min(minVal, 0);
        maxVal = Math.max(maxVal, 0);
      }
      if (Number.isFinite(options.minValue)) minVal = Number(options.minValue);
      if (Number.isFinite(options.maxValue)) maxVal = Number(options.maxValue);
      if (Math.abs(maxVal - minVal) < 1e-9) {
        const padding = Math.max(1, Math.abs(maxVal) * 0.1);
        minVal -= padding;
        maxVal += padding;
      }
      const span = maxVal - minVal;
      const xStep = rows.length > 1 ? chartWidth / (rows.length - 1) : 0;

      const x = idx => padLeft + idx * xStep;
      const y = val => padTop + ((maxVal - val) / span) * chartHeight;

      const gridLines = [];
      const yLabels = [];
      for (let i = 0; i <= yTickCount; i += 1) {
        const ratio = i / yTickCount;
        const val = maxVal - ratio * span;
        const yy = y(val);
        gridLines.push(
          `<line x1="${padLeft}" y1="${yy.toFixed(2)}" x2="${width - padRight}" y2="${yy.toFixed(2)}" stroke="#e3e8d8" stroke-width="1" />`
        );
        yLabels.push(
          `<text x="${padLeft - 8}" y="${(yy + 4).toFixed(2)}" font-size="11" text-anchor="end" fill="#6a767f">${yAxisFormatter(val)}</text>`
        );
      }

      const refLineSvg = referenceLines
        .filter(line => Number.isFinite(line.value))
        .filter(line => line.value >= minVal && line.value <= maxVal)
        .map(line => {
          const yy = y(Number(line.value));
          const color = line.color || "#d2d9c7";
          return `
            <line x1="${padLeft}" y1="${yy.toFixed(2)}" x2="${width - padRight}" y2="${yy.toFixed(2)}" stroke="${color}" stroke-width="1.2" stroke-dasharray="5 4" />
            <text x="${padLeft + 4}" y="${(yy - 4).toFixed(2)}" font-size="11" fill="${color}">${line.label || ""}</text>
          `;
        }).join("");

      const seriesPaths = seriesDefs.map(def => {
        const segments = [];
        let current = [];
        rows.forEach((row, idx) => {
          const val = Number(row[def.key]);
          if (!Number.isFinite(val)) {
            if (current.length > 1) {
              segments.push(current);
            }
            current = [];
            return;
          }
          current.push(`${x(idx).toFixed(2)},${y(val).toFixed(2)}`);
        });
        if (current.length > 1) segments.push(current);
        return segments
          .map(points => `<polyline fill="none" stroke="${def.color}" stroke-width="2.4" points="${points.join(" ")}" />`)
          .join("");
      }).join("");

      const xStartLabel = rows[0].snapshot_date || "";
      const xEndLabel = rows[rows.length - 1].snapshot_date || "";

      host.innerHTML = `
        <div class="chart-stage">
          <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" class="chart-svg">
            ${gridLines.join("")}
            ${yLabels.join("")}
            ${refLineSvg}
            <line x1="${padLeft}" y1="${height - padBottom}" x2="${width - padRight}" y2="${height - padBottom}" stroke="#cfd8c3" stroke-width="1.2" />
            <line x1="${padLeft}" y1="${padTop}" x2="${padLeft}" y2="${height - padBottom}" stroke="#cfd8c3" stroke-width="1.2" />
            ${seriesPaths}
            <line data-role="hover-line" x1="${padLeft}" y1="${padTop}" x2="${padLeft}" y2="${height - padBottom}" stroke="#6f7f86" stroke-width="1.2" stroke-dasharray="4 4" visibility="hidden" />
            ${seriesDefs.map((def, idx) => `
              <circle data-role="hover-dot" data-series="${idx}" r="4.5" fill="#fff" stroke="${def.color}" stroke-width="2" visibility="hidden" />
            `).join("")}
            <text x="${padLeft}" y="${height - 8}" font-size="11" fill="#6a767f">${xStartLabel}</text>
            <text x="${width - padRight - 90}" y="${height - 8}" font-size="11" fill="#6a767f">${xEndLabel}</text>
            <rect data-role="overlay" x="${padLeft}" y="${padTop}" width="${chartWidth}" height="${chartHeight}" fill="transparent" />
          </svg>
          <div class="chart-tooltip hidden" data-role="tooltip"></div>
        </div>
      `;

      legend.classList.remove("hidden");
      legend.innerHTML = seriesDefs.map(def => `
        <span class="legend-item"><i style="background:${def.color}"></i>${def.label}</span>
      `).join("");

      const stage = host.querySelector(".chart-stage");
      const overlay = host.querySelector('[data-role="overlay"]');
      const hoverLine = host.querySelector('[data-role="hover-line"]');
      const dots = Array.from(host.querySelectorAll('[data-role="hover-dot"]'));
      const tooltip = host.querySelector('[data-role="tooltip"]');
      if (!stage || !overlay || !hoverLine || !tooltip) return;

      function showAt(index, pointerX = null) {
        if (index < 0 || index >= rows.length) return;
        const row = rows[index];
        const xCoord = x(index);
        hoverLine.setAttribute("x1", xCoord.toFixed(2));
        hoverLine.setAttribute("x2", xCoord.toFixed(2));
        hoverLine.setAttribute("visibility", "visible");

        const lines = [];
        seriesDefs.forEach((def, idx) => {
          const val = Number(row[def.key]);
          const dot = dots[idx];
          if (!dot) return;
          if (Number.isFinite(val)) {
            const yCoord = y(val);
            dot.setAttribute("cx", xCoord.toFixed(2));
            dot.setAttribute("cy", yCoord.toFixed(2));
            dot.setAttribute("visibility", "visible");
            const valueText = typeof def.formatValue === "function" ? def.formatValue(val, row) : `${val}`;
            lines.push(`<div class="t-row"><i style="background:${def.color}"></i><span>${def.label}: ${valueText}</span></div>`);
          } else {
            dot.setAttribute("visibility", "hidden");
          }
        });

        const title = typeof options.tooltipTitle === "function"
          ? options.tooltipTitle(row, index)
          : (row.snapshot_date || "");
        tooltip.innerHTML = `<div class="t-title">${title}</div>${lines.join("")}`;
        tooltip.classList.remove("hidden");

        const stageRect = stage.getBoundingClientRect();
        const targetX = pointerX !== null ? pointerX : (xCoord / width) * stageRect.width;
        const tooltipWidth = tooltip.offsetWidth || 140;
        let left = targetX + 12;
        if (left + tooltipWidth > stageRect.width - 6) left = targetX - tooltipWidth - 12;
        if (left < 6) left = 6;
        tooltip.style.left = `${left}px`;
        tooltip.style.top = "8px";
      }

      function hideHover() {
        hoverLine.setAttribute("visibility", "hidden");
        dots.forEach(dot => dot.setAttribute("visibility", "hidden"));
        tooltip.classList.add("hidden");
      }

      overlay.addEventListener("mousemove", (event) => {
        const rect = overlay.getBoundingClientRect();
        if (rect.width <= 0) return;
        const px = event.clientX - rect.left;
        const localX = (px / rect.width) * chartWidth;
        const idx = rows.length > 1 ? Math.round(localX / xStep) : 0;
        const clampedIdx = Math.max(0, Math.min(rows.length - 1, idx));
        showAt(clampedIdx, event.clientX - stage.getBoundingClientRect().left);
      });

      overlay.addEventListener("mouseenter", () => {
        showAt(rows.length - 1);
      });
      overlay.addEventListener("mouseleave", hideHover);
    }

    async function refreshInvestmentAccounts() {
      const data = await api("/api/meta/accounts?kind=investment");
      state.investmentAccounts = data.investment_accounts || [];
      const accountOptions = state.investmentAccounts
        .map(item => `<option value="${item.account_id}">${item.account_name} (${item.account_id})</option>`)
        .join("");
      const options = state.investmentAccounts.length > 0
        ? `<option value="__portfolio__">全部投资账户（组合）</option>${accountOptions}`
        : "";

      ["retAccountId"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const prev = el.value;
        el.innerHTML = options || `<option value="">暂无投资账户</option>`;
        if (prev && Array.from(el.options).some(opt => opt.value === prev)) {
          el.value = prev;
        }
      });

      if (typeof state.refreshReturnAnalytics === "function") {
        await state.refreshReturnAnalytics({ silent: true });
      }
      if (typeof state.refreshReturnBatchAnalytics === "function") {
        await state.refreshReturnBatchAnalytics({ silent: true });
      }
      if (typeof state.refreshWealthAnalytics === "function") {
        await state.refreshWealthAnalytics({ silent: true });
      }
    }

    async function initImportActions() {
      const emlFiles = document.getElementById("emlFiles");
      const emlThreshold = document.getElementById("emlThreshold");
      const emlStatus = document.getElementById("emlStatus");
      const emlMetrics = document.getElementById("emlMetrics");
      const emlErrorsWrap = document.getElementById("emlErrorsWrap");
      const emlErrorsBody = document.getElementById("emlErrorsBody");

      document.getElementById("emlPreviewBtn").addEventListener("click", async () => {
        try {
          const files = await collectFiles(emlFiles);
          if (files.length === 0) throw new Error("请至少选择一个 .eml 文件");
          const data = await api("/api/eml/preview", "POST", {
            files,
            review_threshold: Number(emlThreshold.value || 0.7),
          });
          state.emlPreviewToken = data.preview_token;
          setStatus(emlStatus, true, "EML 预览完成，可确认导入。");
          showMetrics(emlMetrics, [
            { k: "文件数", v: data.summary.input_files_count },
            { k: "交易数", v: data.summary.records_count },
            { k: "消费笔数", v: data.summary.consume_count },
            { k: "待确认", v: data.summary.needs_review_count },
          ]);
          const errors = data.summary.failed_files || [];
          if (errors.length > 0) {
            emlErrorsWrap.classList.remove("hidden");
            emlErrorsBody.innerHTML = errors.map(e => `<tr><td>${e.file}</td><td>${e.error}</td></tr>`).join("");
          } else {
            hide(emlErrorsWrap);
          }
        } catch (err) {
          setStatus(emlStatus, false, err.message || String(err));
          hide(emlMetrics);
        }
      });

      document.getElementById("emlImportBtn").addEventListener("click", async () => {
        try {
          if (!state.emlPreviewToken) throw new Error("请先做 EML 预览。");
          const data = await api("/api/eml/import", "POST", {
            preview_token: state.emlPreviewToken,
            review_threshold: Number(emlThreshold.value || 0.7),
          });
          setStatus(
            emlStatus,
            true,
            `EML 导入成功：交易 ${data.imported_count} 条，失败 ${data.import_error_count} 条，任务ID ${data.import_job_id}`
          );
        } catch (err) {
          setStatus(emlStatus, false, err.message || String(err));
        }
      });

      const yzxyCsvFile = document.getElementById("yzxyCsvFile");
      const yzxyStatus = document.getElementById("yzxyStatus");
      const yzxyMetrics = document.getElementById("yzxyMetrics");
      const yzxyErrorsWrap = document.getElementById("yzxyErrorsWrap");
      const yzxyErrorsBody = document.getElementById("yzxyErrorsBody");

      document.getElementById("yzxyPreviewBtn").addEventListener("click", async () => {
        try {
          const files = await collectFiles(yzxyCsvFile);
          if (files.length !== 1) throw new Error("请只选择一个 CSV 或 XLSX 文件");
          const data = await api("/api/yzxy/preview", "POST", { file: files[0] });
          state.yzxyPreviewToken = data.preview_token;
          setStatus(yzxyStatus, true, "文件预览完成，可确认导入。");
          showMetrics(yzxyMetrics, [
            { k: "解析成功", v: data.preview.parsed_count },
            { k: "错误数", v: data.preview.error_count },
            { k: "映射列数", v: Object.keys(data.preview.mapping || {}).length },
            { k: "预览行", v: (data.preview.preview_rows || []).length },
          ]);
          const errors = data.preview.errors || [];
          if (errors.length > 0) {
            yzxyErrorsWrap.classList.remove("hidden");
            yzxyErrorsBody.innerHTML = errors.map(e => `<tr><td>${e}</td></tr>`).join("");
          } else {
            hide(yzxyErrorsWrap);
          }
        } catch (err) {
          setStatus(yzxyStatus, false, err.message || String(err));
          hide(yzxyMetrics);
        }
      });

      document.getElementById("yzxyImportBtn").addEventListener("click", async () => {
        try {
          if (!state.yzxyPreviewToken) throw new Error("请先做文件预览。");
          const data = await api("/api/yzxy/import", "POST", { preview_token: state.yzxyPreviewToken });
          setStatus(
            yzxyStatus,
            true,
            `导入成功：记录 ${data.imported_count} 条，失败 ${data.error_count} 条，任务ID ${data.import_job_id}`
          );
          await refreshInvestmentAccounts();
        } catch (err) {
          setStatus(yzxyStatus, false, err.message || String(err));
        }
      });
    }

    function initRecordActions() {
      const invStatus = document.getElementById("invStatus");
      document.getElementById("invSaveBtn").addEventListener("click", async () => {
        try {
          const payload = {
            account_name: document.getElementById("invAccountName").value.trim(),
            snapshot_date: document.getElementById("invSnapshotDate").value.trim(),
            total_assets: document.getElementById("invTotalAssets").value.trim(),
            transfer_amount: document.getElementById("invTransferAmount").value.trim(),
          };
          const data = await api("/api/investments/manual", "POST", payload);
          setStatus(invStatus, true, `投资记录已保存：${data.account_name} ${data.snapshot_date}`);
          await refreshInvestmentAccounts();
        } catch (err) {
          setStatus(invStatus, false, err.message || String(err));
        }
      });

      const assetStatus = document.getElementById("assetStatus");
      const assetClassEl = document.getElementById("assetClass");
      const assetNameEl = document.getElementById("assetAccountName");
      assetClassEl.addEventListener("change", () => {
        if (!assetNameEl.value.trim()) {
          assetNameEl.value = assetClassEl.value === "cash" ? "家庭现金账户" : "家庭不动产账户";
        }
      });

      document.getElementById("assetSaveBtn").addEventListener("click", async () => {
        try {
          const payload = {
            asset_class: document.getElementById("assetClass").value,
            account_name: document.getElementById("assetAccountName").value.trim(),
            snapshot_date: document.getElementById("assetSnapshotDate").value.trim(),
            value: document.getElementById("assetValue").value.trim(),
          };
          const data = await api("/api/assets/manual", "POST", payload);
          setStatus(assetStatus, true, `资产记录已保存：${data.account_name} ${data.snapshot_date}`);
          if (typeof state.refreshWealthAnalytics === "function") {
            await state.refreshWealthAnalytics({ silent: true });
          }
        } catch (err) {
          setStatus(assetStatus, false, err.message || String(err));
        }
      });
    }

    function buildPresetParams(prefix) {
      return {
        preset: document.getElementById(`${prefix}Preset`).value,
        from: document.getElementById(`${prefix}From`).value.trim(),
        to: document.getElementById(`${prefix}To`).value.trim(),
      };
    }

    function readWealthFilters() {
      const buttons = Array.from(document.querySelectorAll("#wealthAssetFilters .pill-tab"));
      const filters = {
        include_investment: true,
        include_cash: true,
        include_real_estate: true,
      };
      buttons.forEach(btn => {
        const key = btn.getAttribute("data-key");
        if (!key || !(key in filters)) return;
        filters[key] = btn.classList.contains("active");
      });
      return filters;
    }

    function toQueryBool(raw) {
      return raw ? "true" : "false";
    }

    function initReturnAnalytics() {
      const retStatus = document.getElementById("retStatus");
      const retMetrics = document.getElementById("retMetrics");
      const retFlowWrap = document.getElementById("retFlowWrap");
      const retFlowBody = document.getElementById("retFlowBody");
      const retBatchMetrics = document.getElementById("retBatchMetrics");
      const retBatchWrap = document.getElementById("retBatchWrap");
      const retBatchBody = document.getElementById("retBatchBody");
      const retAccountId = document.getElementById("retAccountId");
      const retPreset = document.getElementById("retPreset");
      const retFrom = document.getElementById("retFrom");
      const retTo = document.getElementById("retTo");
      const retChartAssetView = document.getElementById("retChartAssetView");
      const retChartReturnView = document.getElementById("retChartReturnView");
      const retChartGrowthView = document.getElementById("retChartGrowthView");
      const retTabButtons = Array.from(document.querySelectorAll("#retChartTabs .pill-tab"));

      let latestRequestId = 0;
      let latestBatchRequestId = 0;

      function setReturnChartView(view) {
        const views = {
          asset: retChartAssetView,
          return: retChartReturnView,
          growth: retChartGrowthView,
        };
        Object.entries(views).forEach(([key, el]) => {
          if (!el) return;
          el.classList.toggle("hidden", key !== view);
        });
        retTabButtons.forEach(btn => {
          btn.classList.toggle("active", btn.getAttribute("data-view") === view);
        });
      }

      function applyReturnPresetState() {
        const isCustom = retPreset.value === "custom";
        retFrom.disabled = !isCustom;
        if (!isCustom) retFrom.value = "";
      }

      function clearReturnVisuals() {
        hide(retMetrics);
        hide(retFlowWrap);
        renderLineChart("retCurveChart", "retCurveLegend", [], [
          { key: "total_assets_cents", color: "#0f766e", label: "总资产" },
        ]);
        renderLineChart("retRateChart", "retRateLegend", [], [
          { key: "cumulative_return_pct", color: "#b45309", label: "累计收益率(%)" },
        ]);
        renderLineChart("retGrowthChart", "retGrowthLegend", [], [
          { key: "cumulative_net_growth_cents", color: "#2f6db4", label: "净增长资金" },
        ]);
      }

      function clearReturnBatchVisuals() {
        hide(retBatchMetrics);
        hide(retBatchWrap);
        retBatchBody.innerHTML = "";
      }

      async function refreshReturnAnalytics(options = {}) {
        const { silent = false } = options;
        const requestId = ++latestRequestId;
        try {
          const accountId = retAccountId.value;
          if (!accountId) {
            clearReturnVisuals();
            if (!silent) setStatus(retStatus, false, "请先选择投资账户");
            return;
          }
          if (retPreset.value === "custom" && !retFrom.value.trim()) {
            clearReturnVisuals();
            if (!silent) setStatus(retStatus, false, "自定义区间需要填写开始日期");
            return;
          }

          const params = new URLSearchParams({ account_id: accountId, ...buildPresetParams("ret") });
          const [retData, curveData] = await Promise.all([
            api(`/api/analytics/investment-return?${params.toString()}`),
            api(`/api/analytics/investment-curve?${params.toString()}`),
          ]);
          if (requestId !== latestRequestId) return;

          const targetLabel = retData.account_count ? `组合（${retData.account_count}个账户）` : (retData.account_name || "-");
          showMetrics(retMetrics, [
            { k: "分析对象", v: targetLabel },
            { k: "区间收益率", v: retData.metrics.return_rate_pct || "-" },
            { k: "年化收益率", v: retData.metrics.annualized_rate_pct || "-" },
            { k: "净增长资金(元)", v: retData.metrics.net_growth_yuan || retData.metrics.profit_yuan },
            { k: "终点净增长(元)", v: curveData.summary.end_net_growth_yuan || "-" },
            { k: "终点累计收益率", v: curveData.summary.end_cumulative_return_pct_text || "-" },
          ]);

          const flows = retData.cash_flows || [];
          if (flows.length > 0) {
            retFlowWrap.classList.remove("hidden");
            retFlowBody.innerHTML = flows.map(flow => `
              <tr>
                <td>${flow.snapshot_date}</td>
                <td>${flow.transfer_amount_yuan}</td>
                <td>${flow.weight.toFixed(4)}</td>
              </tr>
            `).join("");
          } else {
            hide(retFlowWrap);
          }

          renderLineChart("retCurveChart", "retCurveLegend", curveData.rows || [], [
            {
              key: "total_assets_cents",
              color: "#0f766e",
              label: "总资产",
              formatValue: (val) => `${money(val)} 元`,
            },
          ], {
            includeZero: false,
            yTickCount: 4,
            yAxisFormatter: (val) => `${formatYuanShortFromCents(val)}元`,
            tooltipTitle: (row) =>
              row.effective_snapshot_date && row.effective_snapshot_date !== row.snapshot_date
                ? `${row.snapshot_date}（按${row.effective_snapshot_date}快照）`
                : (row.snapshot_date || ""),
          });
          renderLineChart("retRateChart", "retRateLegend", curveData.rows || [], [
            {
              key: "cumulative_return_pct",
              color: "#b45309",
              label: "累计收益率(%)",
              formatValue: (val) => `${Number(val).toFixed(2)}%`,
            },
          ], {
            includeZero: true,
            yTickCount: 4,
            yAxisFormatter: (val) => `${Number(val).toFixed(1)}%`,
            referenceLines: buildReturnReferenceLines(curveData.rows || []),
            tooltipTitle: (row) =>
              row.effective_snapshot_date && row.effective_snapshot_date !== row.snapshot_date
                ? `${row.snapshot_date}（按${row.effective_snapshot_date}快照）`
                : (row.snapshot_date || ""),
          });
          renderLineChart("retGrowthChart", "retGrowthLegend", curveData.rows || [], [
            {
              key: "cumulative_net_growth_cents",
              color: "#2f6db4",
              label: "净增长资金",
              formatValue: (val) => `${money(val)} 元`,
            },
          ], {
            includeZero: true,
            yTickCount: 4,
            yAxisFormatter: (val) => `${formatYuanShortFromCents(val)}元`,
            referenceLines: [{ value: 0, label: "0元", color: "#9ca3af" }],
            tooltipTitle: (row) =>
              row.effective_snapshot_date && row.effective_snapshot_date !== row.snapshot_date
                ? `${row.snapshot_date}（按${row.effective_snapshot_date}快照）`
                : (row.snapshot_date || ""),
          });

          if (!silent) {
            setStatus(
              retStatus,
              true,
              `已自动更新：${targetLabel}，区间 ${retData.range.effective_from} ~ ${retData.range.effective_to}`
            );
          }
        } catch (err) {
          if (requestId !== latestRequestId) return;
          clearReturnVisuals();
          setStatus(retStatus, false, err.message || String(err));
        }
      }

      async function refreshReturnBatchAnalytics(options = {}) {
        const { silent = false } = options;
        const requestId = ++latestBatchRequestId;
        try {
          if (retPreset.value === "custom" && !retFrom.value.trim()) {
            clearReturnBatchVisuals();
            if (!silent) setStatus(retStatus, false, "自定义区间需要填写开始日期");
            return;
          }

          const params = new URLSearchParams(buildPresetParams("ret"));
          const data = await api(`/api/analytics/investment-returns?${params.toString()}`);
          if (requestId !== latestBatchRequestId) return;

          showMetrics(retBatchMetrics, [
            { k: "参与账户", v: data.summary.account_count },
            { k: "可计算账户", v: data.summary.computed_count },
            { k: "异常账户", v: data.summary.error_count },
            { k: "平均收益率", v: data.summary.avg_return_pct || "-" },
          ]);

          retBatchWrap.classList.remove("hidden");
          const rows = data.rows || [];
          if (rows.length === 0) {
            retBatchBody.innerHTML = `<tr><td colspan="7">当前区间暂无可计算账户</td></tr>`;
          } else {
            retBatchBody.innerHTML = rows.map(row => `
              <tr>
                <td>${row.account_name || row.account_id}</td>
                <td>${row.return_rate_pct || "-"}</td>
                <td>${row.annualized_rate_pct || "-"}</td>
                <td>${row.profit_yuan}</td>
                <td>${row.net_flow_yuan}</td>
                <td>${row.effective_from} ~ ${row.effective_to}</td>
                <td>${row.interval_days}</td>
              </tr>
            `).join("");
          }

          if (!silent) {
            if (data.summary.error_count > 0) {
              setStatus(
                retStatus,
                false,
                `对比已更新：可计算 ${data.summary.computed_count} 个，异常 ${data.summary.error_count} 个`
              );
            } else {
              setStatus(retStatus, true, `账户收益率对比已更新：${data.summary.computed_count} 个账户`);
            }
          }
        } catch (err) {
          if (requestId !== latestBatchRequestId) return;
          clearReturnBatchVisuals();
          setStatus(retStatus, false, err.message || String(err));
        }
      }

      async function refreshAllReturnAnalytics(options = {}) {
        const { silent = false } = options;
        await Promise.all([
          refreshReturnAnalytics({ silent }),
          refreshReturnBatchAnalytics({ silent: true }),
        ]);
      }

      state.refreshReturnAnalytics = refreshReturnAnalytics;
      state.refreshReturnBatchAnalytics = refreshReturnBatchAnalytics;

      retTabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          setReturnChartView(btn.getAttribute("data-view") || "asset");
        });
      });
      setReturnChartView("asset");

      retAccountId.addEventListener("change", () => {
        refreshReturnAnalytics({ silent: false });
      });
      retPreset.addEventListener("change", () => {
        applyReturnPresetState();
        refreshAllReturnAnalytics({ silent: false });
      });
      retFrom.addEventListener("change", () => {
        refreshAllReturnAnalytics({ silent: false });
      });
      retTo.addEventListener("change", () => {
        refreshAllReturnAnalytics({ silent: false });
      });
      document.getElementById("retBatchBtn").addEventListener("click", async () => {
        await refreshReturnBatchAnalytics({ silent: false });
      });

      document.getElementById("retRefreshAccountsBtn").addEventListener("click", async () => {
        try {
          await refreshInvestmentAccounts();
          setStatus(retStatus, true, "投资账户列表已刷新并自动更新收益分析与账户对比");
        } catch (err) {
          setStatus(retStatus, false, err.message || String(err));
        }
      });

      applyReturnPresetState();
      refreshReturnBatchAnalytics({ silent: true });
    }

    function initWealth() {
      const wealthStatus = document.getElementById("wealthStatus");
      const wealthMetrics = document.getElementById("wealthMetrics");
      const wealthRowsWrap = document.getElementById("wealthRowsWrap");
      const wealthRowsBody = document.getElementById("wealthRowsBody");
      const wealthCurveMetrics = document.getElementById("wealthCurveMetrics");
      const wealthAsOf = document.getElementById("wealthAsOf");
      const wealthPreset = document.getElementById("wealthPreset");
      const wealthFrom = document.getElementById("wealthFrom");
      const wealthTo = document.getElementById("wealthTo");
      const wealthFilterButtons = Array.from(document.querySelectorAll("#wealthAssetFilters .pill-tab"));
      const wealthChartAssetView = document.getElementById("wealthChartAssetView");
      const wealthChartGrowthView = document.getElementById("wealthChartGrowthView");
      const wealthChartTabButtons = Array.from(document.querySelectorAll("#wealthChartTabs .pill-tab"));

      let latestOverviewRequestId = 0;
      let latestCurveRequestId = 0;

      function setFilterButtonState(btn, enabled) {
        btn.classList.toggle("active", enabled);
        btn.setAttribute("aria-pressed", enabled ? "true" : "false");
      }

      function hasAnyFilterEnabled(filters) {
        return filters.include_investment || filters.include_cash || filters.include_real_estate;
      }

      function serializeFilterParams(filters) {
        return {
          include_investment: toQueryBool(filters.include_investment),
          include_cash: toQueryBool(filters.include_cash),
          include_real_estate: toQueryBool(filters.include_real_estate),
        };
      }

      function clearWealthOverviewVisuals() {
        hide(wealthMetrics);
        hide(wealthRowsWrap);
        wealthRowsBody.innerHTML = "";
      }

      function clearWealthCurveVisuals() {
        hide(wealthCurveMetrics);
        renderLineChart("wealthCurveChart", "wealthCurveLegend", [], [
          { key: "wealth_total_cents", color: "#0f766e", label: "总财富" },
        ]);
        renderLineChart("wealthGrowthChart", "wealthGrowthLegend", [], [
          { key: "wealth_net_growth_cents", color: "#0f766e", label: "总财富净增长" },
        ]);
      }

      function setWealthChartView(view) {
        wealthChartAssetView.classList.toggle("hidden", view !== "asset");
        wealthChartGrowthView.classList.toggle("hidden", view !== "growth");
        wealthChartTabButtons.forEach(btn => {
          btn.classList.toggle("active", btn.getAttribute("data-view") === view);
        });
      }

      async function refreshWealthOverview(options = {}) {
        const { silent = false } = options;
        const requestId = ++latestOverviewRequestId;
        try {
          const filters = readWealthFilters();
          if (!hasAnyFilterEnabled(filters)) {
            clearWealthOverviewVisuals();
            if (!silent) setStatus(wealthStatus, false, "至少需要选择一个资产类型");
            return;
          }

          const params = new URLSearchParams({
            as_of: wealthAsOf.value.trim(),
            ...serializeFilterParams(filters),
          });
          const data = await api(`/api/analytics/wealth-overview?${params.toString()}`);
          if (requestId !== latestOverviewRequestId) return;

          showMetrics(wealthMetrics, [
            { k: "总财富(元)", v: data.summary.wealth_total_yuan },
            { k: "投资(元)", v: filters.include_investment ? data.summary.investment_total_yuan : "-" },
            { k: "现金(元)", v: filters.include_cash ? data.summary.cash_total_yuan : "-" },
            { k: "不动产(元)", v: filters.include_real_estate ? data.summary.real_estate_total_yuan : "-" },
          ]);

          wealthRowsWrap.classList.remove("hidden");
          wealthRowsBody.innerHTML = (data.rows || []).map(row => `
            <tr>
              <td>${row.asset_class}</td>
              <td>${row.account_name || row.account_id}</td>
              <td>${row.snapshot_date}</td>
              <td>${row.value_yuan}</td>
            </tr>
          `).join("");

          if (!silent) {
            setStatus(wealthStatus, true, `财富总览已更新（as_of: ${data.as_of}）`);
          }
        } catch (err) {
          if (requestId !== latestOverviewRequestId) return;
          clearWealthOverviewVisuals();
          setStatus(wealthStatus, false, err.message || String(err));
        }
      }

      async function refreshWealthCurve(options = {}) {
        const { silent = false } = options;
        const requestId = ++latestCurveRequestId;
        try {
          if (wealthPreset.value === "custom" && !wealthFrom.value.trim()) {
            clearWealthCurveVisuals();
            if (!silent) setStatus(wealthStatus, false, "自定义区间需要填写开始日期");
            return;
          }

          const filters = readWealthFilters();
          if (!hasAnyFilterEnabled(filters)) {
            clearWealthCurveVisuals();
            if (!silent) setStatus(wealthStatus, false, "至少需要选择一个资产类型");
            return;
          }

          const params = new URLSearchParams({
            ...buildPresetParams("wealth"),
            ...serializeFilterParams(filters),
          });
          const data = await api(`/api/analytics/wealth-curve?${params.toString()}`);
          if (requestId !== latestCurveRequestId) return;

          showMetrics(wealthCurveMetrics, [
            { k: "点位数", v: data.range.points },
            { k: "起点总财富(元)", v: data.summary.start_wealth_yuan },
            { k: "终点总财富(元)", v: data.summary.end_wealth_yuan },
            { k: "净增长资金(元)", v: data.summary.net_growth_yuan || data.summary.change_yuan },
            { k: "区间涨跌", v: data.summary.change_pct_text || "-" },
          ]);

          const seriesDefs = [
            { key: "wealth_total_cents", color: "#0f766e", label: "总财富", formatValue: (val) => `${money(val)} 元` },
          ];
          if (filters.include_investment) {
            seriesDefs.push({
              key: "investment_total_cents",
              color: "#e28b00",
              label: "投资",
              formatValue: (val) => `${money(val)} 元`,
            });
          }
          if (filters.include_cash) {
            seriesDefs.push({
              key: "cash_total_cents",
              color: "#2f6db4",
              label: "现金",
              formatValue: (val) => `${money(val)} 元`,
            });
          }
          if (filters.include_real_estate) {
            seriesDefs.push({
              key: "real_estate_total_cents",
              color: "#7d5a97",
              label: "不动产",
              formatValue: (val) => `${money(val)} 元`,
            });
          }

          renderLineChart("wealthCurveChart", "wealthCurveLegend", data.rows || [], seriesDefs, {
            includeZero: true,
            yTickCount: 4,
            yAxisFormatter: (val) => `${formatYuanShortFromCents(val)}元`,
            tooltipTitle: (row) => row.snapshot_date || "",
          });

          const growthSeriesDefs = [
            {
              key: "wealth_net_growth_cents",
              color: "#0f766e",
              label: "总财富净增长",
              formatValue: (val) => `${money(val)} 元`,
            },
          ];
          if (filters.include_investment) {
            growthSeriesDefs.push({
              key: "investment_net_growth_cents",
              color: "#e28b00",
              label: "投资净增长",
              formatValue: (val) => `${money(val)} 元`,
            });
          }
          if (filters.include_cash) {
            growthSeriesDefs.push({
              key: "cash_net_growth_cents",
              color: "#2f6db4",
              label: "现金净增长",
              formatValue: (val) => `${money(val)} 元`,
            });
          }
          if (filters.include_real_estate) {
            growthSeriesDefs.push({
              key: "real_estate_net_growth_cents",
              color: "#7d5a97",
              label: "不动产净增长",
              formatValue: (val) => `${money(val)} 元`,
            });
          }

          renderLineChart("wealthGrowthChart", "wealthGrowthLegend", data.rows || [], growthSeriesDefs, {
            includeZero: true,
            yTickCount: 4,
            yAxisFormatter: (val) => `${formatYuanShortFromCents(val)}元`,
            referenceLines: [{ value: 0, label: "0元", color: "#9ca3af" }],
            tooltipTitle: (row) => row.snapshot_date || "",
          });

          if (!silent) {
            setStatus(
              wealthStatus,
              true,
              `财富曲线已更新：区间 ${data.range.effective_from} ~ ${data.range.effective_to}`
            );
          }
        } catch (err) {
          if (requestId !== latestCurveRequestId) return;
          clearWealthCurveVisuals();
          setStatus(wealthStatus, false, err.message || String(err));
        }
      }

      async function refreshWealthAnalytics(options = {}) {
        const { silent = true } = options;
        await Promise.all([
          refreshWealthOverview({ silent }),
          refreshWealthCurve({ silent }),
        ]);
      }

      state.refreshWealthAnalytics = refreshWealthAnalytics;

      wealthFilterButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const isEnabled = btn.classList.contains("active");
          const activeCount = wealthFilterButtons.filter(item => item.classList.contains("active")).length;
          if (isEnabled && activeCount <= 1) {
            setStatus(wealthStatus, false, "至少需要选择一个资产类型");
            return;
          }
          setFilterButtonState(btn, !isEnabled);
          refreshWealthAnalytics({ silent: true });
        });
      });

      wealthAsOf.addEventListener("change", () => {
        refreshWealthOverview({ silent: true });
      });
      wealthChartTabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          setWealthChartView(btn.getAttribute("data-view") || "asset");
        });
      });
      wealthPreset.addEventListener("change", () => {
        refreshWealthCurve({ silent: true });
      });
      wealthFrom.addEventListener("change", () => {
        refreshWealthCurve({ silent: true });
      });
      wealthTo.addEventListener("change", () => {
        refreshWealthCurve({ silent: true });
      });

      document.getElementById("wealthOverviewBtn").addEventListener("click", async () => {
        await refreshWealthOverview({ silent: false });
      });

      document.getElementById("wealthCurveBtn").addEventListener("click", async () => {
        await refreshWealthCurve({ silent: false });
      });

      setWealthChartView("asset");
      refreshWealthAnalytics({ silent: true });
    }

    function initQuery() {
      const qTxMetrics = document.getElementById("qTxMetrics");
      const qTxWrap = document.getElementById("qTxWrap");
      const qTxBody = document.getElementById("qTxBody");
      document.getElementById("qTxBtn").addEventListener("click", async () => {
        const params = new URLSearchParams({
          month_key: document.getElementById("qMonthKey").value.trim(),
          source_type: document.getElementById("qTxSourceType").value.trim(),
          account_id: document.getElementById("qTxAccountId").value.trim(),
          keyword: document.getElementById("qTxKeyword").value.trim(),
          limit: document.getElementById("qTxLimit").value.trim() || "100",
        });
        const data = await api(`/api/query/transactions?${params.toString()}`);
        showMetrics(qTxMetrics, [
          { k: "总笔数", v: data.summary.count },
          { k: "总金额(元)", v: data.summary.total_amount_yuan },
          { k: "返回条数", v: data.rows.length },
          { k: "来源", v: data.summary.source_type || "-" },
        ]);
        qTxWrap.classList.remove("hidden");
        qTxBody.innerHTML = data.rows.map(row => `
          <tr>
            <td>${row.posted_at || row.occurred_at || ""}</td>
            <td>${row.merchant_normalized || ""}</td>
            <td>${row.description || ""}</td>
            <td>${money(row.amount_cents)}</td>
            <td>${row.expense_category || row.statement_category || ""}</td>
            <td>${row.source_type || ""}</td>
          </tr>
        `).join("");
      });

      const qInvMetrics = document.getElementById("qInvMetrics");
      const qInvWrap = document.getElementById("qInvWrap");
      const qInvBody = document.getElementById("qInvBody");
      document.getElementById("qInvBtn").addEventListener("click", async () => {
        const params = new URLSearchParams({
          from: document.getElementById("qInvFrom").value.trim(),
          to: document.getElementById("qInvTo").value.trim(),
          source_type: document.getElementById("qInvSourceType").value.trim(),
          account_id: document.getElementById("qInvAccountId").value.trim(),
          limit: document.getElementById("qInvLimit").value.trim() || "100",
        });
        const data = await api(`/api/query/investments?${params.toString()}`);
        showMetrics(qInvMetrics, [
          { k: "记录数", v: data.summary.count },
          { k: "最新总资产(元)", v: data.summary.latest_total_assets_yuan },
          { k: "区间转入转出(元)", v: data.summary.net_transfer_amount_yuan },
          { k: "来源", v: data.summary.source_type || "-" },
        ]);
        qInvWrap.classList.remove("hidden");
        qInvBody.innerHTML = data.rows.map(row => `
          <tr>
            <td>${row.snapshot_date || ""}</td>
            <td>${row.account_name || row.account_id || ""}</td>
            <td>${money(row.total_assets_cents)}</td>
            <td>${money(row.transfer_amount_cents || 0)}</td>
            <td>${row.source_type || ""}</td>
          </tr>
        `).join("");
      });

      const qAssetMetrics = document.getElementById("qAssetMetrics");
      const qAssetWrap = document.getElementById("qAssetWrap");
      const qAssetBody = document.getElementById("qAssetBody");
      document.getElementById("qAssetBtn").addEventListener("click", async () => {
        const params = new URLSearchParams({
          from: document.getElementById("qAssetFrom").value.trim(),
          to: document.getElementById("qAssetTo").value.trim(),
          asset_class: document.getElementById("qAssetClass").value,
          account_id: document.getElementById("qAssetAccountId").value.trim(),
          limit: document.getElementById("qAssetLimit").value.trim() || "100",
        });
        const data = await api(`/api/query/assets?${params.toString()}`);
        showMetrics(qAssetMetrics, [
          { k: "记录数", v: data.summary.count },
          { k: "金额合计(元)", v: data.summary.sum_value_yuan },
          { k: "资产类型", v: data.summary.asset_class || "全部" },
          { k: "返回条数", v: data.rows.length },
        ]);
        qAssetWrap.classList.remove("hidden");
        qAssetBody.innerHTML = (data.rows || []).map(row => `
          <tr>
            <td>${row.snapshot_date}</td>
            <td>${row.asset_class}</td>
            <td>${row.account_name || row.account_id}</td>
            <td>${money(row.value_cents)}</td>
            <td>${row.source_type || ""}</td>
          </tr>
        `).join("");
      });
    }

    function initAdmin() {
      const adminStatus = document.getElementById("adminStatus");
      const adminMetrics = document.getElementById("adminMetrics");
      const adminRowsWrap = document.getElementById("adminRowsWrap");
      const adminRowsBody = document.getElementById("adminRowsBody");
      const adminConfirmPhrase = document.getElementById("adminConfirmPhrase");
      const adminConfirmText = document.getElementById("adminConfirmText");

      function renderAdminRows(beforeRows, afterRows) {
        const afterMap = new Map((afterRows || []).map(item => [item.table, Number(item.row_count || 0)]));
        const base = beforeRows || [];
        adminRowsWrap.classList.remove("hidden");
        adminRowsBody.innerHTML = base.map(item => {
          const before = Number(item.row_count || 0);
          const after = Number(afterMap.has(item.table) ? afterMap.get(item.table) : 0);
          return `
            <tr>
              <td>${item.table}</td>
              <td>${before}</td>
              <td>${after}</td>
              <td>${before - after}</td>
            </tr>
          `;
        }).join("");
      }

      async function loadAdminStats(options = {}) {
        const { silent = false } = options;
        const data = await api("/api/admin/db-stats");
        adminConfirmPhrase.textContent = data.confirm_phrase || "-";
        showMetrics(adminMetrics, [
          { k: "数据表数量", v: data.summary.table_count },
          { k: "当前总行数", v: data.summary.total_rows },
          { k: "确认口令", v: data.confirm_phrase || "-" },
          { k: "数据库", v: "keepwise.db" },
        ]);
        renderAdminRows(data.rows || [], data.rows || []);
        if (!silent) {
          setStatus(adminStatus, true, `数据库统计已更新，当前共 ${data.summary.total_rows} 行`);
        }
      }

      document.getElementById("adminLoadStatsBtn").addEventListener("click", async () => {
        try {
          await loadAdminStats({ silent: false });
        } catch (err) {
          setStatus(adminStatus, false, err.message || String(err));
        }
      });

      document.getElementById("adminResetDbBtn").addEventListener("click", async () => {
        try {
          const payload = await api("/api/admin/reset-db", "POST", {
            confirm_text: adminConfirmText.value.trim(),
            clear_import_sessions: true,
          });
          showMetrics(adminMetrics, [
            { k: "数据表数量", v: payload.summary.table_count },
            { k: "清理前总行数", v: payload.summary.total_rows_before },
            { k: "清理后总行数", v: payload.summary.total_rows_after },
            { k: "已删除行数", v: payload.summary.deleted_rows },
          ]);
          renderAdminRows(payload.before_rows || [], payload.after_rows || []);
          setStatus(
            adminStatus,
            true,
            `数据库已清空，可重新导入验证（清理会话目录 ${payload.cleared_preview_sessions || 0} 个）`
          );
          adminConfirmText.value = "";
          await refreshInvestmentAccounts();
        } catch (err) {
          setStatus(adminStatus, false, err.message || String(err));
        }
      });

      loadAdminStats({ silent: true }).catch(() => {
        adminConfirmPhrase.textContent = "RESET KEEPWISE";
      });
    }

    async function init() {
      initTabs();

      setTodayIfEmpty("invSnapshotDate");
      setTodayIfEmpty("assetSnapshotDate");
      setTodayIfEmpty("wealthAsOf");

      syncCustomDateState("wealthPreset", "wealthFrom");

      await initImportActions();
      initRecordActions();
      initReturnAnalytics();
      initWealth();
      initQuery();
      initAdmin();
      await refreshInvestmentAccounts();
    }

    init();
  </script>
</body>
</html>
