<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KeepWise 交易规则管理</title>
  <link rel="stylesheet" href="/assets/rules_admin.css">
</head>
<body>
  <div class="container">
    <header class="hero">
      <h1>交易规则管理</h1>
      <p>集中维护消费分类规则：商户映射、关键词规则，以及基于现有交易的规则建议。</p>
      <div class="hero-actions">
        <a class="btn ghost" href="/" rel="noopener">返回主工作台</a>
        <button id="refreshAllBtn" class="btn primary">刷新全部数据</button>
        <label class="privacy-toggle" for="privacyToggle">
          <input id="privacyToggle" type="checkbox">
          隐私截图模式（隐藏金额）
        </label>
      </div>
    </header>

    <div id="globalStatus" class="status hidden"></div>
    <div id="globalMetrics" class="grid-metrics hidden"></div>

    <div class="pill-tabs" id="ruleTabs">
      <button class="pill-tab active" data-view="suggestions">商户建议</button>
      <button class="pill-tab" data-view="merchant_map">商户映射</button>
      <button class="pill-tab" data-view="keyword_rules">关键词规则</button>
      <button class="pill-tab" data-view="bank_transfer_whitelist">转账白名单</button>
    </div>

    <main class="layout">
      <section class="panel">
        <div id="viewSuggestions" class="view-panel">
          <div class="filters">
            <div>
              <label>关键字</label>
              <input id="sugKeyword" type="text" placeholder="按商户筛选">
            </div>
            <div>
              <label>返回条数</label>
              <input id="sugLimit" type="number" value="200" min="1" max="500">
            </div>
            <div class="checkbox-wrap">
              <input id="sugOnlyUnmapped" type="checkbox" checked>
              <label for="sugOnlyUnmapped">仅未映射商户</label>
            </div>
            <div class="filter-actions">
              <button id="sugLoadBtn" class="btn secondary">刷新建议</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>商户</th><th>交易数</th><th>金额(元)</th><th>待确认</th><th>推荐分类</th><th>已映射</th><th>操作</th></tr>
              </thead>
              <tbody id="sugBody"></tbody>
            </table>
          </div>
        </div>

        <div id="viewMerchantMap" class="view-panel hidden">
          <div class="filters">
            <div>
              <label>关键字</label>
              <input id="mapKeyword" type="text" placeholder="商户 / 分类 / 备注">
            </div>
            <div>
              <label>返回条数</label>
              <input id="mapLimit" type="number" value="200" min="1" max="500">
            </div>
            <div class="filter-actions">
              <button id="mapLoadBtn" class="btn secondary">刷新规则</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>商户</th><th>分类</th><th>置信度</th><th>备注</th><th>操作</th></tr>
              </thead>
              <tbody id="mapBody"></tbody>
            </table>
          </div>
        </div>

        <div id="viewKeywordRules" class="view-panel hidden">
          <div class="filters">
            <div>
              <label>关键字</label>
              <input id="kwKeyword" type="text" placeholder="模式 / 分类 / 备注">
            </div>
            <div>
              <label>返回条数</label>
              <input id="kwLimit" type="number" value="200" min="1" max="500">
            </div>
            <div class="filter-actions">
              <button id="kwLoadBtn" class="btn secondary">刷新规则</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>优先级</th><th>匹配</th><th>模式</th><th>分类</th><th>置信度</th><th>备注</th><th>操作</th></tr>
              </thead>
              <tbody id="kwBody"></tbody>
            </table>
          </div>
        </div>

        <div id="viewBankTransferWhitelist" class="view-panel hidden">
          <div class="filters">
            <div>
              <label>关键字</label>
              <input id="bwKeyword" type="text" placeholder="姓名 / 备注">
            </div>
            <div>
              <label>返回条数</label>
              <input id="bwLimit" type="number" value="200" min="1" max="500">
            </div>
            <div class="checkbox-wrap">
              <input id="bwActiveOnly" type="checkbox">
              <label for="bwActiveOnly">仅启用项</label>
            </div>
            <div class="filter-actions">
              <button id="bwLoadBtn" class="btn secondary">刷新白名单</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>姓名</th><th>启用</th><th>备注</th><th>操作</th></tr>
              </thead>
              <tbody id="bwBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <aside class="panel form-panel">
        <div id="merchantFormCard">
          <h3>商户映射编辑</h3>
          <div class="form-grid">
            <div><label>商户名</label><input id="mMerchant" type="text" placeholder="支付宝-XX"></div>
            <div><label>消费分类</label><input id="mCategory" type="text" placeholder="餐饮"></div>
            <div><label>置信度(0~1)</label><input id="mConfidence" type="number" step="0.01" value="0.95"></div>
            <div class="full"><label>备注</label><input id="mNote" type="text" placeholder="manual"></div>
          </div>
          <div class="actions">
            <button id="mSaveBtn" class="btn primary">保存商户规则</button>
            <button id="mResetBtn" class="btn ghost">清空表单</button>
          </div>
          <p class="hint">建议页可“一键填入”，再微调后保存。</p>
        </div>

        <div id="keywordFormCard" class="hidden">
          <h3>关键词规则编辑</h3>
          <div class="form-grid">
            <div><label>优先级</label><input id="kPriority" type="number" value="500"></div>
            <div>
              <label>匹配类型</label>
              <select id="kMatchType">
                <option value="contains" selected>contains</option>
                <option value="prefix">prefix</option>
                <option value="exact">exact</option>
                <option value="regex">regex</option>
              </select>
            </div>
            <div><label>关键词/模式</label><input id="kPattern" type="text" placeholder="滴滴"></div>
            <div><label>消费分类</label><input id="kCategory" type="text" placeholder="交通出行"></div>
            <div><label>置信度(0~1)</label><input id="kConfidence" type="number" step="0.01" value="0.70"></div>
            <div><label>备注</label><input id="kNote" type="text" placeholder="manual"></div>
          </div>
          <div class="actions">
            <button id="kSaveBtn" class="btn primary">保存关键词规则</button>
            <button id="kResetBtn" class="btn ghost">清空表单</button>
          </div>
        </div>

        <div id="whitelistFormCard" class="hidden">
          <h3>银行卡个人转账白名单编辑</h3>
          <div class="form-grid">
            <div><label>姓名</label><input id="bwName" type="text" placeholder="徐凯"></div>
            <div class="checkbox-wrap" style="align-self:end; margin-bottom:6px;">
              <input id="bwIsActive" type="checkbox" checked>
              <label for="bwIsActive">启用</label>
            </div>
            <div class="full"><label>备注</label><input id="bwNote" type="text" placeholder="银行卡个人转账计入消费白名单"></div>
          </div>
          <div class="actions">
            <button id="bwSaveBtn" class="btn primary">保存白名单</button>
            <button id="bwResetBtn" class="btn ghost">清空表单</button>
          </div>
          <p class="hint">仅影响招商银行流水 PDF 导入中的“银行卡个人转账”计入消费判断。</p>
        </div>
      </aside>
    </main>
  </div>

  <script src="/assets/rules_admin_shared.js"></script>
  <script src="/assets/rules_admin_render.js"></script>
  <script src="/assets/rules_admin_data.js"></script>
  <script src="/assets/rules_admin_events_bootstrap.js"></script>
</body>
</html>
