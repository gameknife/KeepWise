# KeepWise Tauri 全平台技术栈迁移总计划（Draft v1）

更新时间：2026-02-23
状态：讨论稿（用于后续评审与迭代）

## 1. 背景与目标

当前项目已完成核心功能搭建，并经过一次较全面的结构重构，已经具备继续产品化推进的基础。下一阶段目标是将现有方案从：

- 后端：Python（本地 Web 服务）
- 前端：原生 HTML/CSS/JS（多页面工作台）
- 运行方式：浏览器访问本地服务脚本

迁移为：

- 桌面/移动统一应用壳：Tauri（建议 Tauri v2）
- 核心业务能力：Rust（本地领域服务 + 数据访问 + 计算）
- 前端界面：现代前端工程化（建议 TypeScript + 组件化）
- 发布形态：可打包安装的独立 App（Win / macOS / Linux / iOS / Android）

本计划目标不是“一次性重写”，而是制定一套可执行、可回归、自动化驱动的迁移路线，最终实现技术栈切换。

## 2. 迁移目标（成功定义）

### 2.1 产品目标

迁移后应用需继续支持并保持口径一致（至少）：

- EML 账单导入（招行信用卡）
- 有知有行投资记录导入/管理
- 投资收益率分析（Modified Dietz / 组合口径）
- 财富总览与财富曲线
- 规则管理（商户映射 / 分类规则 / 排除规则）
- 基础查询与记录纠错（增删改）

### 2.2 技术目标

- 单一代码仓内支持桌面与移动端构建
- 核心业务逻辑从 Python 迁移到 Rust（逐步替换）
- SQLite 账本与迁移机制在新栈中稳定运行
- 前端完成组件化重构并适配 Tauri 宿主
- 保留并增强现有回归校验能力，建立跨语言差分测试

### 2.3 自动化目标（重要）

目标是“自动化驱动的技术栈切换”，而不是“零人工判断”：

- 能自动化的尽量自动化：契约生成、代码骨架、回归比对、构建打包、发布流水线、回滚检查
- 必须人工审核的保留关口：财务口径一致性、交互体验、移动端权限策略、证书签名与商店发布配置

说明：完全 100% 无人工审核的迁移在本项目场景下不现实，也不安全（尤其涉及财务计算与导入口径）。

## 3. 当前基线（迁移输入）

基于当前仓库状态（已重构）：

- 核心 Python 入口：`scripts/keepwise_web_app.py`
- 已拆分的领域服务：
  - `scripts/investment_analytics_service.py`
  - `scripts/wealth_analytics_service.py`
  - `scripts/budget_fire_analytics_service.py`
  - `scripts/rules_service.py`
- 路由注册表：`scripts/http_route_tables.py`
- 数据迁移：`db/migrations/*.sql`
- 关键回归脚本：
  - `scripts/validate_m1_analytics.py`
  - `scripts/check_runtime_db_health.py`
- 前端静态资源（已做一定模块化）：
  - `scripts/assets/workbench*.js/html/css`
  - `scripts/assets/rules_admin*.js/html/css`
  - `scripts/assets/consumption_dashboard*.js/html`

这是很好的迁移起点：领域边界已经开始清晰化，可以作为 Rust 重写的分层蓝图。

## 4. 总体迁移策略（推荐）

采用“三段式迁移”，避免大爆炸重写：

1. **兼容阶段（Hybrid）**
   - 先搭建 Tauri App 外壳与前端工程化体系
   - 初期允许部分能力通过 Python 服务/脚本桥接（优先桌面）
   - 尽快验证宿主能力、目录权限、打包链路、升级机制

2. **替换阶段（Rust Core）**
   - 按领域逐步将 Python 逻辑迁移到 Rust
   - 用差分测试确保口径一致
   - 逐步收缩 Python 依赖直至可移除

3. **收口阶段（All-platform Release）**
   - 完成移动端适配与平台权限治理
   - 完成签名/打包/发布自动化
   - 形成可持续维护的 Tauri + Rust + TS 工程结构

## 5. 目标架构（建议版）

## 5.1 架构分层

- **UI 层（Frontend / Tauri WebView）**
  - TypeScript + 组件化前端（建议 React + Vite，备选 Solid/Vue）
  - 负责页面渲染、交互状态、图表展示、表单校验
- **应用接口层（Tauri Commands）**
  - Rust `#[tauri::command]` 暴露能力给前端
  - 做参数校验、错误映射、权限检查、调用领域服务
- **领域服务层（Rust Domain Services）**
  - 投资收益、财富聚合、规则管理、导入协调等
  - 尽量保持纯函数 + 明确输入输出
- **基础设施层（Infra）**
  - SQLite 访问
  - 文件系统（应用目录 / 导入文件）
  - 日志、配置、迁移、序列化
  - 导入解析（EML/PDF/CSV/XLSX）

## 5.2 推荐技术栈（初稿）

- **Tauri**：v2（桌面 + iOS/Android 能力）
- **Rust**：
  - 序列化：`serde`
  - 时间处理：`chrono`（或 `time`，二选一保持一致）
  - 数据库：`rusqlite`（优先简单稳定）或 `sqlx(sqlite)`（如需更强工程化）
  - 错误处理：`thiserror` + `anyhow`
  - 测试：单元测试 + 集成测试 + 差分测试
- **Frontend**：
  - `Vite + TypeScript`
  - 框架建议：`React`
  - 图表可延续现有思路（如 `ECharts`），但需统一组件包装
- **Schema / Contract**：
  - 前后端统一 DTO 定义（Rust struct + TS types 自动生成或双向校验）

说明：前端框架可在 Phase 0 做小型 PoC 后最终确认；本计划先以 React 作为默认推荐，便于生态与招聘维护。

## 6. 迁移范围与非目标

### 6.1 本次迁移范围（In Scope）

- 现有核心功能完整迁移到 Tauri App
- 本地数据库与迁移机制迁移
- 前端页面与交互重构（组件化、工程化、适配移动端）
- 桌面/移动端构建与打包流水线
- 自动化回归与差分验证系统

### 6.2 非目标（暂不做）

- 云同步/账号体系（除非后续单独立项）
- 在线多端实时同步冲突解决
- 大规模插件系统
- AI 自动建议能力（可先保留接口设计，不纳入本次切换主路径）

## 7. 关键约束与风险前提

## 7.1 平台约束

- iOS/Android 对文件访问、后台执行、沙盒目录权限有严格限制
- 桌面端可用的“脚本桥接”方案不适合移动端长期使用
- 移动端最终必须以 Rust 原生能力为主（尤其导入与计算链路）

## 7.2 业务约束

- 财务计算口径必须稳定，收益率与财富聚合不能因语言切换漂移
- 导入解析结果必须可追溯（保留来源文件与导入任务信息）
- 数据库升级需保证幂等与可回滚策略

## 7.3 工程约束

- 当前仓库存在大量已可用功能，不能因重写造成长期功能冻结
- 迁移期间应维持“旧系统可运行、新系统可验证”的双轨模式

## 8. 分阶段实施计划（主线）

以下为建议主线，默认按“单仓渐进迁移”执行。

## Phase 0：迁移立项与技术验证（1-2 周）

目标：

- 建立 Tauri 最小可运行工程（桌面优先）
- 验证 Rust 命令调用前端的基本链路
- 验证 SQLite 文件目录与日志目录策略
- 验证移动端构建可行性（至少能启动空壳）

产出：

- `tauri/` 或新前端工程目录初版（具体结构评审后定）
- Tauri “Hello + DB ping + 本地目录读取” PoC
- 技术选型结论（React/Solid/Vue 二选一，DB 库选型）
- 平台能力清单（文件选择器、导入路径、权限差异）

通过标准：

- macOS/Windows/Linux 至少 2 平台可本地运行 PoC
- iOS/Android 至少完成一次启动验证（模拟器/真机任一）

## Phase 1：契约冻结与回归基线强化（1-2 周）

目标：

- 固化现有 API/DTO/错误码语义（作为迁移对照）
- 建立黄金样本数据集（golden dataset）
- 将现有 Python 回归脚本升级为“迁移差分基线”

关键任务：

- 梳理核心接口返回结构（投资收益、财富总览、财富曲线、规则管理、导入预览）
- 输出接口契约文档（JSON 样例 + 字段语义 + 口径说明）
- 建立固定样本输入集：
  - EML 样本（脱敏）
  - 有知有行 CSV/XLSX 样本（脱敏）
  - SQLite 样本库（最小/典型/异常）
- 增加差分测试脚本：同一输入对比 Python 与 Rust 输出

产出：

- `docs/engineering/` 下的接口契约与口径文档（建议新增）
- `tests/golden/`（建议目录）样本数据集
- 差分测试驱动器（可先由 Python/CLI 编排）

通过标准：

- 核心指标（收益率/曲线终点/财富汇总）误差阈值定义完成并自动化执行

## Phase 2：Tauri 外壳与前端工程化落地（2-4 周）

目标：

- 将当前多页面原生前端迁移到前端工程化项目
- 保持现有功能可访问（先桌面端）
- 建立 UI 组件、路由、状态管理、API 调用层基础设施

关键任务：

- 重建页面信息架构（工作台 / 规则管理 / 消费分析 / 导入中心）
- 抽取设计令牌（颜色、字体、间距、图表主题）
- 建立 API SDK 层（前端只调用统一接口，不直接散落调用 command）
- 首批页面迁移（优先：财富总览、收益分析、记录录入）
- 响应式适配基线（桌面 + 手机纵向）

迁移策略：

- 先“功能等价”再“视觉升级”
- 先迁核心高频页面，再迁低频管理页

通过标准：

- 核心页面在 Tauri 桌面壳内可操作
- UI 与旧版关键流程对齐（导入/查询/收益/财富）

## Phase 3：Rust 数据层与迁移框架（2-3 周）

目标：

- 在 Rust 中完成 SQLite 访问层、迁移执行器、仓储层基础设施
- 建立与现有 `db/migrations/*.sql` 的兼容执行机制

关键任务：

- 设计 DB 模块结构（连接管理、事务封装、查询模型）
- 迁移 SQL 执行器（按版本顺序、幂等检查、错误回滚策略）
- 应用目录与数据库路径策略（桌面/移动统一抽象）
- 加入数据库健康检查命令（对齐 `check_runtime_db_health.py`）

通过标准：

- 新 App 可初始化空库并运行全部迁移
- 可读取现有数据库并完成基础查询

## Phase 4：Rust 核心分析能力迁移（3-6 周）

目标：

- 迁移最关键、最有价值的口径计算到 Rust（优先收益率与财富）

迁移优先级（建议）：

1. 投资收益率（Modified Dietz）
2. 投资曲线
3. 财富总览
4. 财富曲线
5. 规则管理服务
6. 预算/消费/FIRE 聚合（如仍在当前范围）

关键任务：

- 按 Python 服务模块建立 Rust 对应服务
- 建立跨语言差分测试（同样本，同口径）
- 为每个服务定义明确 DTO/错误模型

通过标准：

- `validate_m1_analytics.py` 覆盖的关键场景在 Rust 实现上通过差分校验
- 前端已切换调用 Rust 命令，不再依赖 Python 对应分析接口

## Phase 5：导入链路迁移（EML / CSV / XLSX / PDF）（4-8 周）

目标：

- 将导入相关能力从 Python 迁移到 Rust，满足移动端可用性要求

说明：

- 这是高风险阶段，尤其是 PDF 解析（银行账单格式稳定性/文本抽取差异）
- 建议拆为“先 CSV/XLSX/规则处理，再 EML，再 PDF”

关键任务：

- 有知有行 CSV/XLSX 导入迁移（优先）
- EML 解析与提取迁移
- 规则匹配与建议生成迁移
- 招行 PDF 导入迁移（最后攻坚）
- 导入预览与确认流程在 Tauri 前端中闭环

过渡方案（可选，仅桌面）：

- 在 Rust 未完成前，通过 sidecar/subprocess 调用 Python 导入脚本
- 但必须标记为临时方案，移动端版本不可依赖此路径

通过标准：

- 核心导入链路在 Rust 内闭环
- 差分测试对比 Python 结果通过（允许格式字段顺序不同，不允许金额/日期/分类口径漂移）

## Phase 6：前端重构与跨端体验收口（3-6 周）

目标：

- 完成主要页面组件化重构与移动端适配
- 完成交互一致性、错误态、空态、加载态设计

关键任务：

- 页面级重构完成（工作台核心模块、规则管理、消费分析）
- 图表在小屏布局适配（滚动、缩放、图例显示策略）
- 输入表单与键盘弹出处理（移动端）
- 本地文件导入 UX（桌面/移动差异化）

通过标准：

- 桌面与移动端核心流程可用，交互无阻断
- 关键页面具备可接受的性能表现

## Phase 7：发布工程化与全平台打包（2-4 周）

目标：

- 建立桌面与移动端构建、签名、产物管理流程
- 形成可复用发布手册和自动化流水线

关键任务：

- CI/CD 矩阵构建（macOS / Windows / Linux）
- iOS/Android 构建脚本与签名占位配置
- 版本号策略（App 版本 / DB schema 版本 / 数据兼容策略）
- 发布前检查（迁移、回归、健康检查、打包 smoke test）

通过标准：

- 至少一次完整的全平台候选版本（RC）构建成功
- 产物可安装并完成基本冒烟测试

## Phase 8：切换与退役（1-2 周）

目标：

- 完成默认入口切换到 Tauri App
- 明确 Python 旧运行链路退役策略（保留维护窗口）

关键任务：

- 制定 cutover 清单（数据兼容、用户升级路径、回滚方案）
- 保留旧链路只读/维护模式（时间窗口）
- 补齐迁移文档与开发者指南

通过标准：

- 新栈作为主入口稳定运行
- 旧栈退役计划明确且可执行

## 9. 自动化迁移工程（核心设计）

本章节用于支撑“自动化驱动切换”目标。

## 9.1 自动化对象清单

可自动化（优先实现）：

- API/Command 契约样例收集与校验
- Rust/TS DTO 模板生成（或 schema 校验代码生成）
- Python vs Rust 差分回归执行
- 数据库迁移执行与健康检查
- 前端 lint/test/build
- Tauri 多平台构建与产物归档
- 发布前 smoke test 清单执行

半自动化（需要人工确认）：

- UI 重构后视觉一致性验收
- 导入异常样本归类与规则修正
- 平台权限提示文案与交互优化
- 商店发布信息与签名配置

不建议自动化替代人工判断：

- 财务口径最终签字（收益率/财富汇总结果确认）
- 业务字段语义调整（字段改名/合并/弃用）

## 9.2 自动化流水线（建议）

### Pipeline A：本地开发回归

触发：

- 每次提交或指定目录变更（Rust domain / import / frontend）

步骤：

1. 运行 Rust 单元测试
2. 运行 Rust 集成测试
3. 运行 Python 基线回归（现有脚本）
4. 运行跨语言差分测试（若对应模块已迁移）
5. 运行前端测试与构建检查

### Pipeline B：平台构建验证（CI）

触发：

- PR / 合并到主分支

步骤：

1. 桌面端 Tauri 构建（macOS/Windows/Linux）
2. 运行自动化 smoke tests
3. 上传构建产物
4. 生成构建报告（成功/失败模块）

### Pipeline C：发布候选（RC）

触发：

- 手动触发或打标签

步骤：

1. 全量回归 + 差分
2. 全平台构建
3. 版本信息注入
4. 产物签名（人工关口）
5. 发布候选归档与发布说明草稿生成

## 9.3 自动化迁移脚本建议（仓库内新增）

建议新增目录（示意）：

- `tools/migration/`
  - `capture_api_contracts.py`（从旧系统采集样例输出）
  - `run_diff_regression.py`（Python vs Rust 差分）
  - `golden_dataset_manager.py`（样本集校验/脱敏）
  - `generate_tauri_migration_report.py`（阶段进度与通过率报告）

说明：

- 初期可用 Python 编排这些脚本（复用现有环境）
- 后续逐步迁移为 Rust/Node 工具均可，不必一开始重写工具链

## 10. 模块迁移映射（建议版本）

本表用于控制“先迁什么、后迁什么”，并减少遗漏。

| 当前模块 | 新栈目标模块（示意） | 优先级 | 说明 |
| --- | --- | --- | --- |
| `scripts/keepwise_web_app.py` | `src-tauri/src/commands/*` + `src-tauri/src/app/*` | 高 | 拆分路由职责为 commands，避免单文件重演 |
| `scripts/investment_analytics_service.py` | `src-tauri/src/domain/investment/*` | 最高 | 核心口径，优先迁移并做差分 |
| `scripts/wealth_analytics_service.py` | `src-tauri/src/domain/wealth/*` | 最高 | 与收益一起构成核心价值 |
| `scripts/rules_service.py` | `src-tauri/src/domain/rules/*` | 高 | 规则管理与导入分类依赖 |
| `scripts/budget_fire_analytics_service.py` | `src-tauri/src/domain/budget_fire/*` | 中 | 若当前 M1+ 主线不继续扩展，可稍后迁移 |
| `scripts/import_youzhiyouxing_investments.py` | `src-tauri/src/importers/youzhiyouxing/*` | 高 | CSV/XLSX 导入相对更易先落地 |
| `scripts/parse_cmb_statements.py` | `src-tauri/src/importers/cmb_eml/*` | 高 | EML 账单导入重要 |
| `scripts/import_cmb_bank_pdf_transactions.py` | `src-tauri/src/importers/cmb_pdf/*` | 高风险 | 放在后期攻坚 |
| `db/migrations/*.sql` | `src-tauri` 迁移执行器复用现有 SQL | 最高 | 优先保持 SQL 文件资产不重写 |
| `scripts/assets/*` | `frontend/src/*` | 高 | 重构为组件与页面模块 |

## 11. 数据与兼容性策略

## 11.1 数据库兼容策略

- 保持 `db/migrations/*.sql` 作为 schema 单一事实来源（至少迁移前半程如此）
- 新栈优先复用现有 SQL 迁移文件，避免“同一 schema 两份定义”
- 增加数据库版本检查命令与升级前备份策略

## 11.2 应用数据目录策略（跨平台）

- 统一使用 Tauri 提供的应用数据目录（App Data）
- 旧目录结构概念保留，但路径由平台适配层映射：
  - 输入缓存目录
  - 规则目录
  - 数据库目录
  - 报告/导出目录
  - 日志目录

注意：

- 移动端不应依赖任意绝对路径写入
- 文件选择与导入需要走平台文件选择器/权限 API

## 11.3 导入文件与隐私策略

- 默认只保留导入所需最小信息
- 可配置是否保留源文件副本
- 日志脱敏（账户号、卡号后四位、商户敏感信息按规则处理）

## 12. 测试与验收计划

## 12.1 测试分层

- 单元测试：算法函数、规则匹配、DTO 校验
- 集成测试：DB + 服务层聚合
- 差分测试：Python vs Rust 输出对比
- E2E 测试：核心流程（导入、查询、收益、财富）
- 平台冒烟：安装、启动、数据迁移、基本操作

## 12.2 核心验收指标（建议）

- 收益率口径误差：`<= 1e-8`（或按字段定义更合理阈值）
- 财富总览聚合金额误差：0（分为单位时）
- 核心导入成功率：达到当前 Python 基线
- 关键流程崩溃率：0（回归样本集）
- 桌面端启动时间、核心页面首屏时间：建立基线并持续跟踪

## 12.3 切换前验收门槛（Go/No-Go）

必须全部满足：

- 核心分析链路已完全走 Rust
- 核心导入链路（至少用户当前高频使用路径）已完全走 Rust
- 差分测试连续多轮稳定通过
- 桌面端构建与安装验证稳定
- 移动端最小可用流程通过（导入/录入/查询/财富至少一条链路）

## 13. 风险清单与应对

## 13.1 高风险项

1. **招行 PDF 解析在 Rust 中复现困难**
   - 应对：延后到后期；先完成其他导入链路；保留桌面临时桥接方案

2. **财务口径迁移引入细微偏差**
   - 应对：差分测试 + 黄金样本 + 人工审核清单

3. **移动端文件权限与导入体验差异大**
   - 应对：Phase 0 提前验证；将文件导入适配列为独立工作流

4. **前端重构与后端迁移并行导致进度互相阻塞**
   - 应对：先冻结契约；前端通过 mock/contract 驱动开发；后端按命令逐步替换

5. **构建与签名流程复杂度超预期**
   - 应对：尽早建立 RC 流水线；将签名流程拆分为单独里程碑

## 13.2 范围失控风险

- 迁移期间新增功能需求容易打断节奏
- 建议设置“迁移窗口期”：核心新功能仅接受 bugfix / 合规 / 数据安全类变更

## 14. 团队协作与分工建议（可单人/多人适配）

推荐工作流（即使单人也建议按角色思维切分）：

- **架构/口径负责人**
  - 维护契约、口径文档、Go/No-Go 标准
- **Rust Core 负责人**
  - DB、分析、导入迁移
- **Frontend/Tauri 负责人**
  - UI 重构、交互、跨端适配
- **自动化与质量负责人**
  - 差分测试、CI/CD、发布流程

单人模式时，建议按 Phase 聚焦推进，避免“前后端同时大面积改动”。

## 15. 建议里程碑（版本化）

- **Migrate-P0**：Tauri PoC + 技术选型确认
- **Migrate-P1**：契约冻结 + 黄金样本 + 差分框架
- **Migrate-P2**：Tauri 前端工程化基线 + 桌面壳可用
- **Migrate-P3**：Rust DB 层 + 迁移执行器
- **Migrate-P4**：Rust 核心分析（收益/财富）切换完成
- **Migrate-P5**：Rust 导入链路（高频路径）切换完成
- **Migrate-P6**：跨端 UI 收口 + 移动端可用
- **Migrate-P7**：全平台 RC 构建成功
- **Migrate-P8**：正式切换与旧栈退役

## 16. 本计划的后续评审清单（下一轮讨论建议）

下一轮建议重点确认以下事项（会直接影响计划排期）：

1. 前端框架最终选择（React / Vue / Solid）
2. Rust DB 方案选择（`rusqlite` vs `sqlx`）
3. 是否接受桌面端阶段性 Python bridge（仅过渡）
4. 移动端首发范围（iOS + Android 同步，还是先 Android）
5. 首批必须迁移的功能清单（按用户使用频率排序）
6. 招行 PDF 导入是否作为首发硬性要求
7. 发布方式（仅侧载 / TestFlight / Android 内测 / 桌面安装包）

## 17. 立即可执行的下一步（建议）

为了让迁移任务尽快进入“可验证状态”，建议按以下顺序启动：

1. 新建 Tauri PoC 分支与工程骨架（Phase 0）
2. 输出接口契约与黄金样本清单（Phase 1）
3. 建立跨语言差分测试跑通一条链路（优先投资收益率）
4. 再开始前端框架重构与 Rust 核心迁移并行推进

---

注：本文件为迁移总计划（Master Plan）。后续建议按阶段拆出子计划文档（例如 `P1_契约冻结计划.md`、`P4_Rust分析迁移计划.md`），并给出具体任务清单与验收用例。
